<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการตารางเข้างาน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ใช้ Local Storage แทน Firebase เพื่อหลีกเลี่ยงปัญหา CSP
        const localDB = {
            employees: {},
            leaveQuota: {},
            workSchedule: {},
            leaveRequests: {}
        };

        // โหลดข้อมูลจาก localStorage
        function loadLocalData() {
            const saved = localStorage.getItem('workScheduleDB');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(localDB, data);
            }
        }

        // บันทึกข้อมูลลง localStorage
        function saveLocalData() {
            localStorage.setItem('workScheduleDB', JSON.stringify(localDB));
        }

        // Mock Firebase functions
        const ref = (db, path) => ({ path });
        const set = async (ref, data) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = data;
            saveLocalData();
        };
        const get = async (ref) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (const key of keys) {
                if (!current[key]) return { exists: () => false, val: () => null };
                current = current[key];
            }
            return { exists: () => true, val: () => current };
        };
        const update = async (ref, data) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            if (!current[keys[keys.length - 1]]) current[keys[keys.length - 1]] = {};
            Object.assign(current[keys[keys.length - 1]], data);
            saveLocalData();
        };
        const push = async (ref, data) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (const key of keys) {
                if (!current[key]) current[key] = {};
                current = current[key];
            }
            const id = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            current[id] = data;
            saveLocalData();
            return { key: id };
        };

        // โหลดข้อมูลเริ่มต้น
        loadLocalData();

        // ข้อมูลพนักงาน
        const employees = {
            'HR001': { name: 'HR', position: 'HR', role: 'HR', department: 'HR', workTime: '08:30-17:30', team: null, shift: null },
            'MA001': { name: 'อามินตรา นามภักดิ์ (น้องอาย)', position: 'Admin Manager', role: 'Manager', department: 'Admin', workTime: '08:30-17:30', team: 'Manager', shift: null },
            'MM001': { name: 'นพดล อินใจ (น้องกอล์ฟ)', position: 'Marketing Manager', role: 'Manager', department: 'Marketing', workTime: '10:30-19:30', team: null, shift: null },
            'EA001': { name: 'กุลธิตา ทองสิมา (น้องบิว)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA002': { name: 'วรรณริยา ใหม่เจริญ (น้องฝ้าย)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA003': { name: 'พวงผกา พุทธสาร (น้องเนย)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA004': { name: 'แสงดี นามแสง (น้องเหมย)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA005': { name: 'หล้า แก้วสาม (น้องหล้า)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EA006': { name: 'น.ส.พุทธิตา เมืองแสงสี (น้องบีเอ็ม)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EA007': { name: 'รัชนีกร คำเงิน (พี่แคท)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EA008': { name: 'นวพร อิงสมุทร (น้องนา)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EM001': { name: 'อานนท์ วัฒนะ (นนท์)', position: 'Editor', role: 'Employee', department: 'Marketing', workTime: '10:30-19:30', team: null, shift: null },
            'ET001': { name: 'ศรีเดือน อินเท่ง (น้องเดือน)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET002': { name: 'อารีดา คำลือ (น้องปิ่น)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET003': { name: 'แพรนวล อุ่นใจ (น้องแพร)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET004': { name: 'จันทร์จิรา งามสงวน (พี่อั้ม)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET005': { name: 'นางสาว อารียา อินทสุทธิ (น้องอัน)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null }
        };

        // ระบบจัดการกะ Admin
        const shiftSystem = {
            shifts: {
                morning: { name: 'กะเช้า', time: '06:00-15:00' },
                evening: { name: 'กะเย็น', time: '14:00-23:00' }
            },
            
            // สลับกะรายเดือน
            getShiftForMonth: function(team, year, month) {
                // เดือนคู่ = กะเช้า, เดือนคี่ = กะเย็น สำหรับ Team1
                // เดือนคู่ = กะเย็น, เดือนคี่ = กะเช้า สำหรับ Team2
                const isEvenMonth = (month + 1) % 2 === 0;
                
                if (team === 'Team1') {
                    return isEvenMonth ? 'morning' : 'evening';
                } else if (team === 'Team2') {
                    return isEvenMonth ? 'evening' : 'morning';
                } else {
                    return 'morning'; // Manager คงที่กะเช้า
                }
            },
            
            // อัปเดตกะพนักงาน
            updateEmployeeShift: function(empId, year, month) {
                const emp = employees[empId];
                if (emp && emp.department === 'Admin' && emp.team) {
                    const newShift = this.getShiftForMonth(emp.team, year, month);
                    const shiftInfo = this.shifts[newShift];
                    
                    emp.shift = newShift;
                    emp.workTime = shiftInfo.time;
                    
                    // อัปเดตตำแหน่งให้แสดงกะปัจจุบัน
                    if (emp.team === 'Team1') {
                        emp.position = `Admin Team 1 (${shiftInfo.name})`;
                    } else if (emp.team === 'Team2') {
                        emp.position = `Admin Team 2 (${shiftInfo.name})`;
                    }
                }
            }
        };

        // วันหยุดนักขัตฤกษ์
        const publicHolidays = {
            '2025-01-01': 'วันขึ้นปีใหม่',
            '2025-02-12': 'วันมาฆบูชา',
            '2025-04-13': 'วันสงกรานต์',
            '2025-04-14': 'วันสงกรานต์',
            '2025-04-15': 'วันสงกรานต์',
            '2025-05-01': 'วันแรงงาน',
            '2025-05-11': 'วันวิสาขบูชา',
            '2025-07-10': 'วันอาสาฬหบูชา',
            '2025-07-28': 'วันเกิด ร.10',
            '2025-08-12': 'วันแม่',
            '2025-10-13': 'วันคล้ายวันสวรรคต ร.9',
            '2025-12-05': 'วันพ่อ',
            '2024-12-31': 'วันสิ้นปี'
        };

        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // เริ่มต้นข้อมูลพนักงาน
        async function initializeEmployees() {
            console.log('Initializing employees...');
            
            // ตรวจสอบว่ามีข้อมูลอยู่แล้วหรือไม่
            if (Object.keys(localDB.employees).length === 0) {
                console.log('No existing employee data, creating initial data...');
                
                for (const [empId, empData] of Object.entries(employees)) {
                    await set(ref(null, `employees/${empId}`), empData);
                    
                    // เริ่มต้นโควต้าวันหยุด
                    const quota = {
                        regularLeave: 4,
                        specialLeave: empData.department === 'Telesale' ? 2 : 0,
                        sickLeave: 30,
                        vacationLeave: 6,
                        personalLeave: 6
                    };
                    await set(ref(null, `leaveQuota/${empId}`), quota);
                }
                console.log('Employee data initialized successfully');
            } else {
                console.log('Employee data already exists, skipping initialization');
            }
        }

        // สร้างตารางทำงานอัตโนมัติ
        async function generateWorkSchedule(year, month) {
            console.log(`Generating work schedule for ${year}-${month + 1}...`);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            try {
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    for (const empId of Object.keys(employees)) {
                        const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                        
                        try {
                            const snapshot = await get(scheduleRef);
                            
                            if (!snapshot.exists()) {
                                const isPublicHoliday = publicHolidays[date];
                                const scheduleData = {
                                    status: isPublicHoliday ? 'holiday_pending' : 'work',
                                    type: isPublicHoliday ? 'public_holiday' : 'regular',
                                    holidayName: isPublicHoliday || null,
                                    employeeId: empId,
                                    date: date
                                };
                                
                                await set(scheduleRef, scheduleData);
                            }
                        } catch (error) {
                            console.error(`Error creating schedule for ${empId} on ${date}:`, error);
                        }
                    }
                }
                console.log('Work schedule generated successfully');
            } catch (error) {
                console.error('Error generating work schedule:', error);
            }
        }

        // ล็อกอิน
        async function login() {
            const empId = document.getElementById('empId').value.trim().toUpperCase();
            
            console.log('Attempting login with ID:', empId);
            console.log('Available employees:', Object.keys(employees));
            
            if (!employees[empId]) {
                alert('รหัสพนักงานไม่ถูกต้อง\n\nรหัสที่ใช้ได้: ' + Object.keys(employees).join(', '));
                return;
            }
            
            try {
                currentUser = empId;
                console.log('Login successful for:', empId);
                
                // แสดงหน้าหลัก
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userName').textContent = employees[empId].name;
                
                // เริ่มต้นข้อมูลพื้นฐาน
                await initializeEmployees();
                console.log('Employees initialized');
                
                // อัปเดตกะสำหรับเดือนปัจจุบัน
                updateShiftsForMonth(currentYear, currentMonth);
                console.log('Shifts updated for current month');
                
                await generateWorkSchedule(currentYear, currentMonth);
                console.log('Work schedule generated');
                
                await loadCalendar();
                console.log('Calendar loaded');
                
                await loadLeaveQuota();
                console.log('Leave quota loaded');
                
                await loadLeaveRequests();
                console.log('Leave requests loaded');
                
                // ถ้าเป็น HR ให้แสดง Management Panel เต็ม หรือ Manager ให้แสดงเฉพาะปฏิทินรวม
                if (employees[empId].role === 'HR') {
                    console.log('User is HR, showing full management panel');
                    document.getElementById('hrPanel').classList.remove('hidden');
                    
                    // แสดงแท็บทั้งหมดสำหรับ HR
                    document.getElementById('approvalsTab').style.display = 'block';
                    document.getElementById('employeesTab').style.display = 'block';
                    document.getElementById('calendarTab').style.display = 'block';
                    
                    await loadHRPanel();
                    console.log('Management panel loaded');
                    
                    // แสดงสรุปรวม
                    await loadSummaryStats();
                    console.log('Summary stats loaded');
                    
                    // เริ่มต้นที่แท็บอนุมัติการลา
                    switchHRTab('approvals');
                } else if (employees[empId].role === 'Manager') {
                    console.log('User is Manager, showing limited management panel');
                    document.getElementById('hrPanel').classList.remove('hidden');
                    
                    // ซ่อนแท็บที่ Manager ไม่มีสิทธิ์
                    document.getElementById('approvalsTab').style.display = 'none';
                    document.getElementById('employeesTab').style.display = 'block'; // Manager สามารถเข้าถึงได้
                    document.getElementById('calendarTab').style.display = 'block';
                    
                    // เริ่มต้นที่แท็บจัดการพนักงาน
                    switchHRTab('employees');
                    await loadEmployeeManagement();
                    console.log('Manager employee management loaded');
                    
                    // แสดงสรุปรวม
                    await loadSummaryStats();
                    console.log('Manager summary stats loaded');
                }
                
                console.log('Login process completed successfully');
            } catch (error) {
                console.error('Login error:', error);
                alert('เกิดข้อผิดพลาดในการเข้าสู่ระบบ: ' + error.message);
                
                // กลับไปหน้าล็อกอิน
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('hrPanel').classList.add('hidden');
            }
        }

        // โหลดปฏิทิน
        async function loadCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            
            const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                              'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            
            monthYear.textContent = `${monthNames[currentMonth]} ${currentYear + 543}`;
            
            // ตรวจสอบสถานะการยืนยัน
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
            const confirmSnapshot = await get(confirmRef);
            const isConfirmed = confirmSnapshot.exists();
            
            // อัปเดตปุ่ม
            const confirmBtn = document.getElementById('confirmBtn');
            const editBtn = document.getElementById('editBtn');
            
            console.log('Updating buttons - confirmBtn:', confirmBtn, 'editBtn:', editBtn, 'isConfirmed:', isConfirmed);
            
            if (confirmBtn && editBtn) {
                if (isConfirmed) {
                    confirmBtn.style.display = 'none';
                    editBtn.style.display = 'inline-block';
                    editBtn.textContent = '🔓 ยกเลิกการยืนยัน';
                    editBtn.className = 'bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 font-semibold shadow-lg transition-all duration-200';
                    console.log('Buttons updated for confirmed state');
                } else {
                    confirmBtn.style.display = 'inline-block';
                    editBtn.style.display = 'none';
                    console.log('Buttons updated for unconfirmed state');
                }
            } else {
                console.error('Buttons not found in DOM');
            }
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let calendarHTML = `
                <div class="grid grid-cols-7 gap-1 mb-4">
                    <div class="text-center font-bold p-2 bg-gray-200">อา</div>
                    <div class="text-center font-bold p-2 bg-gray-200">จ</div>
                    <div class="text-center font-bold p-2 bg-gray-200">อ</div>
                    <div class="text-center font-bold p-2 bg-gray-200">พ</div>
                    <div class="text-center font-bold p-2 bg-gray-200">พฤ</div>
                    <div class="text-center font-bold p-2 bg-gray-200">ศ</div>
                    <div class="text-center font-bold p-2 bg-gray-200">ส</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;
            
            // เพิ่มช่องว่างสำหรับวันแรกของเดือน
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            // สร้างวันในเดือน
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                try {
                    const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                    const snapshot = await get(scheduleRef);
                    const schedule = snapshot.val() || { status: 'work', type: 'regular' };
                    
                    let bgColor = 'bg-white';
                    let textColor = 'text-gray-800';
                    let statusText = 'ทำงาน';
                    let clickable = !isConfirmed; // ถ้ายืนยันแล้วจะคลิกไม่ได้
                    
                    // ตรวจสอบวันหยุดนักขัตฤกษ์
                    const isPublicHoliday = publicHolidays[date];
                    if (isPublicHoliday) {
                        if (schedule.status === 'holiday_pending') {
                            bgColor = 'bg-yellow-100';
                            statusText = 'เลือกทำงาน/หยุด';
                        } else if (schedule.status === 'work') {
                            bgColor = 'bg-yellow-100';
                            statusText = 'ทำงาน (2เท่า)';
                        } else if (schedule.status === 'holiday') {
                            bgColor = 'bg-red-100';
                            statusText = 'วันหยุด';
                        }
                    } else {
                        // วันปกติ
                        if (schedule.status === 'holiday') {
                            bgColor = 'bg-red-200';
                            statusText = 'วันหยุด';
                            if (schedule.leaveType) {
                                const leaveTypeNames = {
                                    'regular': 'หยุดปกติ',
                                    'special': 'หยุดพิเศษ',
                                    'sick': 'ลาป่วย',
                                    'vacation': 'ลาพักร้อน',
                                    'personal': 'ลากิจ'
                                };
                                statusText = leaveTypeNames[schedule.leaveType] || 'วันหยุด';
                            }
                        } else if (schedule.status === 'leave') {
                            bgColor = 'bg-orange-200';
                            statusText = 'ลา';
                            if (schedule.leaveType) {
                                const leaveTypeNames = {
                                    'regular': 'หยุดปกติ',
                                    'special': 'หยุดพิเศษ',
                                    'sick': 'ลาป่วย',
                                    'vacation': 'ลาพักร้อน',
                                    'personal': 'ลากิจ'
                                };
                                statusText = leaveTypeNames[schedule.leaveType] || 'ลา';
                            }
                        } else {
                            bgColor = 'bg-green-100';
                            statusText = 'ทำงาน';
                        }
                    }
                    
                    // เพิ่มสีเทาถ้ายืนยันแล้ว
                    if (isConfirmed) {
                        bgColor += ' opacity-75';
                        textColor = 'text-gray-600';
                    }
                    
                    const cursorClass = clickable ? 'cursor-pointer hover:bg-opacity-80' : 'cursor-not-allowed';
                    const onClick = clickable ? `onclick="selectDate('${date}')"` : '';
                    
                    // เพิ่มไอคอนล็อคสำหรับการลาที่อนุมัติแล้ว
                    let lockIcon = '';
                    if (schedule.status === 'leave' && schedule.approvedBy) {
                        lockIcon = '<div class="text-xs text-green-600 mt-1">🔒 HR อนุมัติ</div>';
                    } else if (isConfirmed) {
                        lockIcon = '<div class="text-xs text-gray-500 mt-1">🔒 ยืนยันแล้ว</div>';
                    }
                    
                    calendarHTML += `
                        <div class="border p-2 min-h-[80px] ${bgColor} ${textColor} ${cursorClass} transition-colors" ${onClick}>
                            <div class="font-bold">${day}</div>
                            <div class="text-xs mt-1">${statusText}</div>
                            ${isPublicHoliday ? `<div class="text-xs text-blue-600 font-semibold">${isPublicHoliday}</div>` : ''}
                            ${lockIcon}
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading calendar day:', error);
                    const cursorClass = clickable ? 'cursor-pointer' : 'cursor-not-allowed';
                    const onClick = clickable ? `onclick="selectDate('${date}')"` : '';
                    
                    calendarHTML += `
                        <div class="border p-2 min-h-[80px] bg-gray-100 ${cursorClass}" ${onClick}>
                            <div class="font-bold">${day}</div>
                            <div class="text-xs mt-1">ทำงาน</div>
                            ${isConfirmed ? '<div class="text-xs text-gray-500 mt-1">🔒 ยืนยันแล้ว</div>' : ''}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `
                </div>
            `;
            calendar.innerHTML = calendarHTML;
        }



        // เลือกวัน - แสดง popup เสมอ
        window.selectDate = async function(date) {
            try {
                // ตรวจสอบว่าเดือนนี้ยืนยันแล้วหรือไม่
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
                const confirmSnapshot = await get(confirmRef);
                
                if (confirmSnapshot.exists()) {
                    alert('ตารางงานเดือนนี้ได้รับการยืนยันแล้ว\nไม่สามารถแก้ไขได้\n\nหากต้องการแก้ไข กรุณากดปุ่ม "ยกเลิกการยืนยัน" ก่อน');
                    return;
                }
                
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const schedule = snapshot.val();
                
                if (!schedule) {
                    console.error('No schedule found for date:', date);
                    return;
                }
                
                // ตรวจสอบว่าเป็นการลาที่ HR อนุมัติแล้วหรือไม่
                if (schedule.status === 'leave' && schedule.approvedBy) {
                    alert('การลานี้ได้รับการอนุมัติจาก HR แล้ว\nไม่สามารถแก้ไขได้\n\nหากต้องการเปลี่ยนแปลง กรุณาติดต่อ HR');
                    return;
                }
                
                const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // แสดงตัวเลือกทั้งหมด รวมถึงทำงาน
                showEditDayOptions(date, schedule, quota);
                
            } catch (error) {
                console.error('Error in selectDate:', error);
                alert('เกิดข้อผิดพลาดในการเลือกวัน');
            }
        }

        // ตรวจสอบความขัดแย้งในทีม
        async function checkTeamConflict(date, empId) {
            const currentEmp = employees[empId];
            let conflictMembers = [];
            let teamMembers = [];
            
            // หาสมาชิกในทีม/แผนกเดียวกัน
            for (const [otherId, otherEmp] of Object.entries(employees)) {
                if (otherId === empId) continue;
                
                // Admin Team 1 และ Team 2 ห้ามหยุดชนกัน
                if (currentEmp.department === 'Admin' && otherEmp.department === 'Admin') {
                    // ตรวจสอบว่าอยู่ทีมเดียวกันหรือไม่
                    const currentTeam = currentEmp.position.includes('Team 1') ? 'Team 1' : 
                                       currentEmp.position.includes('Team 2') ? 'Team 2' : 'Other';
                    const otherTeam = otherEmp.position.includes('Team 1') ? 'Team 1' : 
                                     otherEmp.position.includes('Team 2') ? 'Team 2' : 'Other';
                    
                    if (currentTeam === otherTeam && currentTeam !== 'Other') {
                        teamMembers.push({ id: otherId, name: otherEmp.name, position: otherEmp.position });
                    }
                }
                // แผนกอื่นๆ ห้ามหยุดชนกันในแผนก
                else if (currentEmp.department === otherEmp.department) {
                    teamMembers.push({ id: otherId, name: otherEmp.name, position: otherEmp.position });
                }
            }
            
            // ตรวจสอบว่ามีคนในทีม/แผนกหยุดในวันเดียวกันหรือไม่
            for (const member of teamMembers) {
                try {
                    const scheduleRef = ref(null, `workSchedule/${member.id}/${date}`);
                    const snapshot = await get(scheduleRef);
                    const schedule = snapshot.val();
                    
                    if (schedule && (schedule.status === 'holiday' || schedule.status === 'leave')) {
                        conflictMembers.push({
                            ...member,
                            status: schedule.status === 'holiday' ? 'หยุด' : 'ลา',
                            leaveType: schedule.leaveType || ''
                        });
                    }
                } catch (error) {
                    console.error('Error checking team member schedule:', error);
                }
            }
            
            return {
                hasConflict: conflictMembers.length > 0,
                conflictMembers: conflictMembers,
                teamSize: teamMembers.length + 1
            };
        }

        // แสดงตัวเลือกแก้ไขวัน
        async function showEditDayOptions(date, currentSchedule, quota) {
            // ตรวจสอบความขัดแย้งในทีม
            const conflictCheck = await checkTeamConflict(date, currentUser);
            const isPublicHoliday = publicHolidays[date];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">แก้ไขการเลือกวัน - ${date}</h3>
                    
                    ${isPublicHoliday ? `
                    <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-4">
                        <div class="font-semibold text-yellow-800">🎉 ${isPublicHoliday}</div>
                        <div class="text-sm text-yellow-700">วันหยุดนักขัตฤกษ์ - เลือกทำงาน (ค่าแรง 2 เท่า) หรือหยุด</div>
                    </div>
                    ` : ''}
                    
                    <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                        <div class="text-sm text-gray-700">
                            <strong>สถานะปัจจุบัน:</strong> 
                            ${currentSchedule.status === 'work' ? (isPublicHoliday ? 'ทำงาน (2เท่า)' : 'ทำงาน') : 
                              currentSchedule.status === 'holiday' ? 'หยุด' : 
                              currentSchedule.status === 'leave' ? 'ลา' : 
                              currentSchedule.status === 'holiday_pending' ? 'รอเลือก' : 'ไม่ทราบ'}
                            ${currentSchedule.leaveType ? ` (${currentSchedule.leaveType})` : ''}
                        </div>
                    </div>
                    
                    ${isPublicHoliday ? `
                    <!-- ตัวเลือกสำหรับวันหยุดนักขัตฤกษ์ -->
                    <div class="space-y-3">
                        <button onclick="changeDayStatus('${date}', 'work')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'work' ? 'bg-yellow-200 border-yellow-400' : 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200'}">
                            <div class="font-semibold">ทำงาน (ค่าแรง 2 เท่า) ${currentSchedule.status === 'work' ? '(ปัจจุบัน)' : ''}</div>
                            <div class="text-sm text-gray-600">เลือกทำงานในวันหยุดนักขัตฤกษ์</div>
                        </button>
                        
                        <button onclick="changeDayStatus('${date}', 'holiday')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'holiday' ? 'bg-red-200 border-red-400' : 'bg-red-50 hover:bg-red-100 border-red-200'}">
                            <div class="font-semibold">หยุด ${currentSchedule.status === 'holiday' ? '(ปัจจุบัน)' : ''}</div>
                            <div class="text-sm text-gray-600">หยุดในวันนักขัตฤกษ์</div>
                        </button>
                    </div>
                    ` : `
                    <!-- ตัวเลือกสำหรับวันปกติ - เฉพาะทำงานและหยุดปกติ -->
                    ${conflictCheck.hasConflict && (currentSchedule.status === 'work') ? `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                        <div class="font-semibold text-red-800">⚠️ ไม่สามารถเปลี่ยนเป็นหยุดได้</div>
                        <div class="text-sm text-red-700 mb-2">มีเพื่อนร่วมทีม/แผนกหยุดในวันนี้แล้ว:</div>
                        <div class="space-y-1">
                            ${conflictCheck.conflictMembers.map(member => `
                                <div class="text-xs bg-white p-2 rounded border border-red-200">
                                    <span class="font-semibold">${member.name}</span> (${member.position}) - ${member.status}${member.leaveType ? ` (${member.leaveType === 'regular' ? 'ปกติ' : member.leaveType === 'special' ? 'พิเศษ' : member.leaveType})` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="changeDayStatus('${date}', 'work')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'work' ? 'bg-green-200 border-green-400' : 'bg-green-50 hover:bg-green-100 border-green-200'}">
                            <div class="font-semibold">ทำงาน ${currentSchedule.status === 'work' ? '(ปัจจุบัน)' : ''}</div>
                            <div class="text-sm text-gray-600">เปลี่ยนเป็นวันทำงาน</div>
                        </button>
                    </div>
                    ` : `
                    <div class="space-y-3">
                        <button onclick="changeDayStatus('${date}', 'work')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'work' ? 'bg-green-200 border-green-400' : 'bg-green-50 hover:bg-green-100 border-green-200'}">
                            <div class="font-semibold">ทำงาน ${currentSchedule.status === 'work' ? '(ปัจจุบัน)' : ''}</div>
                            <div class="text-sm text-gray-600">เปลี่ยนเป็นวันทำงาน</div>
                        </button>
                        
                        <button onclick="selectHolidayType('${date}', 'regular')" 
                                class="w-full p-3 text-left rounded border ${quota.regularLeave > 0 || (currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'regular') ? 'bg-red-50 hover:bg-red-100 border-red-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.regularLeave <= 0 && !(currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'regular') ? 'disabled' : ''}>
                            <div class="font-semibold">วันหยุดปกติ ${currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'regular' ? '(ปัจจุบัน)' : ''}</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.regularLeave} วัน (ไม่ต้องส่งคำขอ)</div>
                        </button>
                        
                        ${quota.specialLeave > 0 || (currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'special') ? `
                        <button onclick="selectHolidayType('${date}', 'special')" 
                                class="w-full p-3 text-left rounded border bg-purple-50 hover:bg-purple-100 border-purple-200 ${currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'special' ? 'bg-purple-200 border-purple-400' : ''}">
                            <div class="font-semibold">วันหยุดพิเศษ (Telesale) ${currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'special' ? '(ปัจจุบัน)' : ''}</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.specialLeave} วัน (ไม่ต้องส่งคำขอ)</div>
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="text-sm text-blue-800">
                            <strong>หมายเหตุ:</strong> การลาป่วย ลาพักร้อน และลากิจ ต้องส่งคำขอลาผ่านฟอร์มด้านล่างเพื่อให้ HR อนุมัติก่อน
                        </div>
                    </div>
                    `}
                    `}
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="closeLeaveModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ยกเลิก</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // แสดงตัวเลือกการลา
        async function showLeaveOptions(date, quota) {
            // ตรวจสอบความขัดแย้งในทีม
            const conflictCheck = await checkTeamConflict(date, currentUser);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">เลือกประเภทการลา - ${date}</h3>
                    
                    ${conflictCheck.hasConflict ? `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                        <div class="font-semibold text-red-800">⚠️ ไม่สามารถลา/หยุดได้</div>
                        <div class="text-sm text-red-700 mb-2">มีเพื่อนร่วมทีม/แผนกหยุดในวันนี้แล้ว:</div>
                        <div class="space-y-1">
                            ${conflictCheck.conflictMembers.map(member => `
                                <div class="text-xs bg-white p-2 rounded border border-red-200">
                                    <span class="font-semibold">${member.name}</span> (${member.position}) - ${member.status}${member.leaveType ? ` (${member.leaveType === 'regular' ? 'ปกติ' : member.leaveType === 'special' ? 'พิเศษ' : member.leaveType})` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="closeLeaveModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ปิด</button>
                    </div>
                    ` : `
                    <div class="space-y-3">
                        <button onclick="takeLeave('${date}', 'regular')" 
                                class="w-full p-3 text-left rounded border ${quota.regularLeave > 0 ? 'bg-blue-50 hover:bg-blue-100 border-blue-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.regularLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">วันหยุดปกติ</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.regularLeave} วัน</div>
                        </button>
                        
                        ${quota.specialLeave > 0 ? `
                        <button onclick="takeLeave('${date}', 'special')" 
                                class="w-full p-3 text-left rounded border bg-purple-50 hover:bg-purple-100 border-purple-200">
                            <div class="font-semibold">วันหยุดพิเศษ (Telesale)</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.specialLeave} วัน</div>
                        </button>
                        ` : ''}
                        
                        <button onclick="takeLeave('${date}', 'sick')" 
                                class="w-full p-3 text-left rounded border ${quota.sickLeave > 0 ? 'bg-red-50 hover:bg-red-100 border-red-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.sickLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">ลาป่วย</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.sickLeave} วัน</div>
                        </button>
                        
                        <button onclick="takeLeave('${date}', 'vacation')" 
                                class="w-full p-3 text-left rounded border ${quota.vacationLeave > 0 ? 'bg-green-50 hover:bg-green-100 border-green-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.vacationLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">ลาพักร้อน</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.vacationLeave} วัน</div>
                        </button>
                        
                        <button onclick="takeLeave('${date}', 'personal')" 
                                class="w-full p-3 text-left rounded border ${quota.personalLeave > 0 ? 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.personalLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">ลากิจ</div>
                            <div class="text-sm text-gray-600">เหลือ ${quota.personalLeave} วัน</div>
                        </button>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="closeLeaveModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ยกเลิก</button>
                    </div>
                    `}
                </div>
            `;
            document.body.appendChild(modal);
        }



        // เปลี่ยนสถานะวัน
        window.changeDayStatus = async function(date, newStatus) {
            try {
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const currentSchedule = snapshot.val();
                
                if (!currentSchedule) {
                    alert('ไม่พบข้อมูลตารางงาน');
                    return;
                }
                
                const isPublicHoliday = publicHolidays[date];
                
                // ถ้าเปลี่ยนจากหยุด/ลากลับมาทำงาน ให้คืนโควต้า (เฉพาะวันปกติ)
                if ((currentSchedule.status === 'holiday' || currentSchedule.status === 'leave') && newStatus === 'work') {
                    if (currentSchedule.leaveType && !isPublicHoliday) {
                        const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                        const quotaSnapshot = await get(quotaRef);
                        const quota = quotaSnapshot.val();
                        
                        const newQuota = { ...quota };
                        switch(currentSchedule.leaveType) {
                            case 'regular': newQuota.regularLeave = quota.regularLeave + 1; break;
                            case 'special': newQuota.specialLeave = quota.specialLeave + 1; break;
                            case 'sick': newQuota.sickLeave = quota.sickLeave + 1; break;
                            case 'vacation': newQuota.vacationLeave = quota.vacationLeave + 1; break;
                            case 'personal': newQuota.personalLeave = quota.personalLeave + 1; break;
                        }
                        await update(quotaRef, newQuota);
                    }
                }
                
                // อัปเดตสถานะ
                const updateData = { 
                    status: newStatus,
                    type: isPublicHoliday ? 'public_holiday' : 'regular',
                    holidayName: isPublicHoliday || null
                };
                
                // สำหรับวันหยุดนักขัตฤกษ์ ไม่ต้องมี leaveType
                if (!isPublicHoliday) {
                    updateData.leaveType = newStatus === 'work' ? null : currentSchedule.leaveType;
                } else {
                    updateData.leaveType = null; // วันหยุดนักขัตฤกษ์ไม่มี leaveType
                }
                
                await update(scheduleRef, updateData);
                
                closeLeaveModal();
                await loadCalendar();
                if (!isPublicHoliday) {
                    await loadLeaveQuota();
                }
                
                const statusText = isPublicHoliday ? 
                    (newStatus === 'work' ? 'ทำงาน (ค่าแรง 2 เท่า)' : 'หยุดในวันนักขัตฤกษ์') :
                    (newStatus === 'work' ? 'ทำงาน' : 'หยุด');
                    
                alert(`เปลี่ยนเป็น${statusText}เรียบร้อยแล้ว`);
            } catch (error) {
                console.error('Error changing day status:', error);
                alert('เกิดข้อผิดพลาดในการเปลี่ยนสถานะ');
            }
        }

        // เลือกประเภทวันหยุด (ใหม่)
        window.selectHolidayType = async function(date, leaveType) {
            try {
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const currentSchedule = snapshot.val();
                
                // ถ้าเป็นการเลือกซ้ำ (เลือกประเภทเดิม) ไม่ต้องหักโควต้า
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType === leaveType) {
                    closeLeaveModal();
                    alert('คุณได้เลือกประเภทการหยุดนี้แล้ว');
                    return;
                }
                
                const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // ตรวจสอบโควต้า
                let quotaField = '';
                switch(leaveType) {
                    case 'regular': quotaField = 'regularLeave'; break;
                    case 'special': quotaField = 'specialLeave'; break;
                }
                
                // ถ้าเปลี่ยนจากประเภทหนึ่งไปอีกประเภท ให้คืนโควต้าเก่าก่อน
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType && currentSchedule.leaveType !== leaveType) {
                    const oldQuotaField = currentSchedule.leaveType === 'regular' ? 'regularLeave' :
                                         currentSchedule.leaveType === 'special' ? 'specialLeave' : '';
                    
                    if (oldQuotaField) {
                        const newQuota = { ...quota };
                        newQuota[oldQuotaField] = quota[oldQuotaField] + 1; // คืนโควต้าเก่า
                        await update(quotaRef, newQuota);
                        
                        // อัปเดตโควต้าใหม่
                        const updatedQuotaSnapshot = await get(quotaRef);
                        const updatedQuota = updatedQuotaSnapshot.val();
                        
                        if (updatedQuota[quotaField] <= 0) {
                            alert('วันหยุดประเภทนี้หมดแล้ว');
                            return;
                        }
                        
                        // หักโควต้าใหม่
                        const finalQuota = { ...updatedQuota };
                        finalQuota[quotaField] = updatedQuota[quotaField] - 1;
                        await update(quotaRef, finalQuota);
                    }
                } else {
                    // กรณีปกติ - เปลี่ยนจากทำงานเป็นหยุด
                    if (quota[quotaField] <= 0) {
                        alert('วันหยุดประเภทนี้หมดแล้ว');
                        return;
                    }
                    
                    // หักโควต้า
                    const newQuota = { ...quota };
                    newQuota[quotaField] = quota[quotaField] - 1;
                    await update(quotaRef, newQuota);
                }
                
                // อัปเดตตารางทำงาน
                await update(scheduleRef, { 
                    status: 'holiday',
                    leaveType: leaveType
                });
                
                closeLeaveModal();
                await loadCalendar();
                await loadLeaveQuota();
                
                alert('ลงวันหยุดเรียบร้อยแล้ว');
            } catch (error) {
                console.error('Error selecting holiday type:', error);
                alert('เกิดข้อผิดพลาดในการลงวันหยุด');
            }
        }

        // ลาวัน
        window.takeLeave = async function(date, leaveType) {
            try {
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const currentSchedule = snapshot.val();
                
                // ถ้าเป็นการเลือกซ้ำ (เลือกประเภทเดิม) ไม่ต้องหักโควต้า
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType === leaveType) {
                    closeLeaveModal();
                    alert('คุณได้เลือกประเภทการลานี้แล้ว');
                    return;
                }
                
                const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // ตรวจสอบโควต้า
                let quotaField = '';
                switch(leaveType) {
                    case 'regular': quotaField = 'regularLeave'; break;
                    case 'special': quotaField = 'specialLeave'; break;
                    case 'sick': quotaField = 'sickLeave'; break;
                    case 'vacation': quotaField = 'vacationLeave'; break;
                    case 'personal': quotaField = 'personalLeave'; break;
                }
                
                // ถ้าเปลี่ยนจากประเภทหนึ่งไปอีกประเภท ให้คืนโควต้าเก่าก่อน
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType && currentSchedule.leaveType !== leaveType) {
                    const oldQuotaField = currentSchedule.leaveType === 'regular' ? 'regularLeave' :
                                         currentSchedule.leaveType === 'special' ? 'specialLeave' :
                                         currentSchedule.leaveType === 'sick' ? 'sickLeave' :
                                         currentSchedule.leaveType === 'vacation' ? 'vacationLeave' :
                                         currentSchedule.leaveType === 'personal' ? 'personalLeave' : '';
                    
                    if (oldQuotaField) {
                        const newQuota = { ...quota };
                        newQuota[oldQuotaField] = quota[oldQuotaField] + 1; // คืนโควต้าเก่า
                        await update(quotaRef, newQuota);
                        
                        // อัปเดตโควต้าใหม่
                        const updatedQuotaSnapshot = await get(quotaRef);
                        const updatedQuota = updatedQuotaSnapshot.val();
                        
                        if (updatedQuota[quotaField] <= 0) {
                            alert('วันหยุดประเภทนี้หมดแล้ว');
                            return;
                        }
                        
                        // หักโควต้าใหม่
                        const finalQuota = { ...updatedQuota };
                        finalQuota[quotaField] = updatedQuota[quotaField] - 1;
                        await update(quotaRef, finalQuota);
                    }
                } else {
                    // กรณีปกติ - เปลี่ยนจากทำงานเป็นลา
                    if (quota[quotaField] <= 0) {
                        alert('วันหยุดประเภทนี้หมดแล้ว');
                        return;
                    }
                    
                    // หักโควต้า
                    const newQuota = { ...quota };
                    newQuota[quotaField] = quota[quotaField] - 1;
                    await update(quotaRef, newQuota);
                }
                
                // อัปเดตตารางทำงาน
                await update(scheduleRef, { 
                    status: 'holiday',
                    leaveType: leaveType
                });
                
                closeLeaveModal();
                await loadCalendar();
                await loadLeaveQuota();
                
                alert('ลงวันหยุดเรียบร้อยแล้ว');
            } catch (error) {
                console.error('Error taking leave:', error);
                alert('เกิดข้อผิดพลาดในการลงวันหยุด');
            }
        }

        // ปิด modal
        window.closeLeaveModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // โหลดโควต้าวันหยุด
        async function loadLeaveQuota() {
            const quotaRef = ref(null, `leaveQuota/${currentUser}`);
            const snapshot = await get(quotaRef);
            const quota = snapshot.val();
            
            const maxQuota = {
                regularLeave: 4,
                specialLeave: employees[currentUser].department === 'Telesale' ? 2 : 0,
                sickLeave: 30,
                vacationLeave: 6,
                personalLeave: 6
            };
            
            const usedQuota = {
                regularLeave: maxQuota.regularLeave - quota.regularLeave,
                specialLeave: maxQuota.specialLeave - quota.specialLeave,
                sickLeave: maxQuota.sickLeave - quota.sickLeave,
                vacationLeave: maxQuota.vacationLeave - quota.vacationLeave,
                personalLeave: maxQuota.personalLeave - quota.personalLeave
            };
            
            document.getElementById('leaveQuota').innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">สรุปวันหยุด</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="font-semibold text-blue-800">วันหยุดปกติ</div>
                            <div class="text-2xl font-bold text-blue-600">${quota.regularLeave}</div>
                            <div class="text-sm text-gray-600">เหลือจาก ${maxQuota.regularLeave} วัน</div>
                            <div class="text-xs text-gray-500">ใช้ไปแล้ว ${usedQuota.regularLeave} วัน</div>
                        </div>
                        
                        ${maxQuota.specialLeave > 0 ? `
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <div class="font-semibold text-purple-800">วันหยุดพิเศษ (Telesale)</div>
                            <div class="text-2xl font-bold text-purple-600">${quota.specialLeave}</div>
                            <div class="text-sm text-gray-600">เหลือจาก ${maxQuota.specialLeave} วัน</div>
                            <div class="text-xs text-gray-500">ใช้ไปแล้ว ${usedQuota.specialLeave} วัน</div>
                        </div>
                        ` : ''}
                        
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <div class="font-semibold text-red-800">ลาป่วย</div>
                            <div class="text-2xl font-bold text-red-600">${quota.sickLeave}</div>
                            <div class="text-sm text-gray-600">เหลือจาก ${maxQuota.sickLeave} วัน</div>
                            <div class="text-xs text-gray-500">ใช้ไปแล้ว ${usedQuota.sickLeave} วัน</div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div class="font-semibold text-green-800">ลาพักร้อน</div>
                            <div class="text-2xl font-bold text-green-600">${quota.vacationLeave}</div>
                            <div class="text-sm text-gray-600">เหลือจาก ${maxQuota.vacationLeave} วัน</div>
                            <div class="text-xs text-gray-500">ใช้ไปแล้ว ${usedQuota.vacationLeave} วัน</div>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="font-semibold text-yellow-800">ลากิจ</div>
                            <div class="text-2xl font-bold text-yellow-600">${quota.personalLeave}</div>
                            <div class="text-sm text-gray-600">เหลือจาก ${maxQuota.personalLeave} วัน</div>
                            <div class="text-xs text-gray-500">ใช้ไปแล้ว ${usedQuota.personalLeave} วัน</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600">
                            <strong>หมายเหตุ:</strong> วันหยุดนักขัตฤกษ์ไม่นับรวมในโควต้าวันหยุดปกติ
                        </div>
                    </div>
                </div>
            `;
        }

        // อัปเดตข้อกำหนดการลา
        window.updateLeaveRequirements = function() {
            const leaveType = document.getElementById('leaveType').value;
            const advanceNoticeInfo = document.getElementById('advanceNoticeInfo');
            const documentLabel = document.getElementById('documentLabel');
            const documentNote = document.getElementById('documentNote');
            const documentSection = document.getElementById('documentSection');
            
            // อัปเดตข้อมูลการแจ้งล่วงหน้า
            if (leaveType === 'ลาป่วย') {
                advanceNoticeInfo.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                        <div class="font-semibold text-yellow-800">🤒 ลาป่วย</div>
                        <div class="text-yellow-700">ไม่ต้องแจ้งล่วงหน้า</div>
                    </div>
                `;
                documentLabel.innerHTML = 'เอกสารแนบ (ใบรับรองแพทย์) <span class="text-red-500">*</span>';
                documentNote.innerHTML = '<strong>หมายเหตุ:</strong> ต้องแนบใบรับรองแพทย์สำหรับการลาป่วยทุกกรณี';
                documentSection.style.display = 'block';
            } else if (leaveType === 'ลาพักร้อน') {
                advanceNoticeInfo.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm">
                        <div class="font-semibold text-green-800">🏖️ ลาพักร้อน</div>
                        <div class="text-green-700">แจ้งล่วงหน้า 7 วัน</div>
                    </div>
                `;
                documentSection.style.display = 'none';
            } else if (leaveType === 'ลากิจ') {
                advanceNoticeInfo.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                        <div class="font-semibold text-blue-800">📋 ลากิจ</div>
                        <div class="text-blue-700">แจ้งล่วงหน้า 3 วัน</div>
                    </div>
                `;
                documentLabel.innerHTML = 'เอกสารแนบ (เอกสารตามธุระ) <span class="text-red-500">*</span>';
                documentNote.innerHTML = '<strong>หมายเหตุ:</strong> ต้องแนบเอกสารที่เกี่ยวข้องกับธุระที่ต้องไปทำ';
                documentSection.style.display = 'block';
            }
            
            // ตรวจสอบการแจ้งล่วงหน้าใหม่
            validateAdvanceNotice();
        }

        // ตรวจสอบการแจ้งล่วงหน้า
        window.validateAdvanceNotice = function() {
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('startDate').value;
            const advanceWarning = document.getElementById('advanceWarning');
            const advanceWarningText = document.getElementById('advanceWarningText');
            
            if (!startDate) {
                advanceWarning.classList.add('hidden');
                return;
            }
            
            // เริ่มนับจากวันพรุ่งนี้
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // รีเซ็ตเวลาเป็น 00:00:00
            
            const leaveStartDate = new Date(startDate);
            leaveStartDate.setHours(0, 0, 0, 0); // รีเซ็ตเวลาเป็น 00:00:00
            
            const daysDifference = Math.ceil((leaveStartDate - tomorrow) / (1000 * 60 * 60 * 24)) + 1;
            
            let requiredDays = 0;
            let isValid = true;
            
            if (leaveType === 'ลาป่วย') {
                // ลาป่วยไม่ต้องแจ้งล่วงหน้า
                isValid = true;
            } else if (leaveType === 'ลาพักร้อน') {
                requiredDays = 7;
                isValid = daysDifference >= requiredDays;
            } else if (leaveType === 'ลากิจ') {
                requiredDays = 3;
                isValid = daysDifference >= requiredDays;
            }
            
            if (!isValid && leaveType !== 'ลาป่วย') {
                advanceWarning.classList.remove('hidden');
                advanceWarningText.textContent = `${leaveType}ต้องแจ้งล่วงหน้าอย่างน้อย ${requiredDays} วัน (ปัจจุบันแจ้งล่วงหน้า ${daysDifference} วัน)`;
            } else {
                advanceWarning.classList.add('hidden');
            }
        }

        // จัดการการอัปโหลดไฟล์
        window.handleFileUpload = function() {
            const fileInput = document.getElementById('documentFile');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.textContent = file.name;
                fileUploadArea.classList.add('hidden');
                fileInfo.classList.remove('hidden');
            }
        }

        // ลบไฟล์
        window.removeFile = function() {
            const fileInput = document.getElementById('documentFile');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfo = document.getElementById('fileInfo');
            
            fileInput.value = '';
            fileUploadArea.classList.remove('hidden');
            fileInfo.classList.add('hidden');
        }

        // ส่งคำขอลา
        window.submitLeaveRequest = async function() {
            try {
                console.log('Starting submitLeaveRequest function...');
                
                const leaveTypeElement = document.getElementById('leaveType');
                const startDateElement = document.getElementById('startDate');
                const endDateElement = document.getElementById('endDate');
                const reasonElement = document.getElementById('reason');
                const documentFileElement = document.getElementById('documentFile');
                
                if (!leaveTypeElement || !startDateElement || !endDateElement || !reasonElement) {
                    console.error('Form elements not found');
                    alert('ไม่พบฟอร์มส่งคำขอลา กรุณารีเฟรชหน้าเว็บ');
                    return;
                }
                
                const leaveType = leaveTypeElement.value;
                const startDate = startDateElement.value;
                const endDate = endDateElement.value;
                const reason = reasonElement.value.trim();
                
                console.log('Form values:', { leaveType, startDate, endDate, reason });
                
                if (!startDate || !endDate || !reason) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด');
                    return;
                }
                
                // ตรวจสอบการแนบเอกสาร
                if ((leaveType === 'ลาป่วย' || leaveType === 'ลากิจ') && (!documentFileElement.files || documentFileElement.files.length === 0)) {
                    alert(`กรุณาแนบเอกสารสำหรับ${leaveType}\n\n${leaveType === 'ลาป่วย' ? 'ใบรับรองแพทย์' : 'เอกสารตามธุระ'}จำเป็นต้องแนบทุกครั้ง`);
                    return;
                }
                
                // ตรวจสอบการแจ้งล่วงหน้า - เริ่มนับจากวันพรุ่งนี้
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const leaveStartDate = new Date(startDate);
                leaveStartDate.setHours(0, 0, 0, 0);
                
                const daysDifference = Math.ceil((leaveStartDate - tomorrow) / (1000 * 60 * 60 * 24)) + 1;
                
                if (leaveType === 'ลาพักร้อน' && daysDifference < 7) {
                    const confirmed = confirm(`การลาพักร้อนต้องแจ้งล่วงหน้าอย่างน้อย 7 วัน\nปัจจุบันแจ้งล่วงหน้า ${daysDifference} วัน\n\nต้องการส่งคำขอต่อไปหรือไม่? (อาจไม่ได้รับการอนุมัติ)`);
                    if (!confirmed) return;
                } else if (leaveType === 'ลากิจ' && daysDifference < 3) {
                    const confirmed = confirm(`การลากิจต้องแจ้งล่วงหน้าอย่างน้อย 3 วัน\nปัจจุบันแจ้งล่วงหน้า ${daysDifference} วัน\n\nต้องการส่งคำขอต่อไปหรือไม่? (อาจไม่ได้รับการอนุมัติ)`);
                    if (!confirmed) return;
                }
                
                if (!currentUser || !employees[currentUser]) {
                    console.error('Current user not found:', currentUser);
                    alert('ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่');
                    return;
                }
                
                const leaveRequest = {
                    employeeId: currentUser,
                    employeeName: employees[currentUser].name,
                    leaveType,
                    startDate,
                    endDate,
                    reason,
                    status: 'pending',
                    requestDate: new Date().toISOString(),
                    hasDocument: (leaveType === 'ลาป่วย' || leaveType === 'ลากิจ') && documentFileElement.files.length > 0,
                    documentName: documentFileElement.files.length > 0 ? documentFileElement.files[0].name : null,
                    advanceNoticeDays: daysDifference
                };
                
                console.log('Saving leave request:', leaveRequest);
                
                try {
                    const result = await push(ref(null, 'leaveRequests'), leaveRequest);
                    console.log('Leave request saved with key:', result.key);
                    
                    alert('ส่งคำขอลาเรียบร้อยแล้ว\nรอการอนุมัติจาก HR');
                    
                    // รีเซ็ตฟอร์ม
                    leaveTypeElement.value = 'ลาป่วย';
                    startDateElement.value = '';
                    endDateElement.value = '';
                    reasonElement.value = '';
                    removeFile();
                    updateLeaveRequirements();
                    document.getElementById('advanceWarning').classList.add('hidden');
                    
                    await loadLeaveRequests();
                    console.log('Leave request submitted successfully');
                } catch (saveError) {
                    console.error('Error saving leave request:', saveError);
                    alert('เกิดข้อผิดพลาดในการบันทึกคำขอลา: ' + saveError.message);
                }
                
            } catch (error) {
                console.error('Error in submitLeaveRequest:', error);
                alert('เกิดข้อผิดพลาดในการส่งคำขอลา: ' + error.message);
            }
        }

        // โหลดคำขอลา
        async function loadLeaveRequests() {
            const requestsRef = ref(null, 'leaveRequests');
            const snapshot = await get(requestsRef);
            const requests = snapshot.val() || {};
            
            let requestsHTML = '';
            Object.entries(requests).forEach(([key, request]) => {
                if (request.employeeId === currentUser) {
                    let statusColor = 'bg-yellow-100 border-yellow-300';
                    let statusIcon = '⏳';
                    let statusText = 'รอการอนุมัติ';
                    
                    if (request.status === 'approved') {
                        statusColor = 'bg-green-100 border-green-300';
                        statusIcon = '✅';
                        statusText = 'อนุมัติแล้ว';
                    } else if (request.status === 'rejected') {
                        statusColor = 'bg-red-100 border-red-300';
                        statusIcon = '❌';
                        statusText = 'ไม่อนุมัติ';
                    }
                    
                    // กำหนดไอคอนตามประเภทการลา
                    let leaveIcon = '📋';
                    if (request.leaveType === 'ลาป่วย') leaveIcon = '🤒';
                    else if (request.leaveType === 'ลาพักร้อน') leaveIcon = '🏖️';
                    else if (request.leaveType === 'ลากิจ') leaveIcon = '📋';
                    
                    const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH');
                    
                    requestsHTML += `
                        <div class="border p-4 rounded-lg ${statusColor}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center">
                                    <span class="text-xl mr-2">${leaveIcon}</span>
                                    <div>
                                        <div class="font-bold text-lg">${request.leaveType}</div>
                                        <div class="text-sm text-gray-600">ส่งคำขอ: ${requestDate}</div>
                                    </div>
                                </div>
                                <div class="flex items-center font-semibold">
                                    <span class="mr-1">${statusIcon}</span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                            
                            <div class="space-y-2 text-sm">
                                <div><strong>วันที่:</strong> ${request.startDate} - ${request.endDate}</div>
                                <div><strong>เหตุผล:</strong> ${request.reason}</div>
                                
                                ${request.hasDocument ? `
                                    <div class="flex items-center text-green-600">
                                        <span class="mr-1">📎</span>
                                        <span>แนบเอกสาร: ${request.documentName || 'มีเอกสารแนบ'}</span>
                                    </div>
                                ` : ''}
                                
                                ${request.advanceNoticeDays !== undefined ? `
                                    <div class="text-gray-600">
                                        <strong>แจ้งล่วงหน้า:</strong> ${request.advanceNoticeDays} วัน
                                        ${(request.leaveType === 'ลาพักร้อน' && request.advanceNoticeDays < 7) || 
                                          (request.leaveType === 'ลากิจ' && request.advanceNoticeDays < 3) ? 
                                          '<span class="text-red-600 ml-2">⚠️ ไม่เพียงพอ</span>' : ''}
                                    </div>
                                ` : ''}
                                
                                ${request.status === 'approved' && request.approvedBy ? `
                                    <div class="text-green-700 text-xs mt-2 pt-2 border-t border-green-200">
                                        <strong>อนุมัติโดย:</strong> ${employees[request.approvedBy]?.name || request.approvedBy}
                                        ${request.approvedDate ? ` เมื่อ ${new Date(request.approvedDate).toLocaleDateString('th-TH')}` : ''}
                                    </div>
                                ` : ''}
                                
                                ${request.status === 'rejected' && request.rejectedBy ? `
                                    <div class="text-red-700 text-xs mt-2 pt-2 border-t border-red-200">
                                        <strong>ไม่อนุมัติโดย:</strong> ${employees[request.rejectedBy]?.name || request.rejectedBy}
                                        ${request.rejectedDate ? ` เมื่อ ${new Date(request.rejectedDate).toLocaleDateString('th-TH')}` : ''}
                                        ${request.rejectionReason ? `<br><strong>เหตุผล:</strong> ${request.rejectionReason}` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('leaveRequests').innerHTML = requestsHTML || '<div class="text-gray-500 text-center py-8">ไม่มีคำขอลา</div>';
        }

        // โหลดสถิติสรุปรวม
        async function loadSummaryStats() {
            try {
                const today = new Date();
                const currentDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                let todayStats = {
                    working: 0,
                    onLeave: 0,
                    holiday: 0,
                    pending: 0
                };
                
                let monthlyStats = {
                    totalLeaves: 0,
                    sickLeaves: 0,
                    vacationLeaves: 0,
                    personalLeaves: 0
                };
                
                // สถิติวันนี้
                for (const empId of Object.keys(employees)) {
                    try {
                        const scheduleRef = ref(null, `workSchedule/${empId}/${currentDate}`);
                        const snapshot = await get(scheduleRef);
                        const schedule = snapshot.val() || { status: 'work' };
                        
                        if (schedule.status === 'work') {
                            todayStats.working++;
                        } else if (schedule.status === 'leave') {
                            todayStats.onLeave++;
                        } else if (schedule.status === 'holiday') {
                            todayStats.holiday++;
                        } else if (schedule.status === 'holiday_pending') {
                            todayStats.pending++;
                        }
                    } catch (error) {
                        console.error('Error loading today stats for', empId, error);
                    }
                }
                
                // สถิติเดือนนี้
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    for (const empId of Object.keys(employees)) {
                        try {
                            const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                            const snapshot = await get(scheduleRef);
                            const schedule = snapshot.val();
                            
                            if (schedule && schedule.status === 'leave') {
                                monthlyStats.totalLeaves++;
                                
                                if (schedule.leaveType === 'sick') {
                                    monthlyStats.sickLeaves++;
                                } else if (schedule.leaveType === 'vacation') {
                                    monthlyStats.vacationLeaves++;
                                } else if (schedule.leaveType === 'personal') {
                                    monthlyStats.personalLeaves++;
                                }
                            }
                        } catch (error) {
                            // ข้ามวันที่ไม่มีข้อมูล
                        }
                    }
                }
                
                // แสดงสถิติ
                const summaryElement = document.getElementById('summaryStats');
                if (summaryElement) {
                    summaryElement.innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4">📊 สรุปสถิติ</h3>
                            
                            <!-- สถิติวันนี้ -->
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-700 mb-3">สถานะวันนี้ (${new Date().toLocaleDateString('th-TH')})</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-green-600">${todayStats.working}</div>
                                        <div class="text-sm text-gray-600">ทำงาน</div>
                                    </div>
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-orange-600">${todayStats.onLeave}</div>
                                        <div class="text-sm text-gray-600">ลา</div>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-red-600">${todayStats.holiday}</div>
                                        <div class="text-sm text-gray-600">หยุด</div>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-yellow-600">${todayStats.pending}</div>
                                        <div class="text-sm text-gray-600">รอเลือก</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- สถิติเดือนนี้ -->
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">สถิติการลาเดือนนี้</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-blue-600">${monthlyStats.totalLeaves}</div>
                                        <div class="text-sm text-gray-600">รวมทั้งหมด</div>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-red-600">${monthlyStats.sickLeaves}</div>
                                        <div class="text-sm text-gray-600">ลาป่วย</div>
                                    </div>
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-green-600">${monthlyStats.vacationLeaves}</div>
                                        <div class="text-sm text-gray-600">ลาพักร้อน</div>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-yellow-600">${monthlyStats.personalLeaves}</div>
                                        <div class="text-sm text-gray-600">ลากิจ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading summary stats:', error);
                const summaryElement = document.getElementById('summaryStats');
                if (summaryElement) {
                    summaryElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <div class="text-red-800 font-semibold">เกิดข้อผิดพลาดในการโหลดสถิติ</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // โหลด HR Panel
        async function loadHRPanel() {
            loadPendingLeaveRequests();
            loadAllLeaveRequests();
            loadEmployeeManagement();
            loadHRCalendar();
        }

        // โหลดคำขอลาที่รออนุมัติ
        async function loadPendingLeaveRequests() {
            const requestsRef = ref(null, 'leaveRequests');
            const snapshot = await get(requestsRef);
            const requests = snapshot.val() || {};
            
            let pendingHTML = '';
            Object.entries(requests).forEach(([key, request]) => {
                if (request.status === 'pending') {
                    // กำหนดไอคอนตามประเภทการลา
                    let leaveIcon = '📋';
                    let leaveColor = 'bg-blue-50 border-blue-200';
                    if (request.leaveType === 'ลาป่วย') {
                        leaveIcon = '🤒';
                        leaveColor = 'bg-red-50 border-red-200';
                    } else if (request.leaveType === 'ลาพักร้อน') {
                        leaveIcon = '🏖️';
                        leaveColor = 'bg-green-50 border-green-200';
                    } else if (request.leaveType === 'ลากิจ') {
                        leaveIcon = '📋';
                        leaveColor = 'bg-blue-50 border-blue-200';
                    }
                    
                    const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH');
                    
                    pendingHTML += `
                        <div class="border p-4 rounded-lg ${leaveColor} shadow-sm">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="font-bold text-lg flex items-center">
                                        <span class="mr-2">${leaveIcon}</span>
                                        ${request.employeeName}
                                    </div>
                                    <div class="text-sm text-gray-600">${request.employeeId || 'ไม่ระบุรหัส'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">
                                        ⏳ รออนุมัติ
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">ส่งคำขอ: ${requestDate}</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">ประเภทการลา</div>
                                    <div class="text-sm">${request.leaveType}</div>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">ระยะเวลา</div>
                                    <div class="text-sm">${request.startDate} - ${request.endDate}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="text-sm font-semibold text-gray-700">เหตุผล</div>
                                <div class="text-sm bg-white p-2 rounded border">${request.reason}</div>
                            </div>
                            
                            ${request.hasDocument ? `
                                <div class="mb-3">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">เอกสารแนบ</div>
                                    <div class="flex items-center text-green-600 text-sm mb-2">
                                        <span class="mr-1">📎</span>
                                        <span>${request.documentName || 'มีเอกสารแนบ'}</span>
                                    </div>
                                    
                                    <!-- แสดงรูปภาพตัวอย่าง (จำลอง) -->
                                    <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <div class="mb-2">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            <div class="font-semibold">${request.documentName || 'เอกสารแนบ'}</div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                ${request.leaveType === 'ลาป่วย' ? 'ใบรับรองแพทย์' : 
                                                  request.leaveType === 'ลากิจ' ? 'เอกสารตามธุระ' : 'เอกสารประกอบ'}
                                            </div>
                                        </div>
                                        <button onclick="viewDocument('${key}')" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                            👁️ ดูเอกสาร
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.advanceNoticeDays !== undefined ? `
                                <div class="mb-3">
                                    <div class="text-sm text-gray-600">
                                        <strong>แจ้งล่วงหน้า:</strong> ${request.advanceNoticeDays} วัน
                                        ${(request.leaveType === 'ลาพักร้อน' && request.advanceNoticeDays < 7) || 
                                          (request.leaveType === 'ลากิจ' && request.advanceNoticeDays < 3) ? 
                                          '<span class="text-red-600 ml-2">⚠️ ไม่เพียงพอ</span>' : 
                                          '<span class="text-green-600 ml-2">✅ เพียงพอ</span>'}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex space-x-2 pt-3 border-t">
                                <button onclick="approveLeave('${key}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm font-semibold flex items-center">
                                    <span class="mr-1">✅</span> อนุมัติ
                                </button>
                                <button onclick="rejectLeave('${key}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm font-semibold flex items-center">
                                    <span class="mr-1">❌</span> ไม่อนุมัติ
                                </button>
                                <button onclick="viewLeaveDetails('${key}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm font-semibold flex items-center">
                                    <span class="mr-1">👁️</span> ดูรายละเอียด
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('pendingLeaves').innerHTML = pendingHTML || '<div class="text-gray-500 text-center py-8">ไม่มีคำขอลาที่รออนุมัติ</div>';
        }

        // โหลดคำขอลาทั้งหมด
        window.loadAllLeaveRequests = async function() {
            try {
                const requestsRef = ref(null, 'leaveRequests');
                const snapshot = await get(requestsRef);
                const requests = snapshot.val() || {};
                
                let allRequestsHTML = '';
                const sortedRequests = Object.entries(requests).sort(([,a], [,b]) => 
                    new Date(b.requestDate) - new Date(a.requestDate)
                );
                
                sortedRequests.forEach(([key, request]) => {
                    let statusColor = 'bg-yellow-100 border-yellow-300';
                    let statusText = 'รอการอนุมัติ';
                    let statusIcon = '⏳';
                    
                    if (request.status === 'approved') {
                        statusColor = 'bg-green-100 border-green-300';
                        statusText = 'อนุมัติแล้ว';
                        statusIcon = '✅';
                    } else if (request.status === 'rejected') {
                        statusColor = 'bg-red-100 border-red-300';
                        statusText = 'ไม่อนุมัติ';
                        statusIcon = '❌';
                    }
                    
                    const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH');
                    const approvedDate = request.approvedDate ? new Date(request.approvedDate).toLocaleDateString('th-TH') : '';
                    const rejectedDate = request.rejectedDate ? new Date(request.rejectedDate).toLocaleDateString('th-TH') : '';
                    
                    // กำหนดไอคอนตามประเภทการลา
                    let leaveIcon = '📋';
                    if (request.leaveType === 'ลาป่วย') leaveIcon = '🤒';
                    else if (request.leaveType === 'ลาพักร้อน') leaveIcon = '🏖️';
                    else if (request.leaveType === 'ลากิจ') leaveIcon = '📋';
                    
                    allRequestsHTML += `
                        <div class="border p-4 rounded-lg ${statusColor}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="font-bold text-lg">${request.employeeName}</div>
                                    <div class="text-sm text-gray-600">${request.employeeId || 'ไม่ระบุรหัส'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="flex items-center font-semibold">
                                        ${statusIcon} ${statusText}
                                    </div>
                                    <div class="text-xs text-gray-500">ส่งคำขอ: ${requestDate}</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">ประเภทการลา</div>
                                    <div class="text-sm flex items-center">
                                        <span class="mr-2">${leaveIcon}</span>
                                        <span>${request.leaveType}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">ระยะเวลา</div>
                                    <div class="text-sm">${request.startDate} - ${request.endDate}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="text-sm font-semibold text-gray-700">เหตุผล</div>
                                <div class="text-sm bg-white p-2 rounded border">${request.reason}</div>
                            </div>
                            
                            ${request.hasDocument ? `
                                <div class="mb-3">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">เอกสารแนบ</div>
                                    <div class="flex items-center justify-between bg-gray-50 border rounded-lg p-3">
                                        <div class="flex items-center">
                                            <span class="mr-2">📎</span>
                                            <div>
                                                <div class="font-semibold text-sm">${request.documentName || 'เอกสารแนบ'}</div>
                                                <div class="text-xs text-gray-600">
                                                    ${request.leaveType === 'ลาป่วย' ? 'ใบรับรองแพทย์' : 
                                                      request.leaveType === 'ลากิจ' ? 'เอกสารตามธุระ' : 'เอกสารประกอบ'}
                                                </div>
                                            </div>
                                        </div>
                                        <button onclick="viewDocument('${key}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 flex items-center">
                                            <span class="mr-1">👁️</span> ดูเอกสาร
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.advanceNoticeDays !== undefined ? `
                                <div class="mb-3">
                                    <div class="text-sm text-gray-600">
                                        <strong>แจ้งล่วงหน้า:</strong> ${request.advanceNoticeDays} วัน
                                        ${(request.leaveType === 'ลาพักร้อน' && request.advanceNoticeDays < 7) || 
                                          (request.leaveType === 'ลากิจ' && request.advanceNoticeDays < 3) ? 
                                          '<span class="text-red-600 ml-2">⚠️ ไม่เพียงพอ</span>' : 
                                          '<span class="text-green-600 ml-2">✅ เพียงพอ</span>'}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.status === 'approved' ? `
                                <div class="text-sm text-green-700">
                                    <strong>อนุมัติโดย:</strong> ${employees[request.approvedBy]?.name || request.approvedBy}
                                    <br><strong>วันที่อนุมัติ:</strong> ${approvedDate}
                                </div>
                            ` : ''}
                            
                            ${request.status === 'rejected' ? `
                                <div class="text-sm text-red-700">
                                    <strong>ไม่อนุมัติโดย:</strong> ${employees[request.rejectedBy]?.name || request.rejectedBy}
                                    <br><strong>วันที่:</strong> ${rejectedDate}
                                    <br><strong>เหตุผล:</strong> ${request.rejectionReason}
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 flex space-x-2 pt-3 border-t">
                                ${request.status === 'pending' ? `
                                    <button onclick="approveLeave('${key}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm font-semibold flex items-center">
                                        <span class="mr-1">✅</span> อนุมัติ
                                    </button>
                                    <button onclick="rejectLeave('${key}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm font-semibold flex items-center">
                                        <span class="mr-1">❌</span> ไม่อนุมัติ
                                    </button>
                                    <button onclick="viewLeaveDetails('${key}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm font-semibold flex items-center">
                                        <span class="mr-1">👁️</span> ดูรายละเอียด
                                    </button>
                                    ${request.hasDocument ? `
                                        <button onclick="viewDocument('${key}')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-sm font-semibold flex items-center">
                                            <span class="mr-1">📎</span> ดูเอกสาร
                                        </button>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                const allRequestsElement = document.getElementById('allLeaveRequests');
                if (allRequestsElement) {
                    allRequestsElement.innerHTML = allRequestsHTML || '<div class="text-gray-500 text-center py-8">ไม่มีคำขอลา</div>';
                }
            } catch (error) {
                console.error('Error loading all leave requests:', error);
                const allRequestsElement = document.getElementById('allLeaveRequests');
                if (allRequestsElement) {
                    allRequestsElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">เกิดข้อผิดพลาดในการโหลดคำขอลา</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // อนุมัติการลา
        window.approveLeave = async function(requestKey) {
            try {
                const requestRef = ref(null, `leaveRequests/${requestKey}`);
                const snapshot = await get(requestRef);
                const request = snapshot.val();
                
                if (!request) {
                    alert('ไม่พบคำขอลา');
                    return;
                }
                
                // อัปเดตสถานะคำขอ
                await update(requestRef, { 
                    status: 'approved',
                    approvedBy: currentUser,
                    approvedDate: new Date().toISOString()
                });
                
                // คำนวณจำนวนวันลา
                const startDate = new Date(request.startDate);
                const endDate = new Date(request.endDate);
                let leaveDays = 0;
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    leaveDays++;
                }
                
                // อัปเดตโควต้าวันหยุด
                const quotaRef = ref(null, `leaveQuota/${request.employeeId}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                if (quota) {
                    const newQuota = { ...quota };
                    
                    // หักโควต้าตามประเภทการลา
                    if (request.leaveType === 'ลาป่วย') {
                        newQuota.sickLeave = Math.max(0, quota.sickLeave - leaveDays);
                    } else if (request.leaveType === 'ลาพักร้อน') {
                        newQuota.vacationLeave = Math.max(0, quota.vacationLeave - leaveDays);
                    } else if (request.leaveType === 'ลากิจ') {
                        newQuota.personalLeave = Math.max(0, quota.personalLeave - leaveDays);
                    }
                    
                    await update(quotaRef, newQuota);
                }
                
                // อัปเดตตารางทำงานของพนักงาน
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const scheduleRef = ref(null, `workSchedule/${request.employeeId}/${dateStr}`);
                    
                    // กำหนด leaveType ตามประเภทการลา
                    let leaveType = 'sick';
                    if (request.leaveType === 'ลาป่วย') leaveType = 'sick';
                    else if (request.leaveType === 'ลาพักร้อน') leaveType = 'vacation';
                    else if (request.leaveType === 'ลากิจ') leaveType = 'personal';
                    
                    await update(scheduleRef, { 
                        status: 'leave',
                        leaveType: leaveType,
                        approvedBy: currentUser
                    });
                }
                
                alert(`อนุมัติการลาเรียบร้อยแล้ว (${leaveDays} วัน)`);
                loadPendingLeaveRequests();
                loadAllLeaveRequests();
                loadHRCalendar();
                loadEmployeeManagement(); // รีเฟรชข้อมูลโควต้าในตารางพนักงาน
            } catch (error) {
                console.error('Error approving leave:', error);
                alert('เกิดข้อผิดพลาดในการอนุมัติ');
            }
        }

        // ไม่อนุมัติการลา
        window.rejectLeave = async function(requestKey) {
            const reason = prompt('เหตุผลที่ไม่อนุมัติ:');
            if (!reason) return;
            
            try {
                await update(ref(null, `leaveRequests/${requestKey}`), { 
                    status: 'rejected',
                    rejectedBy: currentUser,
                    rejectedDate: new Date().toISOString(),
                    rejectionReason: reason
                });
                
                alert('ไม่อนุมัติการลาเรียบร้อยแล้ว');
                loadPendingLeaveRequests();
                loadAllLeaveRequests();
            } catch (error) {
                console.error('Error rejecting leave:', error);
                alert('เกิดข้อผิดพลาดในการไม่อนุมัติ');
            }
        }

        // โหลดการจัดการพนักงาน
        async function loadEmployeeManagement() {
            try {
                console.log('Loading employee management...');
                console.log('Current employees:', employees);
                console.log('Current user role:', employees[currentUser]?.role);
                console.log('Current user department:', employees[currentUser]?.department);
                
                const isHR = employees[currentUser]?.role === 'HR';
                const isManager = employees[currentUser]?.role === 'Manager';
                const currentUserDept = employees[currentUser]?.department;
                
                let empHTML = '';
                
                // แสดงปุ่มเพิ่ม/ลบเฉพาะ HR
                if (isHR) {
                    empHTML += `
                        <div class="mb-6 flex space-x-4">
                            <button onclick="showAddEmployeeForm()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold shadow-lg transition-all duration-200">
                                ➕ เพิ่มพนักงานใหม่
                            </button>
                            <button onclick="showBulkDeleteForm()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold shadow-lg transition-all duration-200">
                                🗑️ ลบพนักงานหลายคน
                            </button>
                        </div>
                    `;
                } else if (isManager) {
                    empHTML += `
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="text-blue-800 font-semibold">สิทธิ์ Manager</div>
                            <div class="text-blue-700 text-sm mt-1">
                                คุณสามารถดูและแก้ไขข้อมูลพนักงานในแผนก ${currentUserDept} เท่านั้น
                            </div>
                        </div>
                    `;
                }
                
                empHTML += `
                    <!-- สรุปจำนวนพนักงาน -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${Object.keys(employees).length}</div>
                            <div class="text-sm text-gray-600">พนักงานทั้งหมด</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">${Object.values(employees).filter(emp => emp.department === 'Admin').length}</div>
                            <div class="text-sm text-gray-600">แผนก Admin</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600">${Object.values(employees).filter(emp => emp.department === 'Marketing').length}</div>
                            <div class="text-sm text-gray-600">แผนก Marketing</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600">${Object.values(employees).filter(emp => emp.department === 'Telesale').length}</div>
                            <div class="text-sm text-gray-600">แผนก Telesale</div>
                        </div>
                    </div>
                    
                    <!-- ตารางพนักงาน -->
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h4 class="font-bold text-lg">รายชื่อพนักงาน</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        ${isManager ? '' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัส</th>'}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ตำแหน่ง</th>
                                        ${isManager ? '' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แผนก</th>'}
                                        ${isManager ? '' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">บทบาท</th>'}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เวลาทำงาน</th>
                                        ${isManager ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แก้ไข</th>' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>'}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // เรียงลำดับพนักงานตามแผนกและรหัส
                let sortedEmployees = Object.entries(employees).sort(([a, empA], [b, empB]) => {
                    if (empA.department !== empB.department) {
                        return empA.department.localeCompare(empB.department);
                    }
                    return a.localeCompare(b);
                });
                
                // กรองพนักงานสำหรับ Manager - เห็นเฉพาะแผนกตัวเอง
                if (isManager) {
                    sortedEmployees = sortedEmployees.filter(([id, emp]) => emp.department === currentUserDept);
                }
                
                console.log('Sorted employees:', sortedEmployees);
                
                for (const [empId, emp] of sortedEmployees) {
                    // กำหนดสีตามแผนก
                    let deptColor = 'bg-gray-100';
                    let roleColor = 'bg-blue-100 text-blue-800';
                    
                    switch(emp.department) {
                        case 'HR': deptColor = 'bg-red-100 text-red-800'; break;
                        case 'Admin': deptColor = 'bg-green-100 text-green-800'; break;
                        case 'Marketing': deptColor = 'bg-purple-100 text-purple-800'; break;
                        case 'Telesale': deptColor = 'bg-orange-100 text-orange-800'; break;
                    }
                    
                    if (emp.role === 'HR') roleColor = 'bg-red-100 text-red-800';
                    else if (emp.role === 'Manager') roleColor = 'bg-yellow-100 text-yellow-800';
                    else roleColor = 'bg-blue-100 text-blue-800';
                    
                    // ดึงข้อมูลโควต้าวันหยุด
                    let quotaInfo = 'กำลังโหลด...';
                    try {
                        const quotaRef = ref(null, `leaveQuota/${empId}`);
                        const quotaSnapshot = await get(quotaRef);
                        const quota = quotaSnapshot.val();
                        if (quota) {
                            quotaInfo = `ปกติ: ${quota.regularLeave}, ป่วย: ${quota.sickLeave}, พักร้อน: ${quota.vacationLeave}`;
                            if (quota.specialLeave > 0) quotaInfo += `, พิเศษ: ${quota.specialLeave}`;
                        } else {
                            quotaInfo = 'ไม่มีข้อมูลโควต้า';
                        }
                    } catch (error) {
                        console.error('Error loading quota for', empId, error);
                        quotaInfo = 'ไม่สามารถโหลดได้';
                    }
                    
                    empHTML += `
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            ${isManager ? '' : `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-bold text-blue-600">${empId}</div>
                            </td>
                            `}
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">${emp.name}</div>
                                ${isManager ? '' : `<div class="text-xs text-gray-500" title="โควต้าวันหยุดคงเหลือ">${quotaInfo}</div>`}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${emp.position}</div>
                            </td>
                            ${isManager ? '' : `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${deptColor}">
                                    ${emp.department}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${roleColor}">
                                    ${emp.role}
                                </span>
                            </td>
                            `}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${emp.workTime}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="editEmployee('${empId}')" class="bg-yellow-500 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-600 transition-colors duration-150">
                                    ✏️ แก้ไข
                                </button>
                                ${isManager ? '' : `
                                <button onclick="deleteEmployee('${empId}')" class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 transition-colors duration-150" ${empId === currentUser ? 'disabled title="ไม่สามารถลบตัวเองได้"' : ''}>
                                    🗑️ ลบ
                                </button>
                                <button onclick="viewEmployeeDetails('${empId}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 transition-colors duration-150">
                                    👁️ ดู
                                </button>
                                `}
                            </td>
                        </tr>
                    `;
                }
                
                empHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                console.log('Setting employee list HTML...');
                const employeeListElement = document.getElementById('employeeList');
                if (employeeListElement) {
                    employeeListElement.innerHTML = empHTML;
                    console.log('Employee list updated successfully');
                } else {
                    console.error('employeeList element not found');
                }
            } catch (error) {
                console.error('Error in loadEmployeeManagement:', error);
                const employeeListElement = document.getElementById('employeeList');
                if (employeeListElement) {
                    employeeListElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูลพนักงาน</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                            <button onclick="loadEmployeeManagement()" class="mt-3 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">ลองใหม่</button>
                        </div>
                    `;
                }
            }
        }

        // แสดงฟอร์มเพิ่มพนักงาน
        window.showAddEmployeeForm = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">เพิ่มพนักงานใหม่</h3>
                    <form id="addEmployeeForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">รหัสพนักงาน</label>
                            <input type="text" id="newEmpId" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ชื่อ-นามสกุล</label>
                            <input type="text" id="newEmpName" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">แผนก</label>
                            <select id="newEmpDepartment" class="w-full px-3 py-2 border rounded-lg" required onchange="updatePositionOptions('new')">
                                <option value="">เลือกแผนก</option>
                                <option value="HR">HR</option>
                                <option value="Admin">Admin</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Telesale">Telesale</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ตำแหน่ง</label>
                            <select id="newEmpPosition" class="w-full px-3 py-2 border rounded-lg" required onchange="updateWorkTimeOptions('new')">
                                <option value="">เลือกตำแหน่ง</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">บทบาท</label>
                            <select id="newEmpRole" class="w-full px-3 py-2 border rounded-lg" required>
                                <option value="">เลือกบทบาท</option>
                                <option value="HR">HR</option>
                                <option value="Manager">Manager</option>
                                <option value="Employee">Employee</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">เวลาทำงาน</label>
                            <select id="newEmpWorkTime" class="w-full px-3 py-2 border rounded-lg" required>
                                <option value="">เลือกเวลาทำงาน</option>
                            </select>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ยกเลิก</button>
                        <button onclick="addEmployee()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">เพิ่มพนักงาน</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // อัปเดตตัวเลือกตำแหน่งตามแผนก
        window.updatePositionOptions = function(formType) {
            const departmentSelect = document.getElementById(`${formType}EmpDepartment`);
            const positionSelect = document.getElementById(`${formType}EmpPosition`);
            const workTimeSelect = document.getElementById(`${formType}EmpWorkTime`);
            
            const department = departmentSelect.value;
            
            // ล้างตัวเลือกเก่า
            positionSelect.innerHTML = '<option value="">เลือกตำแหน่ง</option>';
            workTimeSelect.innerHTML = '<option value="">เลือกเวลาทำงาน</option>';
            
            const positions = {
                'HR': ['HR'],
                'Admin': ['Admin Manager', 'Admin Team 1', 'Admin Team 2'],
                'Marketing': ['Marketing Manager', 'Editor', 'Content Creator'],
                'Telesale': ['Telesale']
            };
            
            if (positions[department]) {
                positions[department].forEach(position => {
                    const option = document.createElement('option');
                    option.value = position;
                    option.textContent = position;
                    positionSelect.appendChild(option);
                });
            }
        }
        
        // อัปเดตตัวเลือกเวลาทำงานตามตำแหน่ง (สำหรับฟอร์มเพิ่มพนักงาน)
        window.updateWorkTimeOptions = function(formType) {
            const positionSelect = document.getElementById(`${formType}EmpPosition`);
            const workTimeSelect = document.getElementById(`${formType}EmpWorkTime`);
            
            const position = positionSelect.value;
            
            // ล้างตัวเลือกเก่า
            workTimeSelect.innerHTML = '<option value="">เลือกเวลาทำงาน</option>';
            
            const workTimes = {
                'HR': ['08:30-17:30'],
                'Admin Manager': ['08:30-17:30'],
                'Admin Team 1': ['06:00-15:00', '14:00-23:00'],
                'Admin Team 2': ['06:00-15:00', '14:00-23:00'],
                'Marketing Manager': ['10:30-19:30'],
                'Editor': ['10:30-19:30'],
                'Content Creator': ['08:30-17:30'],
                'Telesale': ['08:30-17:30']
            };
            
            if (workTimes[position]) {
                workTimes[position].forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    workTimeSelect.appendChild(option);
                });
            }
        }

        // อัปเดตการแสดงเวลาทำงานตามตำแหน่ง (สำหรับฟอร์มแก้ไข - แสดงเวลาฟิกซ์)
        window.updateWorkTimeDisplay = function(formType) {
            const positionSelect = document.getElementById(`${formType}EmpPosition`);
            const workTimeInput = document.getElementById(`${formType}EmpWorkTime`);
            
            const position = positionSelect.value;
            
            // กำหนดเวลาทำงานตามตำแหน่ง (ฟิกซ์)
            const fixedWorkTimes = {
                'HR': '08:30-17:30',
                'Admin Manager': '08:30-17:30',
                'Admin Team 1': '06:00-15:00 หรือ 14:00-23:00 (ตามกะ)',
                'Admin Team 2': '06:00-15:00 หรือ 14:00-23:00 (ตามกะ)',
                'Marketing Manager': '10:30-19:30',
                'Editor': '10:30-19:30',
                'Content Creator': '08:30-17:30',
                'Telesale': '08:30-17:30'
            };
            
            if (fixedWorkTimes[position]) {
                workTimeInput.value = fixedWorkTimes[position];
            } else {
                workTimeInput.value = '';
            }
        }

        // เพิ่มพนักงาน
        window.addEmployee = async function() {
            const empId = document.getElementById('newEmpId').value.trim().toUpperCase();
            const name = document.getElementById('newEmpName').value.trim();
            const position = document.getElementById('newEmpPosition').value;
            const department = document.getElementById('newEmpDepartment').value;
            const role = document.getElementById('newEmpRole').value;
            const workTime = document.getElementById('newEmpWorkTime').value;
            
            if (!empId || !name || !position || !department || !role || !workTime) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            if (employees[empId]) {
                alert('รหัสพนักงานนี้มีอยู่แล้ว');
                return;
            }
            
            try {
                // กำหนดทีมและกะสำหรับ Admin และเวลาทำงานตามตำแหน่ง
                let team = null;
                let shift = null;
                let finalWorkTime = workTime;
                
                // กำหนดเวลาทำงานตามตำแหน่ง (ฟิกซ์ตามตำแหน่ง)
                if (position === 'HR') {
                    finalWorkTime = '08:30-17:30';
                } else if (position === 'Admin Manager') {
                    finalWorkTime = '08:30-17:30';
                    team = 'Manager';
                    shift = null;
                } else if (position === 'Admin Team 1') {
                    team = 'Team1';
                    shift = 'morning'; // เริ่มต้นกะเช้า
                    finalWorkTime = '06:00-15:00';
                } else if (position === 'Admin Team 2') {
                    team = 'Team2';
                    shift = 'evening'; // เริ่มต้นกะบ่าย
                    finalWorkTime = '14:00-23:00';
                } else if (position === 'Marketing Manager') {
                    finalWorkTime = '10:30-19:30';
                } else if (position === 'Editor') {
                    finalWorkTime = '10:30-19:30';
                } else if (position === 'Content Creator') {
                    finalWorkTime = '08:30-17:30';
                } else if (position === 'Telesale') {
                    finalWorkTime = '08:30-17:30';
                }
                
                const newEmployee = { 
                    name, 
                    position, 
                    role, 
                    department, 
                    workTime: finalWorkTime,
                    team,
                    shift
                };
                
                // เพิ่มในระบบ
                employees[empId] = newEmployee;
                await set(ref(null, `employees/${empId}`), newEmployee);
                
                // เริ่มต้นโควต้าวันหยุด
                const quota = {
                    regularLeave: 4,
                    specialLeave: department === 'Telesale' ? 2 : 0,
                    sickLeave: 30,
                    vacationLeave: 6,
                    personalLeave: 6
                };
                await set(ref(null, `leaveQuota/${empId}`), quota);
                
                // สร้างตารางทำงาน
                await generateWorkSchedule(currentYear, currentMonth);
                
                alert('เพิ่มพนักงานเรียบร้อยแล้ว');
                closeEmployeeModal();
                loadEmployeeManagement();
            } catch (error) {
                console.error('Error adding employee:', error);
                alert('เกิดข้อผิดพลาดในการเพิ่มพนักงาน');
            }
        }

        // แก้ไขพนักงาน
        window.editEmployee = function(empId) {
            const emp = employees[empId];
            const isManager = employees[currentUser]?.role === 'Manager';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">แก้ไขข้อมูลพนักงาน</h3>
                    
                    ${isManager ? `
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="text-blue-800 text-sm font-semibold">สิทธิ์ Manager</div>
                        <div class="text-blue-700 text-xs mt-1">คุณสามารถแก้ไขได้เฉพาะ ตำแหน่ง และ เวลาทำงาน เท่านั้น</div>
                    </div>
                    ` : ''}
                    
                    <form id="editEmployeeForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">รหัสพนักงาน</label>
                            <input type="text" id="editEmpId" value="${empId}" class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ชื่อ-นามสกุล</label>
                            <input type="text" id="editEmpName" value="${emp.name}" class="w-full px-3 py-2 border rounded-lg ${isManager ? 'bg-gray-100' : ''}" ${isManager ? 'readonly' : 'required'}>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">แผนก</label>
                            <select id="editEmpDepartment" class="w-full px-3 py-2 border rounded-lg ${isManager ? 'bg-gray-100' : ''}" ${isManager ? 'disabled' : 'required'} onchange="updatePositionOptions('edit')">
                                <option value="HR" ${emp.department === 'HR' ? 'selected' : ''}>HR</option>
                                <option value="Admin" ${emp.department === 'Admin' ? 'selected' : ''}>Admin</option>
                                <option value="Marketing" ${emp.department === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Telesale" ${emp.department === 'Telesale' ? 'selected' : ''}>Telesale</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ตำแหน่ง</label>
                            <select id="editEmpPosition" class="w-full px-3 py-2 border rounded-lg" required onchange="updateWorkTimeDisplay('edit')">
                                <option value="">เลือกตำแหน่ง</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">บทบาท</label>
                            <select id="editEmpRole" class="w-full px-3 py-2 border rounded-lg ${isManager ? 'bg-gray-100' : ''}" ${isManager ? 'disabled' : 'required'}>
                                <option value="HR" ${emp.role === 'HR' ? 'selected' : ''}>HR</option>
                                <option value="Manager" ${emp.role === 'Manager' ? 'selected' : ''}>Manager</option>
                                <option value="Employee" ${emp.role === 'Employee' ? 'selected' : ''}>Employee</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">เวลาทำงาน</label>
                            <input type="text" id="editEmpWorkTime" class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
                            <div class="text-xs text-gray-500 mt-1">เวลาทำงานจะถูกกำหนดอัตโนมัติตามตำแหน่ง</div>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ยกเลิก</button>
                        <button onclick="updateEmployee('${empId}')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">บันทึก</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // เรียกใช้ฟังก์ชันเพื่อโหลดตัวเลือกตำแหน่งและแสดงเวลาทำงาน
            setTimeout(() => {
                updatePositionOptions('edit');
                setTimeout(() => {
                    document.getElementById('editEmpPosition').value = emp.position;
                    // แสดงเวลาทำงานปัจจุบัน (แบบ readonly)
                    document.getElementById('editEmpWorkTime').value = emp.workTime;
                }, 100);
            }, 100);
        }

        // อัปเดตพนักงาน
        window.updateEmployee = async function(empId) {
            try {
                console.log('Starting updateEmployee for:', empId);
                
                const isManager = employees[currentUser]?.role === 'Manager';
                const currentEmp = employees[empId];
                
                if (!currentEmp) {
                    alert('ไม่พบข้อมูลพนักงาน');
                    return;
                }
                
                // ตรวจสอบว่า DOM elements มีอยู่จริง
                const nameElement = document.getElementById('editEmpName');
                const departmentElement = document.getElementById('editEmpDepartment');
                const roleElement = document.getElementById('editEmpRole');
                const positionElement = document.getElementById('editEmpPosition');
                
                if (!nameElement || !departmentElement || !roleElement || !positionElement) {
                    console.error('Required form elements not found');
                    alert('ไม่พบฟอร์มแก้ไขข้อมูล กรุณาลองใหม่');
                    return;
                }
                
                // สำหรับ Manager - ใช้ข้อมูลเดิมสำหรับฟิลด์ที่ไม่สามารถแก้ไขได้
                const name = isManager ? currentEmp.name : nameElement.value.trim();
                const department = isManager ? currentEmp.department : departmentElement.value;
                const role = isManager ? currentEmp.role : roleElement.value;
                
                // ฟิลด์ที่ Manager สามารถแก้ไขได้
                const position = positionElement.value;
                
                console.log('Form values:', { name, department, role, position });
                
                if (!name || !position || !department || !role) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }
                
                // กำหนดทีมและกะสำหรับ Admin และเวลาทำงานตามตำแหน่ง (ฟิกซ์)
                let team = currentEmp.team; // เก็บทีมเดิมไว้
                let shift = currentEmp.shift; // เก็บกะเดิมไว้
                let finalWorkTime;
                let finalPosition = position; // เก็บตำแหน่งที่จะบันทึกลง Database
                
                // กำหนดเวลาทำงานตามตำแหน่ง (ฟิกซ์ตามตำแหน่ง - ไม่ให้แก้ไข)
                if (position === 'HR') {
                    finalWorkTime = '08:30-17:30';
                    team = null;
                    shift = null;
                } else if (position === 'Admin Manager') {
                    finalWorkTime = '08:30-17:30';
                    team = 'Manager';
                    shift = null;
                } else if (position === 'Admin Team 1') {
                    team = 'Team1';
                    // ถ้าเปลี่ยนจากตำแหน่งอื่นมาเป็น Team 1 ให้เริ่มต้นกะเช้า
                    if (currentEmp.position !== 'Admin Team 1') {
                        shift = 'morning';
                        finalWorkTime = '06:00-15:00';
                    } else {
                        // ถ้าเป็น Team 1 อยู่แล้ว ให้ใช้กะปัจจุบัน
                        finalWorkTime = currentEmp.shift === 'morning' ? '06:00-15:00' : '14:00-23:00';
                    }
                    // อัปเดตตำแหน่งให้แสดงกะปัจจุบัน
                    finalPosition = `Admin Team 1 (${shift === 'morning' ? 'กะเช้า' : 'กะเย็น'})`;
                } else if (position === 'Admin Team 2') {
                    team = 'Team2';
                    // ถ้าเปลี่ยนจากตำแหน่งอื่นมาเป็น Team 2 ให้เริ่มต้นกะบ่าย
                    if (currentEmp.position !== 'Admin Team 2') {
                        shift = 'evening';
                        finalWorkTime = '14:00-23:00';
                    } else {
                        // ถ้าเป็น Team 2 อยู่แล้ว ให้ใช้กะปัจจุบัน
                        finalWorkTime = currentEmp.shift === 'morning' ? '06:00-15:00' : '14:00-23:00';
                    }
                    // อัปเดตตำแหน่งให้แสดงกะปัจจุบัน
                    finalPosition = `Admin Team 2 (${shift === 'morning' ? 'กะเช้า' : 'กะเย็น'})`;
                } else if (position === 'Marketing Manager') {
                    finalWorkTime = '10:30-19:30';
                    team = null;
                    shift = null;
                } else if (position === 'Editor') {
                    finalWorkTime = '10:30-19:30';
                    team = null;
                    shift = null;
                } else if (position === 'Content Creator') {
                    finalWorkTime = '08:30-17:30';
                    team = null;
                    shift = null;
                } else if (position === 'Telesale') {
                    finalWorkTime = '08:30-17:30';
                    team = null;
                    shift = null;
                } else {
                    // ตำแหน่งอื่นๆ ใช้เวลาเดิม
                    finalWorkTime = currentEmp.workTime || '08:30-17:30';
                }
                
                const updatedEmployee = { 
                    name, 
                    position: finalPosition, // ใช้ตำแหน่งที่อัปเดตแล้ว
                    role, 
                    department, 
                    workTime: finalWorkTime,
                    team,
                    shift
                };
                
                console.log('Updated employee data:', updatedEmployee);
                
                // อัปเดตในระบบ (หน่วยความจำ)
                employees[empId] = updatedEmployee;
                
                // อัปเดตใน Database
                await update(ref(null, `employees/${empId}`), updatedEmployee);
                console.log('Employee data updated in database');
                
                // อัปเดตโควต้าถ้าเปลี่ยนแผนก (เฉพาะ HR)
                if (!isManager && currentEmp.department !== department) {
                    const quotaRef = ref(null, `leaveQuota/${empId}`);
                    const quotaSnapshot = await get(quotaRef);
                    const currentQuota = quotaSnapshot.val();
                    
                    if (currentQuota) {
                        const newSpecialLeave = department === 'Telesale' ? 2 : 0;
                        await update(quotaRef, { specialLeave: newSpecialLeave });
                        console.log('Updated quota for department change');
                    }
                }
                
                alert('อัปเดตข้อมูลพนักงานเรียบร้อยแล้ว');
                closeEmployeeModal();
                await loadEmployeeManagement();
                
                // รีเฟรชระบบกะถ้าเป็น Admin
                if (department === 'Admin' && !isManager) {
                    await loadShiftManagement();
                }
                
                console.log('Employee update completed successfully');
                
            } catch (error) {
                console.error('Error updating employee:', error);
                alert('เกิดข้อผิดพลาดในการอัปเดตข้อมูล: ' + error.message);
            }
        }

        // ลบพนักงาน
        window.deleteEmployee = async function(empId) {
            if (!confirm(`ต้องการลบพนักงาน ${employees[empId].name} หรือไม่?\n\nการลบจะไม่สามารถกู้คืนได้`)) {
                return;
            }
            
            try {
                // ลบจากระบบ
                delete employees[empId];
                await set(ref(null, `employees/${empId}`), null);
                await set(ref(null, `leaveQuota/${empId}`), null);
                await set(ref(null, `workSchedule/${empId}`), null);
                
                alert('ลบพนักงานเรียบร้อยแล้ว');
                loadEmployeeManagement();
                loadHRCalendar();
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('เกิดข้อผิดพลาดในการลบพนักงาน');
            }
        }

        // ดูรายละเอียดพนักงาน
        window.viewEmployeeDetails = async function(empId) {
            try {
                const emp = employees[empId];
                const quotaRef = ref(null, `leaveQuota/${empId}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // คำนวณวันหยุดที่ใช้ไป
                const maxQuota = {
                    regularLeave: 4,
                    specialLeave: emp.department === 'Telesale' ? 2 : 0,
                    sickLeave: 30,
                    vacationLeave: 6,
                    personalLeave: 6
                };
                
                const usedQuota = {
                    regularLeave: maxQuota.regularLeave - quota.regularLeave,
                    specialLeave: maxQuota.specialLeave - quota.specialLeave,
                    sickLeave: maxQuota.sickLeave - quota.sickLeave,
                    vacationLeave: maxQuota.vacationLeave - quota.vacationLeave,
                    personalLeave: maxQuota.personalLeave - quota.personalLeave
                };
                
                // ดึงประวัติการลาทั้งหมด (ทุกเดือน)
                let allLeaveHistory = [];
                
                // ตรวจสอบ 12 เดือนย้อนหลัง
                for (let monthOffset = 0; monthOffset < 12; monthOffset++) {
                    const checkDate = new Date(currentYear, currentMonth - monthOffset, 1);
                    const checkYear = checkDate.getFullYear();
                    const checkMonth = checkDate.getMonth();
                    const daysInCheckMonth = new Date(checkYear, checkMonth + 1, 0).getDate();
                    
                    for (let day = 1; day <= daysInCheckMonth; day++) {
                        const date = `${checkYear}-${String(checkMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        try {
                            const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                            const snapshot = await get(scheduleRef);
                            const schedule = snapshot.val();
                            
                            if (schedule && (schedule.status === 'leave' || schedule.status === 'holiday')) {
                                allLeaveHistory.push({
                                    date: date,
                                    status: schedule.status,
                                    leaveType: schedule.leaveType || 'ไม่ระบุ',
                                    year: checkYear,
                                    month: checkMonth + 1,
                                    day: day
                                });
                            }
                        } catch (error) {
                            // ข้ามวันที่ไม่มีข้อมูล
                        }
                    }
                }
                
                // เรียงลำดับจากใหม่ไปเก่า
                allLeaveHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // แยกประวัติตามเดือน
                const leaveByMonth = {};
                allLeaveHistory.forEach(leave => {
                    const monthKey = `${leave.year}-${String(leave.month).padStart(2, '0')}`;
                    if (!leaveByMonth[monthKey]) {
                        leaveByMonth[monthKey] = [];
                    }
                    leaveByMonth[monthKey].push(leave);
                });
                
                // ดึงประวัติการลาในเดือนนี้
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const currentMonthLeaves = leaveByMonth[currentMonthKey] || [];
                
                const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                                  'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">รายละเอียดพนักงาน</h3>
                            <button onclick="closeEmployeeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <!-- ข้อมูลพื้นฐาน -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-bold text-blue-800 mb-3">ข้อมูลพื้นฐาน</h4>
                                <div class="space-y-2">
                                    <div><span class="font-semibold">รหัสพนักงาน:</span> ${empId}</div>
                                    <div><span class="font-semibold">ชื่อ-นามสกุล:</span> ${emp.name}</div>
                                    <div><span class="font-semibold">ตำแหน่ง:</span> ${emp.position}</div>
                                    <div><span class="font-semibold">แผนก:</span> <span class="px-2 py-1 rounded-full text-xs ${emp.department === 'HR' ? 'bg-red-100 text-red-800' : emp.department === 'Admin' ? 'bg-green-100 text-green-800' : emp.department === 'Marketing' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}">${emp.department}</span></div>
                                    <div><span class="font-semibold">บทบาท:</span> <span class="px-2 py-1 rounded-full text-xs ${emp.role === 'HR' ? 'bg-red-100 text-red-800' : emp.role === 'Manager' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${emp.role}</span></div>
                                    <div><span class="font-semibold">เวลาทำงาน:</span> ${emp.workTime}</div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-bold text-green-800 mb-3">สรุปโควต้าวันหยุด</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>วันหยุดปกติ:</span>
                                        <span class="font-semibold">${quota.regularLeave}/${maxQuota.regularLeave} วัน</span>
                                    </div>
                                    ${maxQuota.specialLeave > 0 ? `
                                    <div class="flex justify-between">
                                        <span>วันหยุดพิเศษ:</span>
                                        <span class="font-semibold">${quota.specialLeave}/${maxQuota.specialLeave} วัน</span>
                                    </div>
                                    ` : ''}
                                    <div class="flex justify-between">
                                        <span>ลาป่วย:</span>
                                        <span class="font-semibold">${quota.sickLeave}/${maxQuota.sickLeave} วัน</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ลาพักร้อน:</span>
                                        <span class="font-semibold">${quota.vacationLeave}/${maxQuota.vacationLeave} วัน</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ลากิจ:</span>
                                        <span class="font-semibold">${quota.personalLeave}/${maxQuota.personalLeave} วัน</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- สถิติการใช้วันหยุด -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-gray-800 mb-3">สถิติการใช้วันหยุด</h4>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${usedQuota.regularLeave}</div>
                                    <div class="text-xs text-gray-600">วันหยุดปกติ</div>
                                </div>
                                ${maxQuota.specialLeave > 0 ? `
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${usedQuota.specialLeave}</div>
                                    <div class="text-xs text-gray-600">วันหยุดพิเศษ</div>
                                </div>
                                ` : ''}
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600">${usedQuota.sickLeave}</div>
                                    <div class="text-xs text-gray-600">ลาป่วย</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${usedQuota.vacationLeave}</div>
                                    <div class="text-xs text-gray-600">ลาพักร้อน</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-yellow-600">${usedQuota.personalLeave}</div>
                                    <div class="text-xs text-gray-600">ลากิจ</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ประวัติการลาทั้งหมด (แยกตามเดือน) -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-4">ประวัติการลาทั้งหมด (12 เดือนย้อนหลัง)</h4>
                            
                            ${Object.keys(leaveByMonth).length > 0 ? `
                                <div class="space-y-6">
                                    ${Object.entries(leaveByMonth)
                                        .sort(([a], [b]) => b.localeCompare(a)) // เรียงจากใหม่ไปเก่า
                                        .map(([monthKey, leaves]) => {
                                            const [year, month] = monthKey.split('-');
                                            const monthName = monthNames[parseInt(month) - 1];
                                            const isCurrentMonth = monthKey === currentMonthKey;
                                            
                                            return `
                                                <div class="border rounded-lg p-4 ${isCurrentMonth ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'}">
                                                    <h5 class="font-semibold text-lg mb-3 ${isCurrentMonth ? 'text-blue-800' : 'text-gray-800'}">
                                                        ${monthName} ${parseInt(year) + 543} ${isCurrentMonth ? '(เดือนปัจจุบัน)' : ''}
                                                        <span class="text-sm font-normal ml-2">(${leaves.length} วัน)</span>
                                                    </h5>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                                        ${leaves.map(leave => {
                                                            // กำหนดสีตามประเภท
                                                            let bgColor = 'bg-gray-50';
                                                            let textColor = 'text-gray-600';
                                                            let typeColor = 'text-gray-500';
                                                            
                                                            if (leave.status === 'leave') {
                                                                // การลา - ใช้สีตามประเภท
                                                                if (leave.leaveType === 'sick') {
                                                                    bgColor = 'bg-red-50 border-red-200';
                                                                    textColor = 'text-red-800';
                                                                    typeColor = 'text-red-600';
                                                                } else if (leave.leaveType === 'vacation') {
                                                                    bgColor = 'bg-green-50 border-green-200';
                                                                    textColor = 'text-green-800';
                                                                    typeColor = 'text-green-600';
                                                                } else if (leave.leaveType === 'personal') {
                                                                    bgColor = 'bg-yellow-50 border-yellow-200';
                                                                    textColor = 'text-yellow-800';
                                                                    typeColor = 'text-yellow-600';
                                                                } else {
                                                                    bgColor = 'bg-orange-50 border-orange-200';
                                                                    textColor = 'text-orange-800';
                                                                    typeColor = 'text-orange-600';
                                                                }
                                                            } else if (leave.status === 'holiday') {
                                                                // วันหยุด - ใช้สีตามประเภท
                                                                if (leave.leaveType === 'regular') {
                                                                    bgColor = 'bg-blue-50 border-blue-200';
                                                                    textColor = 'text-blue-800';
                                                                    typeColor = 'text-blue-600';
                                                                } else if (leave.leaveType === 'special') {
                                                                    bgColor = 'bg-purple-50 border-purple-200';
                                                                    textColor = 'text-purple-800';
                                                                    typeColor = 'text-purple-600';
                                                                } else {
                                                                    bgColor = 'bg-red-50 border-red-200';
                                                                    textColor = 'text-red-800';
                                                                    typeColor = 'text-red-600';
                                                                }
                                                            }
                                                            
                                                            // แปลงชื่อประเภท
                                                            const leaveTypeNames = {
                                                                'regular': 'หยุดปกติ',
                                                                'special': 'หยุดพิเศษ',
                                                                'sick': 'ลาป่วย',
                                                                'vacation': 'ลาพักร้อน',
                                                                'personal': 'ลากิจ'
                                                            };
                                                            
                                                            return `
                                                                <div class="${bgColor} p-3 rounded border">
                                                                    <div class="font-semibold ${textColor}">${leave.day} ${monthName}</div>
                                                                    <div class="text-sm ${textColor}">${leave.status === 'leave' ? 'ลา' : 'หยุด'}</div>
                                                                    <div class="text-xs ${typeColor} font-medium">${leaveTypeNames[leave.leaveType] || leave.leaveType}</div>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                </div>
                            ` : `
                                <div class="text-gray-500 text-center py-8">ไม่มีประวัติการลา</div>
                            `}
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-2">
                            <button onclick="editEmployee('${empId}')" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">แก้ไขข้อมูล</button>
                            <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ปิด</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing employee details:', error);
                alert('เกิดข้อผิดพลาดในการแสดงรายละเอียดพนักงาน');
            }
        }

        // แสดงฟอร์มลบพนักงานหลายคน
        window.showBulkDeleteForm = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // สร้างรายการพนักงานที่สามารถลบได้ (ไม่รวมตัวเอง)
            const deletableEmployees = Object.entries(employees).filter(([id, emp]) => id !== currentUser);
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">ลบพนักงานหลายคน</h3>
                    <p class="text-gray-600 text-sm mb-4">เลือกพนักงานที่ต้องการลบ (ไม่สามารถลบตัวเองได้)</p>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-2">
                            <span class="font-semibold">เลือกทั้งหมด</span>
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-h-96 overflow-y-auto">
                        ${deletableEmployees.map(([empId, emp]) => `
                            <label class="flex items-start p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="deleteEmployee" value="${empId}" class="mr-3 mt-1">
                                <div class="flex-1">
                                    <div class="font-semibold">${emp.name}</div>
                                    <div class="text-sm text-gray-600">${empId}</div>
                                    <div class="text-sm text-gray-500">${emp.position}</div>
                                    <div class="text-xs text-gray-400">${emp.department}</div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="text-red-800 font-semibold">⚠️ คำเตือน</div>
                        <div class="text-red-700 text-sm mt-1">
                            การลบพนักงานจะลบข้อมูลทั้งหมดรวมถึง:
                            <ul class="list-disc list-inside mt-2">
                                <li>ข้อมูลส่วนตัว</li>
                                <li>โควต้าวันหยุด</li>
                                <li>ตารางทำงาน</li>
                                <li>ประวัติการลา</li>
                            </ul>
                            <strong>การลบไม่สามารถกู้คืนได้!</strong>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ยกเลิก</button>
                        <button onclick="bulkDeleteEmployees()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">ลบพนักงานที่เลือก</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // สลับเลือกทั้งหมด
        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const employeeCheckboxes = document.querySelectorAll('input[name="deleteEmployee"]');
            
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // ลบพนักงานหลายคน
        window.bulkDeleteEmployees = async function() {
            const selectedEmployees = Array.from(document.querySelectorAll('input[name="deleteEmployee"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedEmployees.length === 0) {
                alert('กรุณาเลือกพนักงานที่ต้องการลบ');
                return;
            }
            
            const employeeNames = selectedEmployees.map(id => employees[id].name).join(', ');
            const confirmed = confirm(`ต้องการลบพนักงาน ${selectedEmployees.length} คน หรือไม่?\n\n${employeeNames}\n\nการลบจะไม่สามารถกู้คืนได้`);
            
            if (!confirmed) return;
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const empId of selectedEmployees) {
                    try {
                        // ลบจากระบบ
                        delete employees[empId];
                        await set(ref(null, `employees/${empId}`), null);
                        await set(ref(null, `leaveQuota/${empId}`), null);
                        await set(ref(null, `workSchedule/${empId}`), null);
                        await set(ref(null, `confirmedSchedule/${empId}`), null);
                        
                        // ลบคำขอลาที่เกี่ยวข้อง
                        const requestsRef = ref(null, 'leaveRequests');
                        const requestsSnapshot = await get(requestsRef);
                        const requests = requestsSnapshot.val() || {};
                        
                        for (const [requestId, request] of Object.entries(requests)) {
                            if (request.employeeId === empId) {
                                await set(ref(null, `leaveRequests/${requestId}`), null);
                            }
                        }
                        
                        successCount++;
                    } catch (error) {
                        console.error(`Error deleting employee ${empId}:`, error);
                        errorCount++;
                    }
                }
                
                alert(`ลบพนักงานเรียบร้อยแล้ว\nสำเร็จ: ${successCount} คน${errorCount > 0 ? `\nล้มเหลว: ${errorCount} คน` : ''}`);
                
                closeEmployeeModal();
                await loadEmployeeManagement();
                await loadHRCalendar();
                await loadSummaryStats();
                
            } catch (error) {
                console.error('Error in bulk delete:', error);
                alert('เกิดข้อผิดพลาดในการลบพนักงาน: ' + error.message);
            }
        }

        // ปิด modal
        window.closeEmployeeModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // โหลดปฏิทิน HR
        async function loadHRCalendar() {
            const calendar = document.getElementById('hrCalendar');
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            
            let calendarHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="changeMonth(-1)" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">← เดือนก่อน</button>
                        <h4 class="font-bold">ปฏิทินรวม - ${document.getElementById('monthYear').textContent}</h4>
                        <button onclick="changeMonth(1)" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">เดือนถัดไป →</button>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="inline-block w-3 h-3 bg-green-200 mr-1"></span>ทำงาน
                        <span class="inline-block w-3 h-3 bg-red-200 mr-1 ml-3"></span>หยุด
                        <span class="inline-block w-3 h-3 bg-orange-200 mr-1 ml-3"></span>ลา
                        <span class="inline-block w-3 h-3 bg-yellow-200 mr-1 ml-3"></span>วันหยุดนักขัตฤกษ์
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">อา</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">จ</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">อ</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">พ</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">พฤ</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">ศ</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">ส</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;
            
            // เพิ่มช่องว่าง
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            // สร้างวันในเดือน
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                let workCount = 0;
                let leaveCount = 0;
                let holidayCount = 0;
                let pendingCount = 0;
                
                const isPublicHoliday = publicHolidays[date];
                
                try {
                    for (const empId of Object.keys(employees)) {
                        const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                        const snapshot = await get(scheduleRef);
                        const schedule = snapshot.val() || { status: 'work', type: 'regular' };
                        
                        if (schedule.status === 'work') {
                            workCount++;
                        } else if (schedule.status === 'leave') {
                            leaveCount++;
                        } else if (schedule.status === 'holiday') {
                            holidayCount++;
                        } else if (schedule.status === 'holiday_pending') {
                            pendingCount++;
                        }
                    }
                    
                    // กำหนดสีพื้นหลัง
                    let bgColor = 'bg-white';
                    if (isPublicHoliday) {
                        bgColor = 'bg-yellow-100';
                    } else if (workCount > holidayCount + leaveCount) {
                        bgColor = 'bg-green-50';
                    } else if (holidayCount > workCount) {
                        bgColor = 'bg-red-50';
                    } else if (leaveCount > 0) {
                        bgColor = 'bg-orange-50';
                    }
                    
                    calendarHTML += `
                        <div class="border p-2 min-h-[100px] ${bgColor} cursor-pointer hover:bg-opacity-80 transition-colors" onclick="showDayDetails('${date}')">
                            <div class="font-bold text-sm mb-1">${day}</div>
                            ${isPublicHoliday ? `<div class="text-xs text-blue-600 font-semibold mb-1">${isPublicHoliday}</div>` : ''}
                            <div class="space-y-1">
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                    <span>ทำงาน: ${workCount}</span>
                                </div>
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1"></span>
                                    <span>หยุด: ${holidayCount}</span>
                                </div>
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-1"></span>
                                    <span>ลา: ${leaveCount}</span>
                                </div>
                                ${pendingCount > 0 ? `
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"></span>
                                    <span>รอเลือก: ${pendingCount}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading HR calendar day:', error);
                    calendarHTML += `
                        <div class="border p-2 min-h-[100px] bg-gray-100 cursor-pointer" onclick="showDayDetails('${date}')">
                            <div class="font-bold text-sm">${day}</div>
                            <div class="text-xs text-red-500">ข้อผิดพลาด</div>
                        </div>
                    `;
                }
            }
            
            calendarHTML += `
                </div>
            `;
            calendar.innerHTML = calendarHTML;
        }

        // แสดงรายละเอียดวัน
        window.showDayDetails = async function(date) {
            try {
                const isPublicHoliday = publicHolidays[date];
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                // จัดกลุ่มพนักงานตามแผนกและสถานะ
                const departmentData = {
                    'HR': { work: [], holiday: [], leave: [], pending: [] },
                    'Admin': { work: [], holiday: [], leave: [], pending: [] },
                    'Marketing': { work: [], holiday: [], leave: [], pending: [] },
                    'Telesale': { work: [], holiday: [], leave: [], pending: [] }
                };
                
                let totalCounts = { work: 0, holiday: 0, leave: 0, pending: 0 };
                
                for (const [empId, emp] of Object.entries(employees)) {
                    const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                    const snapshot = await get(scheduleRef);
                    const schedule = snapshot.val() || { status: 'work', type: 'regular' };
                    
                    const empInfo = {
                        id: empId,
                        name: emp.name,
                        position: emp.position,
                        department: emp.department,
                        workTime: emp.workTime,
                        schedule: schedule
                    };
                    
                    // จัดกลุ่มตามแผนกและสถานะ
                    if (departmentData[emp.department]) {
                        if (schedule.status === 'work') {
                            departmentData[emp.department].work.push(empInfo);
                            totalCounts.work++;
                        } else if (schedule.status === 'holiday') {
                            departmentData[emp.department].holiday.push(empInfo);
                            totalCounts.holiday++;
                        } else if (schedule.status === 'leave') {
                            departmentData[emp.department].leave.push(empInfo);
                            totalCounts.leave++;
                        } else if (schedule.status === 'holiday_pending') {
                            departmentData[emp.department].pending.push(empInfo);
                            totalCounts.pending++;
                        }
                    }
                }
                
                const formatDate = new Date(date).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // ฟังก์ชันสร้าง HTML สำหรับพนักงานในแต่ละสถานะ
                const createEmployeeCards = (empList, statusType) => {
                    if (empList.length === 0) return '<div class="text-gray-500 text-sm text-center py-2">ไม่มี</div>';
                    
                    return empList.map(emp => {
                        // กำหนดสีตามแผนก
                        let deptColor = 'bg-gray-100 text-gray-800';
                        switch(emp.department) {
                            case 'HR': deptColor = 'bg-red-100 text-red-800'; break;
                            case 'Admin': deptColor = 'bg-green-100 text-green-800'; break;
                            case 'Marketing': deptColor = 'bg-purple-100 text-purple-800'; break;
                            case 'Telesale': deptColor = 'bg-orange-100 text-orange-800'; break;
                        }
                        
                        return `
                            <div class="bg-white p-3 rounded-lg border shadow-sm">
                                <div class="font-semibold text-sm mb-1">${emp.name}</div>
                                <div class="text-xs text-gray-600 mb-1">${emp.position}</div>
                                <div class="flex items-center justify-between">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${deptColor}">
                                        ${emp.department}
                                    </span>
                                    <span class="text-xs text-gray-500">${emp.workTime}</span>
                                </div>
                                ${statusType === 'work' && isPublicHoliday ? '<div class="text-xs text-green-600 font-semibold mt-1">💰 ค่าแรง 2 เท่า</div>' : ''}
                                ${statusType === 'leave' && emp.schedule.leaveType ? `
                                    <div class="text-xs text-orange-600 font-semibold mt-1">
                                        ${emp.schedule.leaveType === 'sick' ? '🤒 ลาป่วย' : 
                                          emp.schedule.leaveType === 'vacation' ? '🏖️ ลาพักร้อน' : 
                                          emp.schedule.leaveType === 'personal' ? '📋 ลากิจ' : 
                                          emp.schedule.leaveType}
                                    </div>
                                ` : ''}
                                ${statusType === 'holiday' && emp.schedule.leaveType ? `
                                    <div class="text-xs text-red-600 font-semibold mt-1 flex items-center">
                                        <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1"></span>
                                        <span>หยุด</span>
                                    </div>
                                ` : ''}
                                ${statusType === 'pending' ? '<div class="text-xs text-yellow-600 font-semibold mt-1">⏳ ยังไม่เลือก</div>' : ''}
                            </div>
                        `;
                    }).join('');
                };
                
                // สร้าง HTML สำหรับแต่ละแผนก
                const createDepartmentSection = (deptName, deptData) => {
                    const totalInDept = deptData.work.length + deptData.holiday.length + deptData.leave.length + deptData.pending.length;
                    if (totalInDept === 0) return '';
                    
                    let deptColor = 'border-gray-200 bg-gray-50';
                    let deptIcon = '🏢';
                    switch(deptName) {
                        case 'HR': 
                            deptColor = 'border-red-200 bg-red-50'; 
                            deptIcon = '👥'; 
                            break;
                        case 'Admin': 
                            deptColor = 'border-green-200 bg-green-50'; 
                            deptIcon = '🖥️'; 
                            break;
                        case 'Marketing': 
                            deptColor = 'border-purple-200 bg-purple-50'; 
                            deptIcon = '📢'; 
                            break;
                        case 'Telesale': 
                            deptColor = 'border-orange-200 bg-orange-50'; 
                            deptIcon = '📞'; 
                            break;
                    }
                    
                    return `
                        <div class="border rounded-lg p-4 ${deptColor} mb-4">
                            <h4 class="font-bold text-lg mb-4 flex items-center">
                                <span class="mr-2">${deptIcon}</span>
                                ${deptName} (${totalInDept} คน)
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <!-- ทำงาน -->
                                ${deptData.work.length > 0 ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-green-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        ทำงาน (${deptData.work.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.work, 'work')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- หยุด -->
                                ${deptData.holiday.length > 0 ? `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-red-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                        หยุด (${deptData.holiday.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.holiday, 'holiday')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- ลา -->
                                ${deptData.leave.length > 0 ? `
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-orange-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
                                        ลา (${deptData.leave.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.leave, 'leave')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- รอเลือก -->
                                ${deptData.pending.length > 0 ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-yellow-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                        รอเลือก (${deptData.pending.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.pending, 'pending')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                };
                
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-7xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold">📅 รายละเอียดวันที่ ${formatDate}</h3>
                            <button onclick="closeDayDetailsModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                        </div>
                        
                        ${isPublicHoliday ? `
                        <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 mb-6">
                            <div class="font-semibold text-yellow-800 text-lg">🎉 ${isPublicHoliday}</div>
                            <div class="text-sm text-yellow-700 mt-1">วันหยุดนักขัตฤกษ์ - พนักงานสามารถเลือกทำงาน (ได้ค่าแรง 2 เท่า) หรือหยุด</div>
                        </div>
                        ` : ''}
                        
                        <!-- สรุปรวม -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-lg mb-3">📊 สรุปรวมทั้งบริษัท</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-green-100 border border-green-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-green-600">${totalCounts.work}</div>
                                    <div class="text-sm text-green-700 font-semibold">ทำงาน</div>
                                </div>
                                <div class="bg-red-100 border border-red-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-red-600">${totalCounts.holiday}</div>
                                    <div class="text-sm text-red-700 font-semibold">หยุด</div>
                                </div>
                                <div class="bg-orange-100 border border-orange-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-orange-600">${totalCounts.leave}</div>
                                    <div class="text-sm text-orange-700 font-semibold">ลา</div>
                                </div>
                                <div class="bg-blue-100 border border-blue-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-blue-600">${Object.keys(employees).length}</div>
                                    <div class="text-sm text-blue-700 font-semibold">รวมทั้งหมด</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- รายละเอียดตามแผนก -->
                        <div class="space-y-4">
                            ${createDepartmentSection('HR', departmentData.HR)}
                            ${createDepartmentSection('Admin', departmentData.Admin)}
                            ${createDepartmentSection('Marketing', departmentData.Marketing)}
                            ${createDepartmentSection('Telesale', departmentData.Telesale)}
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="closeDayDetailsModal()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold">ปิด</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error showing day details:', error);
                alert('เกิดข้อผิดพลาดในการแสดงรายละเอียด');
            }
        }

        // ปิด modal รายละเอียดวัน
        window.closeDayDetailsModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // ดูเอกสารแนบ
        window.viewDocument = function(requestKey) {
            // จำลองการแสดงเอกสาร - ในระบบจริงจะดึงไฟล์จาก server
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-lg font-bold">เอกสารแนบ</h3>
                        <button onclick="closeDocumentModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="p-6">
                        <!-- จำลองการแสดงเอกสาร -->
                        <div class="text-center mb-4">
                            <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8">
                                <!-- จำลองใบรับรองแพทย์ -->
                                <div class="bg-white border rounded-lg p-6 shadow-sm max-w-md mx-auto">
                                    <div class="text-center mb-4">
                                        <div class="text-blue-600 font-bold text-lg">🏥 โรงพยาบาลตัวอย่าง</div>
                                        <div class="text-sm text-gray-600">ใบรับรองแพทย์</div>
                                    </div>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between">
                                            <span class="font-semibold">ชื่อผู้ป่วย:</span>
                                            <span>นาย/นาง ตัวอย่าง</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">วันที่ตรวจ:</span>
                                            <span>${new Date().toLocaleDateString('th-TH')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">อาการ:</span>
                                            <span>ไข้หวัด</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">ควรพักงาน:</span>
                                            <span class="text-red-600 font-semibold">1-2 วัน</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 pt-4 border-t text-center">
                                        <div class="text-xs text-gray-500">แพทย์ผู้รักษา</div>
                                        <div class="font-semibold">นพ.ตัวอย่าง ใจดี</div>
                                        <div class="text-xs text-gray-500">ใบอนุญาตประกอบวิชาชีพเวชกรรม เลขที่ 12345</div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 text-sm text-gray-600">
                                    <div class="font-semibold">หมายเหตุ:</div>
                                    <div>นี่เป็นตัวอย่างการแสดงเอกสาร ในระบบจริงจะแสดงไฟล์ที่พนักงานอัปโหลด</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ตัวเลือกการดำเนินการ -->
                        <div class="flex justify-center space-x-4 mt-6">
                            <button onclick="downloadDocument('${requestKey}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center">
                                <span class="mr-2">💾</span> ดาวน์โหลด
                            </button>
                            <button onclick="printDocument('${requestKey}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                                <span class="mr-2">🖨️</span> พิมพ์
                            </button>
                            <button onclick="closeDocumentModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                ปิด
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ดูรายละเอียดคำขอลา
        window.viewLeaveDetails = async function(requestKey) {
            try {
                const requestRef = ref(null, `leaveRequests/${requestKey}`);
                const snapshot = await get(requestRef);
                const request = snapshot.val();
                
                if (!request) {
                    alert('ไม่พบคำขอลา');
                    return;
                }
                
                const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // กำหนดไอคอนตามประเภทการลา
                let leaveIcon = '📋';
                if (request.leaveType === 'ลาป่วย') leaveIcon = '🤒';
                else if (request.leaveType === 'ลาพักร้อน') leaveIcon = '🏖️';
                else if (request.leaveType === 'ลากิจ') leaveIcon = '📋';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-xl font-bold flex items-center">
                                <span class="mr-2">${leaveIcon}</span>
                                รายละเอียดคำขอลา
                            </h3>
                            <button onclick="closeDocumentModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ข้อมูลพื้นฐาน -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-bold text-blue-800 mb-3">ข้อมูลผู้ขอลา</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-semibold">ชื่อ:</span> ${request.employeeName}</div>
                                        <div><span class="font-semibold">รหัสพนักงาน:</span> ${request.employeeId || 'ไม่ระบุ'}</div>
                                        <div><span class="font-semibold">วันที่ส่งคำขอ:</span> ${requestDate}</div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <h4 class="font-bold text-green-800 mb-3">รายละเอียดการลา</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-semibold">ประเภท:</span> ${request.leaveType}</div>
                                        <div><span class="font-semibold">วันที่เริ่มต้น:</span> ${request.startDate}</div>
                                        <div><span class="font-semibold">วันที่สิ้นสุด:</span> ${request.endDate}</div>
                                        <div><span class="font-semibold">แจ้งล่วงหน้า:</span> ${request.advanceNoticeDays || 0} วัน</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- เหตุผล -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-2">เหตุผลการลา</h4>
                                <div class="bg-gray-50 border rounded-lg p-4">
                                    <p class="text-gray-700">${request.reason}</p>
                                </div>
                            </div>
                            
                            <!-- เอกสารแนบ -->
                            ${request.hasDocument ? `
                                <div class="mb-6">
                                    <h4 class="font-bold text-gray-800 mb-2">เอกสารแนบ</h4>
                                    <div class="bg-gray-50 border rounded-lg p-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <span class="mr-2">📎</span>
                                                <div>
                                                    <div class="font-semibold">${request.documentName || 'เอกสารแนบ'}</div>
                                                    <div class="text-sm text-gray-600">
                                                        ${request.leaveType === 'ลาป่วย' ? 'ใบรับรองแพทย์' : 
                                                          request.leaveType === 'ลากิจ' ? 'เอกสารตามธุระ' : 'เอกสารประกอบ'}
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="viewDocument('${requestKey}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                                👁️ ดูเอกสาร
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="mb-6">
                                    <h4 class="font-bold text-gray-800 mb-2">เอกสารแนบ</h4>
                                    <div class="bg-gray-50 border rounded-lg p-4 text-center text-gray-500">
                                        ไม่มีเอกสารแนบ
                                    </div>
                                </div>
                            `}
                            
                            <!-- การตรวจสอบข้อกำหนด -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-2">การตรวจสอบข้อกำหนด</h4>
                                <div class="space-y-2">
                                    <!-- ตรวจสอบการแจ้งล่วงหน้า -->
                                    <div class="flex items-center">
                                        ${(request.leaveType === 'ลาป่วย') ? 
                                            '<span class="text-green-600 mr-2">✅</span><span class="text-green-700">ลาป่วยไม่ต้องแจ้งล่วงหน้า</span>' :
                                            (request.leaveType === 'ลาพักร้อน' && request.advanceNoticeDays >= 7) ? 
                                            '<span class="text-green-600 mr-2">✅</span><span class="text-green-700">แจ้งล่วงหน้าเพียงพอ (ต้องการ 7 วัน)</span>' :
                                            (request.leaveType === 'ลากิจ' && request.advanceNoticeDays >= 3) ? 
                                            '<span class="text-green-600 mr-2">✅</span><span class="text-green-700">แจ้งล่วงหน้าเพียงพอ (ต้องการ 3 วัน)</span>' :
                                            '<span class="text-red-600 mr-2">❌</span><span class="text-red-700">แจ้งล่วงหน้าไม่เพียงพอ</span>'
                                        }
                                    </div>
                                    
                                    <!-- ตรวจสอบเอกสาร -->
                                    <div class="flex items-center">
                                        ${(request.leaveType === 'ลาป่วย' || request.leaveType === 'ลากิจ') ? 
                                            (request.hasDocument ? 
                                                '<span class="text-green-600 mr-2">✅</span><span class="text-green-700">มีเอกสารแนบครบถ้วน</span>' :
                                                '<span class="text-red-600 mr-2">❌</span><span class="text-red-700">ไม่มีเอกสารแนบ (จำเป็นต้องมี)</span>'
                                            ) :
                                            '<span class="text-green-600 mr-2">✅</span><span class="text-green-700">ไม่จำเป็นต้องแนบเอกสาร</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ปุ่มดำเนินการ -->
                            ${request.status === 'pending' ? `
                                <div class="flex justify-center space-x-4 pt-4 border-t">
                                    <button onclick="approveLeave('${requestKey}'); closeDocumentModal();" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold flex items-center">
                                        <span class="mr-2">✅</span> อนุมัติคำขอนี้
                                    </button>
                                    <button onclick="rejectLeave('${requestKey}'); closeDocumentModal();" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold flex items-center">
                                        <span class="mr-2">❌</span> ไม่อนุมัติ
                                    </button>
                                    <button onclick="closeDocumentModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold">
                                        ปิด
                                    </button>
                                </div>
                            ` : `
                                <div class="flex justify-center pt-4 border-t">
                                    <button onclick="closeDocumentModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold">
                                        ปิด
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing leave details:', error);
                alert('เกิดข้อผิดพลาดในการแสดงรายละเอียด');
            }
        }

        // ปิด modal เอกสาร
        window.closeDocumentModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // ดาวน์โหลดเอกสาร (จำลอง)
        window.downloadDocument = function(requestKey) {
            alert('ฟีเจอร์ดาวน์โหลดเอกสาร\n\nในระบบจริงจะดาวน์โหลดไฟล์ที่พนักงานอัปโหลด');
        }

        // พิมพ์เอกสาร (จำลอง)
        window.printDocument = function(requestKey) {
            alert('ฟีเจอร์พิมพ์เอกสาร\n\nในระบบจริงจะเปิดหน้าต่างพิมพ์เอกสาร');
        }

        // ยืนยันการเลือกเดือน
        window.confirmMonthSelection = async function() {
            try {
                console.log('=== Starting confirmMonthSelection ===');
                console.log('Current user:', currentUser);
                console.log('Current month/year:', currentMonth, currentYear);
                
                if (!currentUser) {
                    console.error('No current user found');
                    alert('ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่');
                    return;
                }
                
                if (!employees || !employees[currentUser]) {
                    console.error('Employee data not found for:', currentUser);
                    alert('ไม่พบข้อมูลพนักงาน กรุณาเข้าสู่ระบบใหม่');
                    return;
                }
                
                const confirmed = confirm('ต้องการยืนยันการเลือกตารางงานสำหรับเดือนนี้หรือไม่?\n\nหลังจากยืนยันแล้วจะไม่สามารถแก้ไขได้');
                if (!confirmed) {
                    console.log('User cancelled confirmation');
                    return;
                }
                
                // บันทึกสถานะว่ายืนยันแล้ว
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                console.log('Saving confirmation for month:', monthKey, 'user:', currentUser);
                
                const confirmationData = {
                    confirmed: true,
                    confirmedDate: new Date().toISOString(),
                    employeeId: currentUser,
                    employeeName: employees[currentUser].name || 'Unknown',
                    month: currentMonth,
                    year: currentYear
                };
                
                console.log('Confirmation data to save:', confirmationData);
                
                const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
                await set(confirmRef, confirmationData);
                console.log('Confirmation saved successfully');
                
                alert('ยืนยันการเลือกตารางงานเรียบร้อยแล้ว\nตารางงานจะถูกล็อคและไม่สามารถแก้ไขได้');
                
                // รีโหลดปฏิทินเพื่ออัปเดตปุ่ม
                await loadCalendar();
                console.log('Calendar reloaded after confirmation');
                
            } catch (error) {
                console.error('Error in confirmMonthSelection:', error);
                alert('เกิดข้อผิดพลาดในการยืนยัน: ' + error.message);
            }
        }

        // แก้ไขการเลือกเดือน
        window.editMonthSelection = async function() {
            try {
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
                const snapshot = await get(confirmRef);
                
                if (snapshot.exists()) {
                    const confirmed = confirm('ตารางงานเดือนนี้ได้รับการยืนยันแล้ว\n\nต้องการยกเลิกการยืนยันเพื่อแก้ไขหรือไม่?');
                    if (confirmed) {
                        await set(confirmRef, null);
                        alert('ยกเลิกการยืนยันแล้ว สามารถแก้ไขตารางงานได้');
                        await loadCalendar();
                    }
                } else {
                    alert('ตารางงานเดือนนี้ยังไม่ได้รับการยืนยัน สามารถแก้ไขได้ตามปกติ');
                }
            } catch (error) {
                console.error('Error editing month selection:', error);
                alert('เกิดข้อผิดพลาดในการแก้ไข');
            }
        }

        // อัปเดตกะสำหรับเดือน
        function updateShiftsForMonth(year, month) {
            console.log(`Updating shifts for ${year}-${month + 1}`);
            
            // อัปเดตกะสำหรับพนักงาน Admin ทั้งหมด
            for (const empId of Object.keys(employees)) {
                shiftSystem.updateEmployeeShift(empId, year, month);
            }
            
            console.log('Shifts updated:', employees);
        }

        // เปลี่ยนเดือน
        window.changeMonth = function(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            // อัปเดตกะสำหรับเดือนใหม่
            updateShiftsForMonth(currentYear, currentMonth);
            
            generateWorkSchedule(currentYear, currentMonth);
            loadCalendar();
            if (currentUser && employees[currentUser].role === 'HR') {
                loadHRCalendar();
                loadEmployeeManagement(); // รีเฟรชข้อมูลพนักงานเพื่อแสดงกะใหม่
            }
        }

        // ออกจากระบบ
        window.logout = function() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('hrPanel').classList.add('hidden');
        }

        // โหลดการจัดการกะ
        async function loadShiftManagement() {
            try {
                const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                                  'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                
                // แยกพนักงาน Admin ตามทีม
                const adminEmployees = Object.entries(employees).filter(([id, emp]) => emp.department === 'Admin');
                const team1 = adminEmployees.filter(([id, emp]) => emp.team === 'Team1');
                const team2 = adminEmployees.filter(([id, emp]) => emp.team === 'Team2');
                const manager = adminEmployees.filter(([id, emp]) => emp.team === 'Manager');
                
                let shiftHTML = `
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- สถานะกะปัจจุบัน -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <div class="mb-4">
                                <h4 class="font-bold text-blue-800">สถานะกะปัจจุบัน - ${monthNames[currentMonth]} ${currentYear + 543}</h4>
                            </div>
                            
                            <!-- Manager -->
                            <div class="mb-4">
                                <h5 class="font-semibold text-gray-700 mb-2">หัวหน้าแผนก</h5>
                                <div class="bg-white p-3 rounded border">
                                    ${manager.map(([id, emp]) => `
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold">${emp.name}</div>
                                                <div class="text-sm text-gray-600">${emp.position}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold text-blue-600">กะเช้า (คงที่)</div>
                                                <div class="text-sm text-gray-500">${emp.workTime}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Team 1 -->
                            <div class="mb-4">
                                <div class="mb-2">
                                    <h5 class="font-semibold text-gray-700">Admin Team 1</h5>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    ${team1.map(([id, emp]) => `
                                        <div class="flex justify-between items-center mb-2 last:mb-0">
                                            <div>
                                                <div class="font-semibold">${emp.name}</div>
                                                <div class="text-sm text-gray-600">${emp.position}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold ${emp.shift === 'morning' ? 'text-green-600' : 'text-orange-600'}">
                                                    ${shiftSystem.shifts[emp.shift].name}
                                                </div>
                                                <div class="text-sm text-gray-500">${emp.workTime}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Team 2 -->
                            <div>
                                <div class="mb-2">
                                    <h5 class="font-semibold text-gray-700">Admin Team 2</h5>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    ${team2.map(([id, emp]) => `
                                        <div class="flex justify-between items-center mb-2 last:mb-0">
                                            <div>
                                                <div class="font-semibold">${emp.name}</div>
                                                <div class="text-sm text-gray-600">${emp.position}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold ${emp.shift === 'morning' ? 'text-green-600' : 'text-orange-600'}">
                                                    ${shiftSystem.shifts[emp.shift].name}
                                                </div>
                                                <div class="text-sm text-gray-500">${emp.workTime}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- ตารางสลับกะ -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h4 class="font-bold text-green-800 mb-4">ตารางสลับกะอัตโนมัติ</h4>
                            
                            <div class="mb-4">
                                <div class="text-sm text-gray-600 mb-2">
                                    <strong>หลักการสลับกะ:</strong>
                                </div>
                                <ul class="text-sm text-gray-600 space-y-1 mb-4">
                                    <li>• Team 1: เดือนคู่ = กะเช้า, เดือนคี่ = กะบ่าย</li>
                                    <li>• Team 2: เดือนคู่ = กะบ่าย, เดือนคี่ = กะเช้า</li>
                                    <li>• หัวหน้าแผนก: กะเช้าคงที่</li>
                                </ul>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="px-3 py-2 text-left">เดือน</th>
                                            <th class="px-3 py-2 text-center">Team 1</th>
                                            <th class="px-3 py-2 text-center">Team 2</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                // แสดงตารางสลับกะ 12 เดือน
                for (let month = 0; month < 12; month++) {
                    const team1Shift = shiftSystem.getShiftForMonth('Team1', currentYear, month);
                    const team2Shift = shiftSystem.getShiftForMonth('Team2', currentYear, month);
                    const isCurrentMonth = month === currentMonth;
                    
                    shiftHTML += `
                        <tr class="${isCurrentMonth ? 'bg-yellow-100 font-semibold' : 'bg-white'}">
                            <td class="px-3 py-2 border">${monthNames[month]} ${isCurrentMonth ? '(ปัจจุบัน)' : ''}</td>
                            <td class="px-3 py-2 border text-center">
                                <span class="px-2 py-1 rounded text-xs ${team1Shift === 'morning' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                    ${shiftSystem.shifts[team1Shift].name}
                                </span>
                            </td>
                            <td class="px-3 py-2 border text-center">
                                <span class="px-2 py-1 rounded text-xs ${team2Shift === 'morning' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                    ${shiftSystem.shifts[team2Shift].name}
                                </span>
                            </td>
                        </tr>
                    `;
                }
                
                shiftHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    

                `;
                
                const shiftElement = document.getElementById('shiftManagement');
                if (shiftElement) {
                    shiftElement.innerHTML = shiftHTML;
                }
            } catch (error) {
                console.error('Error loading shift management:', error);
                const shiftElement = document.getElementById('shiftManagement');
                if (shiftElement) {
                    shiftElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูลกะ</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        // เปลี่ยนกะของทีม
        window.changeTeamShift = async function(team) {
            try {
                console.log('=== Starting changeTeamShift ===');
                console.log('Team:', team);
                console.log('Current employees object:', employees);
                console.log('Available employee IDs:', Object.keys(employees));
                
                if (!team) {
                    console.error('No team specified');
                    alert('ไม่ได้ระบุทีม');
                    return;
                }
                
                const confirmed = confirm(`ต้องการเปลี่ยนกะของ ${team} หรือไม่?\n\nการเปลี่ยนแปลงจะมีผลทันที`);
                if (!confirmed) {
                    console.log('User cancelled team shift change');
                    return;
                }
                
                // หาพนักงานในทีม - ใช้วิธีที่ยืดหยุ่นกว่า
                const teamMembers = Object.entries(employees).filter(([id, emp]) => {
                    console.log(`Checking employee ${id}:`, emp);
                    const isAdminDept = emp.department === 'Admin';
                    
                    // ตรวจสอบทีมจากหลายแหล่ง
                    let isCorrectTeam = false;
                    if (emp.team === team) {
                        isCorrectTeam = true;
                    } else if (team === 'Team1' && (emp.position.includes('Team 1') || emp.team === 'Team1')) {
                        isCorrectTeam = true;
                    } else if (team === 'Team2' && (emp.position.includes('Team 2') || emp.team === 'Team2')) {
                        isCorrectTeam = true;
                    }
                    
                    console.log(`  - Admin dept: ${isAdminDept}, Correct team: ${isCorrectTeam}`);
                    return isAdminDept && isCorrectTeam;
                });
                
                console.log('Team members found:', teamMembers.length);
                console.log('Team members details:', teamMembers);
                
                if (teamMembers.length === 0) {
                    console.error(`No team members found for team: ${team}`);
                    alert(`ไม่พบพนักงานในทีม ${team}\n\nกรุณาตรวจสอบข้อมูลพนักงานในแท็บ "จัดการพนักงาน"`);
                    return;
                }
                
                let successCount = 0;
                for (const [empId, emp] of teamMembers) {
                    try {
                        // สลับกะ
                        const currentShift = emp.shift || 'morning';
                        const newShift = currentShift === 'morning' ? 'evening' : 'morning';
                        const newWorkTime = shiftSystem.shifts[newShift].time;
                        
                        console.log(`Updating ${empId} (${emp.name}) from ${currentShift} to ${newShift}`);
                        
                        // อัปเดตข้อมูลพนักงานในหน่วยความจำ
                        employees[empId].shift = newShift;
                        employees[empId].workTime = newWorkTime;
                        
                        // อัปเดตตำแหน่งให้แสดงกะใหม่
                        if (emp.team === 'Team1' || emp.position.includes('Team 1')) {
                            employees[empId].position = `Admin Team 1 (${shiftSystem.shifts[newShift].name})`;
                        } else if (emp.team === 'Team2' || emp.position.includes('Team 2')) {
                            employees[empId].position = `Admin Team 2 (${shiftSystem.shifts[newShift].name})`;
                        }
                        
                        // บันทึกลงฐานข้อมูล
                        await update(ref(null, `employees/${empId}`), {
                            shift: newShift,
                            workTime: newWorkTime,
                            position: employees[empId].position
                        });
                        
                        console.log(`Successfully updated ${empId}`);
                        successCount++;
                    } catch (updateError) {
                        console.error(`Error updating ${empId}:`, updateError);
                    }
                }
                
                console.log(`Updated ${successCount}/${teamMembers.length} team members`);
                alert(`เปลี่ยนกะของ ${team} เรียบร้อยแล้ว (${successCount}/${teamMembers.length} คน)`);
                
                // รีเฟรชหน้าจอ
                await loadShiftManagement();
                await loadEmployeeManagement();
                
            } catch (error) {
                console.error('Error in changeTeamShift:', error);
                alert('เกิดข้อผิดพลาดในการเปลี่ยนกะ: ' + error.message);
            }
        }
        
        // สลับกะระหว่างทีม
        window.switchTeamShifts = async function() {
            try {
                console.log('=== Starting switchTeamShifts ===');
                console.log('Current employees:', employees);
                console.log('Available employee IDs:', Object.keys(employees));
                
                const confirmed = confirm('ต้องการสลับกะระหว่าง Team 1 และ Team 2 หรือไม่?\n\nการเปลี่ยนแปลงจะมีผลทันที');
                if (!confirmed) {
                    console.log('User cancelled team shifts switch');
                    return;
                }
                
                // หาพนักงานทั้งสองทีม - ใช้วิธีที่ยืดหยุ่นกว่า
                const team1Members = Object.entries(employees).filter(([id, emp]) => {
                    console.log(`Checking Team1 employee ${id}:`, emp);
                    const isAdminDept = emp.department === 'Admin';
                    const isTeam1 = emp.team === 'Team1' || emp.position.includes('Team 1');
                    console.log(`  - Admin dept: ${isAdminDept}, Team1: ${isTeam1}`);
                    return isAdminDept && isTeam1;
                });
                const team2Members = Object.entries(employees).filter(([id, emp]) => {
                    console.log(`Checking Team2 employee ${id}:`, emp);
                    const isAdminDept = emp.department === 'Admin';
                    const isTeam2 = emp.team === 'Team2' || emp.position.includes('Team 2');
                    console.log(`  - Admin dept: ${isAdminDept}, Team2: ${isTeam2}`);
                    return isAdminDept && isTeam2;
                });
                
                console.log('Team1 members found:', team1Members.length);
                console.log('Team1 members details:', team1Members);
                console.log('Team2 members found:', team2Members.length);
                console.log('Team2 members details:', team2Members);
                
                if (team1Members.length === 0 && team2Members.length === 0) {
                    console.error('No Admin team members found');
                    alert('ไม่พบพนักงาน Admin ในระบบ\n\nกรุณาตรวจสอบข้อมูลพนักงานในแท็บ "จัดการพนักงาน"');
                    return;
                }
                
                let successCount = 0;
                let totalCount = team1Members.length + team2Members.length;
                
                // สลับกะ Team 1
                for (const [empId, emp] of team1Members) {
                    try {
                        const currentShift = emp.shift || 'morning';
                        const newShift = currentShift === 'morning' ? 'evening' : 'morning';
                        const newWorkTime = shiftSystem.shifts[newShift].time;
                        
                        console.log(`Switching Team1 ${empId} (${emp.name}) from ${currentShift} to ${newShift}`);
                        
                        employees[empId].shift = newShift;
                        employees[empId].workTime = newWorkTime;
                        employees[empId].position = `Admin Team 1 (${shiftSystem.shifts[newShift].name})`;
                        
                        await update(ref(null, `employees/${empId}`), {
                            shift: newShift,
                            workTime: newWorkTime,
                            position: employees[empId].position
                        });
                        
                        console.log(`Successfully updated Team1 ${empId}`);
                        successCount++;
                    } catch (updateError) {
                        console.error(`Error updating Team1 ${empId}:`, updateError);
                    }
                }
                
                // สลับกะ Team 2
                for (const [empId, emp] of team2Members) {
                    try {
                        const currentShift = emp.shift || 'evening';
                        const newShift = currentShift === 'morning' ? 'evening' : 'morning';
                        const newWorkTime = shiftSystem.shifts[newShift].time;
                        
                        console.log(`Switching Team2 ${empId} (${emp.name}) from ${currentShift} to ${newShift}`);
                        
                        employees[empId].shift = newShift;
                        employees[empId].workTime = newWorkTime;
                        employees[empId].position = `Admin Team 2 (${shiftSystem.shifts[newShift].name})`;
                        
                        await update(ref(null, `employees/${empId}`), {
                            shift: newShift,
                            workTime: newWorkTime,
                            position: employees[empId].position
                        });
                        
                        console.log(`Successfully updated Team2 ${empId}`);
                        successCount++;
                    } catch (updateError) {
                        console.error(`Error updating Team2 ${empId}:`, updateError);
                    }
                }
                
                console.log(`Updated ${successCount}/${totalCount} team members`);
                alert(`สลับกะระหว่างทีมเรียบร้อยแล้ว (${successCount}/${totalCount} คน)`);
                
                // รีเฟรชหน้าจอ
                await loadShiftManagement();
                await loadEmployeeManagement();
                
            } catch (error) {
                console.error('Error in switchTeamShifts:', error);
                alert('เกิดข้อผิดพลาดในการสลับกะ: ' + error.message);
            }
        }
        
        // อัปเดตกะทั้งหมดตามระบบอัตโนมัติ
        window.updateAllShifts = async function() {
            try {
                console.log('=== Starting updateAllShifts ===');
                console.log('Current employees:', employees);
                console.log('Current month/year:', currentMonth, currentYear);
                console.log('Available employee IDs:', Object.keys(employees));
                
                const confirmed = confirm('ต้องการอัปเดตกะทั้งหมดตามระบบอัตโนมัติหรือไม่?\n\nกะจะถูกกำหนดใหม่ตามเดือนปัจจุบัน');
                if (!confirmed) {
                    console.log('User cancelled update all shifts');
                    return;
                }
                
                // อัปเดตกะในหน่วยความจำก่อน
                updateShiftsForMonth(currentYear, currentMonth);
                console.log('Shifts updated in memory');
                console.log('Updated employees object:', employees);
                
                // บันทึกข้อมูลที่อัปเดต
                let updatedCount = 0;
                let totalAdminCount = 0;
                
                for (const [empId, emp] of Object.entries(employees)) {
                    console.log(`Processing employee ${empId}:`, emp);
                    
                    // ตรวจสอบพนักงาน Admin ทั้งหมด (รวมทั้งที่มี team และไม่มี team)
                    if (emp.department === 'Admin') {
                        totalAdminCount++;
                        console.log(`Updating ${empId} (${emp.name}) shift to ${emp.shift}, workTime: ${emp.workTime}`);
                        
                        try {
                            await update(ref(null, `employees/${empId}`), {
                                shift: emp.shift,
                                workTime: emp.workTime,
                                position: emp.position
                            });
                            updatedCount++;
                            console.log(`Successfully updated ${empId}`);
                        } catch (updateError) {
                            console.error(`Error updating ${empId}:`, updateError);
                        }
                    } else {
                        console.log(`Skipping ${empId} - not Admin (dept: ${emp.department})`);
                    }
                }
                
                console.log(`Updated ${updatedCount}/${totalAdminCount} Admin employees`);
                alert(`อัปเดตกะทั้งหมดเรียบร้อยแล้ว (${updatedCount}/${totalAdminCount} คน)`);
                
                // รีเฟรชหน้าจอ
                await loadShiftManagement();
                await loadEmployeeManagement();
                
            } catch (error) {
                console.error('Error in updateAllShifts:', error);
                alert('เกิดข้อผิดพลาดในการอัปเดตกะ: ' + error.message);
            }
        }

        // สลับแท็บ HR
        window.switchHRTab = function(tabName) {
            // ซ่อนเนื้อหาทั้งหมด
            document.getElementById('approvalsContent').classList.add('hidden');
            document.getElementById('employeesContent').classList.add('hidden');
            document.getElementById('calendarContent').classList.add('hidden');
            document.getElementById('shiftsContent').classList.add('hidden');
            
            // รีเซ็ตสไตล์แท็บ
            document.getElementById('approvalsTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('employeesTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('calendarTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('shiftsTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            
            // แสดงเนื้อหาที่เลือกและเปลี่ยนสไตล์แท็บ
            if (tabName === 'approvals') {
                document.getElementById('approvalsContent').classList.remove('hidden');
                document.getElementById('approvalsTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadPendingLeaveRequests();
            } else if (tabName === 'employees') {
                document.getElementById('employeesContent').classList.remove('hidden');
                document.getElementById('employeesTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadEmployeeManagement();
            } else if (tabName === 'calendar') {
                document.getElementById('calendarContent').classList.remove('hidden');
                document.getElementById('calendarTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadHRCalendar();
            } else if (tabName === 'shifts') {
                document.getElementById('shiftsContent').classList.remove('hidden');
                document.getElementById('shiftsTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadShiftManagement();
            }
            
            // รีเฟรชสถิติเมื่อสลับแท็บ
            loadSummaryStats();
        }

        // Event listeners - รอให้ DOM โหลดเสร็จก่อน
        document.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('loginBtn');
            const submitLeaveBtn = document.getElementById('submitLeaveBtn');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
            }
            
            if (submitLeaveBtn) {
                submitLeaveBtn.addEventListener('click', submitLeaveRequest);
            }
            
            // เพิ่ม Enter key support สำหรับการล็อกอิน
            const empIdInput = document.getElementById('empId');
            if (empIdInput) {
                empIdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
            
            // เริ่มต้นฟอร์มการลา
            if (typeof updateLeaveRequirements === 'function') {
                updateLeaveRequirements();
            }
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- หน้าล็อกอิน -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold text-center mb-6">ระบบจัดการตารางเข้างาน</h1>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">รหัสพนักงาน</label>
                <input type="text" id="empId" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="กรอกรหัสพนักงาน">
                <div class="mt-2 text-sm text-gray-600">
                    <p class="font-semibold">รหัสทดสอบ:</p>
                    <p><strong>HR001</strong> - HR (สำหรับ HR)</p>
                    <p><strong>MA001</strong> - อามินตรา นามภักดิ์ (Manager)</p>
                    <p><strong>EA001</strong> - กุลธิตา ทองสิมา (พนักงาน)</p>
                    <p><strong>ET001</strong> - ศรีเดือน อินเท่ง (Telesale)</p>
                </div>
            </div>
            <button id="loginBtn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-200">เข้าสู่ระบบ</button>
        </div>
    </div>

    <!-- หน้าหลัก -->
    <div id="mainApp" class="hidden">
        <nav class="bg-blue-600 text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">ระบบจัดการตารางเข้างาน</h1>
                <div class="flex items-center space-x-4">
                    <span id="userName"></span>
                    <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">ออกจากระบบ</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-4">
            <!-- ปฏิทิน -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">← เดือนก่อน</button>
                    <h2 id="monthYear" class="text-xl font-bold"></h2>
                    <button onclick="changeMonth(1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">เดือนถัดไป →</button>
                </div>
                <div id="calendar"></div>
                
                <!-- ปุ่มยืนยันและแก้ไข -->
                <div class="flex justify-center space-x-4 mt-6 pt-4 border-t">
                    <button id="confirmBtn" onclick="confirmMonthSelection()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold shadow-lg transition-all duration-200" style="display: inline-block;">
                        ✅ ยืนยันตารางงานเดือนนี้
                    </button>
                    <button id="editBtn" onclick="editMonthSelection()" class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 font-semibold shadow-lg transition-all duration-200" style="display: none;">
                        🔓 ยกเลิกการยืนยัน
                    </button>
                </div>
                
                <div class="mt-3 text-center text-sm text-gray-600">
                    <p><strong>ยืนยัน:</strong> ยืนยันการเลือกตารางงานทั้งเดือน (ไม่สามารถแก้ไขได้)</p>
                    <p><strong>แก้ไข:</strong> ยกเลิกการยืนยันเพื่อแก้ไขตารางงานได้</p>
                </div>
            </div>

            <!-- สรุปวันหยุด -->
            <div id="leaveQuota" class="mb-6"></div>

            <!-- ฟอร์มขอลา -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-bold mb-4">ขอลาใหม่</h3>
                
                <!-- คำแนะนำการลา -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 mb-3">📋 ข้อกำหนดการลา</h4>
                    <div class="space-y-2 text-sm text-blue-700">
                        <div class="flex items-start">
                            <span class="mr-2">🤒</span>
                            <div>
                                <strong>ลาป่วย:</strong> ไม่ต้องแจ้งล่วงหน้า แต่ต้องแนบใบรับรองแพทย์ (ป่วยทุกกรณี)
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="mr-2">🏖️</span>
                            <div>
                                <strong>ลาพักร้อน:</strong> ต้องแจ้งล่วงหน้าอย่างน้อย 7 วัน
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="mr-2">📋</span>
                            <div>
                                <strong>ลากิจ:</strong> ต้องแจ้งล่วงหน้าอย่างน้อย 3 วัน และแนบเอกสารตามธุระ
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="leaveForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ประเภทการลา</label>
                            <select id="leaveType" class="w-full px-3 py-2 border rounded-lg" onchange="updateLeaveRequirements()">
                                <option value="ลาป่วย">🤒 ลาป่วย</option>
                                <option value="ลาพักร้อน">🏖️ ลาพักร้อน</option>
                                <option value="ลากิจ">📋 ลากิจ</option>
                            </select>
                        </div>
                        <div id="advanceNoticeInfo" class="flex items-center">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                                <div class="font-semibold text-yellow-800">🤒 ลาป่วย</div>
                                <div class="text-yellow-700">ไม่ต้องแจ้งล่วงหน้า</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">วันที่เริ่มต้น</label>
                            <input type="date" id="startDate" class="w-full px-3 py-2 border rounded-lg" onchange="validateAdvanceNotice()">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">วันที่สิ้นสุด</label>
                            <input type="date" id="endDate" class="w-full px-3 py-2 border rounded-lg" onchange="validateAdvanceNotice()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">เหตุผล</label>
                        <textarea id="reason" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="กรุณาระบุเหตุผลการลา"></textarea>
                    </div>
                    
                    <!-- ส่วนแนบเอกสาร -->
                    <div id="documentSection">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <span id="documentLabel">เอกสารแนบ (ใบรับรองแพทย์)</span>
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="documentFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload()">
                            <div id="fileUploadArea" onclick="document.getElementById('documentFile').click()" class="cursor-pointer">
                                <div class="text-gray-500 mb-2">📎 คลิกเพื่อแนบเอกสาร</div>
                                <div class="text-sm text-gray-400">รองรับไฟล์ PDF, JPG, PNG</div>
                            </div>
                            <div id="fileInfo" class="hidden">
                                <div class="text-green-600 font-semibold">✅ แนบเอกสารแล้ว</div>
                                <div id="fileName" class="text-sm text-gray-600 mt-1"></div>
                                <button type="button" onclick="removeFile()" class="text-red-500 text-sm mt-2 hover:underline">ลบไฟล์</button>
                            </div>
                        </div>
                        <div id="documentNote" class="text-sm text-gray-600 mt-2">
                            <strong>หมายเหตุ:</strong> ต้องแนบใบรับรองแพทย์สำหรับการลาป่วยทุกกรณี
                        </div>
                    </div>
                    
                    <!-- ข้อความเตือนการแจ้งล่วงหน้า -->
                    <div id="advanceWarning" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-red-800 font-semibold">⚠️ การแจ้งล่วงหน้าไม่เพียงพอ</div>
                        <div id="advanceWarningText" class="text-red-700 text-sm mt-1"></div>
                    </div>
                </form>
                
                <button id="submitLeaveBtn" class="mt-6 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold shadow-lg transition-all duration-200">
                    📤 ส่งคำขอลา
                </button>
            </div>

            <!-- รายการคำขอลา -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-bold mb-4">รายการคำขอลา</h3>
                <div id="leaveRequests" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- HR Panel -->
    <div id="hrPanel" class="hidden">
        <div class="container mx-auto p-4">
            <h2 class="text-2xl font-bold mb-6">Management Panel</h2>
            
            <!-- สรุปสถิติ -->
            <div id="summaryStats"></div>
            
            <!-- แท็บสำหรับ HR -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="border-b">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="switchHRTab('approvals')" id="approvalsTab" class="py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold">
                            อนุมัติการลา
                        </button>
                        <button onclick="switchHRTab('employees')" id="employeesTab" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            จัดการพนักงาน
                        </button>
                        <button onclick="switchHRTab('calendar')" id="calendarTab" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            ปฏิทินรวม
                        </button>
                        <button onclick="switchHRTab('shifts')" id="shiftsTab" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            ช่วงเวลาทำงาน Admin
                        </button>
                    </nav>
                </div>
                
                <!-- เนื้อหาแท็บอนุมัติการลา -->
                <div id="approvalsContent" class="p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-2">คำขอลาที่รออนุมัติ</h3>
                        <p class="text-gray-600 text-sm">รายการคำขอลาที่ต้องการการอนุมัติจากฝ่าย HR</p>
                    </div>
                    <div id="pendingLeaves" class="space-y-3 mb-8"></div>
                    
                    <!-- รายการคำขอลาทั้งหมด -->
                    <div class="border-t pt-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold mb-2">รายการคำขอลาทั้งหมด</h3>
                            <p class="text-gray-600 text-sm">ประวัติคำขอลาของพนักงานทั้งหมด</p>
                        </div>
                        <div id="allLeaveRequests" class="space-y-3"></div>
                    </div>
                </div>
                
                <!-- เนื้อหาแท็บจัดการพนักงาน -->
                <div id="employeesContent" class="p-6 hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold mb-2">จัดการพนักงาน</h3>
                        <p class="text-gray-600 text-sm">เพิ่ม แก้ไข หรือลบข้อมูลพนักงาน</p>
                    </div>
                    <div id="employeeList"></div>
                </div>
                
                <!-- เนื้อหาแท็บปฏิทินรวม -->
                <div id="calendarContent" class="p-6 hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold mb-2">ปฏิทินรวม</h3>
                        <p class="text-gray-600 text-sm">ดูสถิติการทำงานของพนักงานทั้งหมด คลิกที่วันใดก็ได้เพื่อดูรายละเอียด</p>
                    </div>
                    <div id="hrCalendar"></div>
                </div>
                
                <!-- เนื้อหาแท็บช่วงเวลาทำงาน Admin -->
                <div id="shiftsContent" class="p-6 hidden">
                    <div id="shiftManagement"></div>
                </div>
            </div>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f29f21360d45c0',t:'MTc1NTE5NzI1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
