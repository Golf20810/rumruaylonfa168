<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ‡πÉ‡∏ä‡πâ Local Storage ‡πÅ‡∏ó‡∏ô Firebase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CSP
        const localDB = {
            employees: {},
            leaveQuota: {},
            workSchedule: {},
            leaveRequests: {}
        };

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
        function loadLocalData() {
            const saved = localStorage.getItem('workScheduleDB');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(localDB, data);
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á localStorage
        function saveLocalData() {
            localStorage.setItem('workScheduleDB', JSON.stringify(localDB));
        }

        // Mock Firebase functions
        const ref = (db, path) => ({ path });
        const set = async (ref, data) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = data;
            saveLocalData();
        };
        const get = async (ref) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (const key of keys) {
                if (!current[key]) return { exists: () => false, val: () => null };
                current = current[key];
            }
            return { exists: () => true, val: () => current };
        };
        const update = async (ref, data) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            if (!current[keys[keys.length - 1]]) current[keys[keys.length - 1]] = {};
            Object.assign(current[keys[keys.length - 1]], data);
            saveLocalData();
        };
        const push = async (ref, data) => {
            const keys = ref.path.split('/');
            let current = localDB;
            for (const key of keys) {
                if (!current[key]) current[key] = {};
                current = current[key];
            }
            const id = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            current[id] = data;
            saveLocalData();
            return { key: id };
        };

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        loadLocalData();

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        const employees = {
            'HR001': { name: 'HR', position: 'HR', role: 'HR', department: 'HR', workTime: '08:30-17:30', team: null, shift: null },
            'MA001': { name: '‡∏≠‡∏≤‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏≤ ‡∏ô‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå (‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏¢)', position: 'Admin Manager', role: 'Manager', department: 'Admin', workTime: '08:30-17:30', team: 'Manager', shift: null },
            'MM001': { name: '‡∏ô‡∏û‡∏î‡∏• ‡∏≠‡∏¥‡∏ô‡πÉ‡∏à (‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏≠‡∏•‡πå‡∏ü)', position: 'Marketing Manager', role: 'Manager', department: 'Marketing', workTime: '10:30-19:30', team: null, shift: null },
            'EA001': { name: '‡∏Å‡∏∏‡∏•‡∏ò‡∏¥‡∏ï‡∏≤ ‡∏ó‡∏≠‡∏á‡∏™‡∏¥‡∏°‡∏≤ (‡∏ô‡πâ‡∏≠‡∏á‡∏ö‡∏¥‡∏ß)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA002': { name: '‡∏ß‡∏£‡∏£‡∏ì‡∏£‡∏¥‡∏¢‡∏≤ ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏à‡∏£‡∏¥‡∏ç (‡∏ô‡πâ‡∏≠‡∏á‡∏ù‡πâ‡∏≤‡∏¢)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA003': { name: '‡∏û‡∏ß‡∏á‡∏ú‡∏Å‡∏≤ ‡∏û‡∏∏‡∏ó‡∏ò‡∏™‡∏≤‡∏£ (‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡∏¢)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA004': { name: '‡πÅ‡∏™‡∏á‡∏î‡∏µ ‡∏ô‡∏≤‡∏°‡πÅ‡∏™‡∏á (‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏¢)', position: 'Admin Team 1', role: 'Employee', department: 'Admin', workTime: '06:00-15:00', team: 'Team1', shift: 'morning' },
            'EA005': { name: '‡∏´‡∏•‡πâ‡∏≤ ‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏≤‡∏° (‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏•‡πâ‡∏≤)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EA006': { name: '‡∏ô.‡∏™.‡∏û‡∏∏‡∏ó‡∏ò‡∏¥‡∏ï‡∏≤ ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏™‡∏µ (‡∏ô‡πâ‡∏≠‡∏á‡∏ö‡∏µ‡πÄ‡∏≠‡πá‡∏°)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EA007': { name: '‡∏£‡∏±‡∏ä‡∏ô‡∏µ‡∏Å‡∏£ ‡∏Ñ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏û‡∏µ‡πà‡πÅ‡∏Ñ‡∏ó)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EA008': { name: '‡∏ô‡∏ß‡∏û‡∏£ ‡∏≠‡∏¥‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£ (‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏≤)', position: 'Admin Team 2', role: 'Employee', department: 'Admin', workTime: '14:00-23:00', team: 'Team2', shift: 'evening' },
            'EM001': { name: '‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡∏ß‡∏±‡∏í‡∏ô‡∏∞ (‡∏ô‡∏ô‡∏ó‡πå)', position: 'Editor', role: 'Employee', department: 'Marketing', workTime: '10:30-19:30', team: null, shift: null },
            'ET001': { name: '‡∏®‡∏£‡∏µ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏á (‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET002': { name: '‡∏≠‡∏≤‡∏£‡∏µ‡∏î‡∏≤ ‡∏Ñ‡∏≥‡∏•‡∏∑‡∏≠ (‡∏ô‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡πà‡∏ô)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET003': { name: '‡πÅ‡∏û‡∏£‡∏ô‡∏ß‡∏• ‡∏≠‡∏∏‡πà‡∏ô‡πÉ‡∏à (‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏û‡∏£)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET004': { name: '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏à‡∏¥‡∏£‡∏≤ ‡∏á‡∏≤‡∏°‡∏™‡∏á‡∏ß‡∏ô (‡∏û‡∏µ‡πà‡∏≠‡∏±‡πâ‡∏°)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null },
            'ET005': { name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡∏≤ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ô)', position: 'Telesale', role: 'Employee', department: 'Telesale', workTime: '08:30-17:30', team: null, shift: null }
        };

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏∞ Admin
        const shiftSystem = {
            shifts: {
                morning: { name: '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤', time: '06:00-15:00' },
                evening: { name: '‡∏Å‡∏∞‡πÄ‡∏¢‡πá‡∏ô', time: '14:00-23:00' }
            },
            
            // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            getShiftForMonth: function(team, year, month) {
                // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏π‡πà = ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏µ‡πà = ‡∏Å‡∏∞‡πÄ‡∏¢‡πá‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Team1
                // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏π‡πà = ‡∏Å‡∏∞‡πÄ‡∏¢‡πá‡∏ô, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏µ‡πà = ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Team2
                const isEvenMonth = (month + 1) % 2 === 0;
                
                if (team === 'Team1') {
                    return isEvenMonth ? 'morning' : 'evening';
                } else if (team === 'Team2') {
                    return isEvenMonth ? 'evening' : 'morning';
                } else {
                    return 'morning'; // Manager ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤
                }
            },
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            updateEmployeeShift: function(empId, year, month) {
                const emp = employees[empId];
                if (emp && emp.department === 'Admin' && emp.team) {
                    const newShift = this.getShiftForMonth(emp.team, year, month);
                    const shiftInfo = this.shifts[newShift];
                    
                    emp.shift = newShift;
                    emp.workTime = shiftInfo.time;
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    if (emp.team === 'Team1') {
                        emp.position = `Admin Team 1 (${shiftInfo.name})`;
                    } else if (emp.team === 'Team2') {
                        emp.position = `Admin Team 2 (${shiftInfo.name})`;
                    }
                }
            }
        };

        // ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå
        const publicHolidays = {
            '2025-01-01': '‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà',
            '2025-02-12': '‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Ü‡∏ö‡∏π‡∏ä‡∏≤',
            '2025-04-13': '‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå',
            '2025-04-14': '‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå',
            '2025-04-15': '‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå',
            '2025-05-01': '‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô',
            '2025-05-11': '‡∏ß‡∏±‡∏ô‡∏ß‡∏¥‡∏™‡∏≤‡∏Ç‡∏ö‡∏π‡∏ä‡∏≤',
            '2025-07-10': '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏™‡∏≤‡∏¨‡∏´‡∏ö‡∏π‡∏ä‡∏≤',
            '2025-07-28': '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏£.10',
            '2025-08-12': '‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà',
            '2025-10-13': '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï ‡∏£.9',
            '2025-12-05': '‡∏ß‡∏±‡∏ô‡∏û‡πà‡∏≠',
            '2024-12-31': '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏õ‡∏µ'
        };

        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        async function initializeEmployees() {
            console.log('Initializing employees...');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (Object.keys(localDB.employees).length === 0) {
                console.log('No existing employee data, creating initial data...');
                
                for (const [empId, empData] of Object.entries(employees)) {
                    await set(ref(null, `employees/${empId}`), empData);
                    
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                    const quota = {
                        regularLeave: 4,
                        specialLeave: empData.department === 'Telesale' ? 2 : 0,
                        sickLeave: 30,
                        vacationLeave: 6,
                        personalLeave: 6
                    };
                    await set(ref(null, `leaveQuota/${empId}`), quota);
                }
                console.log('Employee data initialized successfully');
            } else {
                console.log('Employee data already exists, skipping initialization');
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        async function generateWorkSchedule(year, month) {
            console.log(`Generating work schedule for ${year}-${month + 1}...`);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            try {
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    for (const empId of Object.keys(employees)) {
                        const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                        
                        try {
                            const snapshot = await get(scheduleRef);
                            
                            if (!snapshot.exists()) {
                                const isPublicHoliday = publicHolidays[date];
                                const scheduleData = {
                                    status: isPublicHoliday ? 'holiday_pending' : 'work',
                                    type: isPublicHoliday ? 'public_holiday' : 'regular',
                                    holidayName: isPublicHoliday || null,
                                    employeeId: empId,
                                    date: date
                                };
                                
                                await set(scheduleRef, scheduleData);
                            }
                        } catch (error) {
                            console.error(`Error creating schedule for ${empId} on ${date}:`, error);
                        }
                    }
                }
                console.log('Work schedule generated successfully');
            } catch (error) {
                console.error('Error generating work schedule:', error);
            }
        }

        // ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        async function login() {
            const empId = document.getElementById('empId').value.trim().toUpperCase();
            
            console.log('Attempting login with ID:', empId);
            console.log('Available employees:', Object.keys(employees));
            
            if (!employees[empId]) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n\n‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: ' + Object.keys(employees).join(', '));
                return;
            }
            
            try {
                currentUser = empId;
                console.log('Login successful for:', empId);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userName').textContent = employees[empId].name;
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                await initializeEmployees();
                console.log('Employees initialized');
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                updateShiftsForMonth(currentYear, currentMonth);
                console.log('Shifts updated for current month');
                
                await generateWorkSchedule(currentYear, currentMonth);
                console.log('Work schedule generated');
                
                await loadCalendar();
                console.log('Calendar loaded');
                
                await loadLeaveQuota();
                console.log('Leave quota loaded');
                
                await loadLeaveRequests();
                console.log('Leave requests loaded');
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô HR ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Management Panel ‡πÄ‡∏ï‡πá‡∏° ‡∏´‡∏£‡∏∑‡∏≠ Manager ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°
                if (employees[empId].role === 'HR') {
                    console.log('User is HR, showing full management panel');
                    document.getElementById('hrPanel').classList.remove('hidden');
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HR
                    document.getElementById('approvalsTab').style.display = 'block';
                    document.getElementById('employeesTab').style.display = 'block';
                    document.getElementById('calendarTab').style.display = 'block';
                    
                    await loadHRPanel();
                    console.log('Management panel loaded');
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°
                    await loadSummaryStats();
                    console.log('Summary stats loaded');
                    
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    switchHRTab('approvals');
                } else if (employees[empId].role === 'Manager') {
                    console.log('User is Manager, showing limited management panel');
                    document.getElementById('hrPanel').classList.remove('hidden');
                    
                    // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà Manager ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                    document.getElementById('approvalsTab').style.display = 'none';
                    document.getElementById('employeesTab').style.display = 'block'; // Manager ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
                    document.getElementById('calendarTab').style.display = 'block';
                    
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                    switchHRTab('employees');
                    await loadEmployeeManagement();
                    console.log('Manager employee management loaded');
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°
                    await loadSummaryStats();
                    console.log('Manager summary stats loaded');
                }
                
                console.log('Login process completed successfully');
            } catch (error) {
                console.error('Login error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message);
                
                // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('hrPanel').classList.add('hidden');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
        async function loadCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            
            const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            
            monthYear.textContent = `${monthNames[currentMonth]} ${currentYear + 543}`;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
            const confirmSnapshot = await get(confirmRef);
            const isConfirmed = confirmSnapshot.exists();
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°
            const confirmBtn = document.getElementById('confirmBtn');
            const editBtn = document.getElementById('editBtn');
            
            console.log('Updating buttons - confirmBtn:', confirmBtn, 'editBtn:', editBtn, 'isConfirmed:', isConfirmed);
            
            if (confirmBtn && editBtn) {
                if (isConfirmed) {
                    confirmBtn.style.display = 'none';
                    editBtn.style.display = 'inline-block';
                    editBtn.textContent = 'üîì ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                    editBtn.className = 'bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 font-semibold shadow-lg transition-all duration-200';
                    console.log('Buttons updated for confirmed state');
                } else {
                    confirmBtn.style.display = 'inline-block';
                    editBtn.style.display = 'none';
                    console.log('Buttons updated for unconfirmed state');
                }
            } else {
                console.error('Buttons not found in DOM');
            }
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let calendarHTML = `
                <div class="grid grid-cols-7 gap-1 mb-4">
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏≠‡∏≤</div>
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏à</div>
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏≠</div>
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏û</div>
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏û‡∏§</div>
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏®</div>
                    <div class="text-center font-bold p-2 bg-gray-200">‡∏™</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                try {
                    const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                    const snapshot = await get(scheduleRef);
                    const schedule = snapshot.val() || { status: 'work', type: 'regular' };
                    
                    let bgColor = 'bg-white';
                    let textColor = 'text-gray-800';
                    let statusText = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                    let clickable = !isConfirmed; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå
                    const isPublicHoliday = publicHolidays[date];
                    if (isPublicHoliday) {
                        if (schedule.status === 'holiday_pending') {
                            bgColor = 'bg-yellow-100';
                            statusText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô/‡∏´‡∏¢‡∏∏‡∏î';
                        } else if (schedule.status === 'work') {
                            bgColor = 'bg-yellow-100';
                            statusText = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (2‡πÄ‡∏ó‡πà‡∏≤)';
                        } else if (schedule.status === 'holiday') {
                            bgColor = 'bg-red-100';
                            statusText = '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
                        }
                    } else {
                        // ‡∏ß‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
                        if (schedule.status === 'holiday') {
                            bgColor = 'bg-red-200';
                            statusText = '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
                            if (schedule.leaveType) {
                                const leaveTypeNames = {
                                    'regular': '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥',
                                    'special': '‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                                    'sick': '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢',
                                    'vacation': '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô',
                                    'personal': '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'
                                };
                                statusText = leaveTypeNames[schedule.leaveType] || '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
                            }
                        } else if (schedule.status === 'leave') {
                            bgColor = 'bg-orange-200';
                            statusText = '‡∏•‡∏≤';
                            if (schedule.leaveType) {
                                const leaveTypeNames = {
                                    'regular': '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥',
                                    'special': '‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                                    'sick': '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢',
                                    'vacation': '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô',
                                    'personal': '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'
                                };
                                statusText = leaveTypeNames[schedule.leaveType] || '‡∏•‡∏≤';
                            }
                        } else {
                            bgColor = 'bg-green-100';
                            statusText = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
                        }
                    }
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    if (isConfirmed) {
                        bgColor += ' opacity-75';
                        textColor = 'text-gray-600';
                    }
                    
                    const cursorClass = clickable ? 'cursor-pointer hover:bg-opacity-80' : 'cursor-not-allowed';
                    const onClick = clickable ? `onclick="selectDate('${date}')"` : '';
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                    let lockIcon = '';
                    if (schedule.status === 'leave' && schedule.approvedBy) {
                        lockIcon = '<div class="text-xs text-green-600 mt-1">üîí HR ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
                    } else if (isConfirmed) {
                        lockIcon = '<div class="text-xs text-gray-500 mt-1">üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>';
                    }
                    
                    calendarHTML += `
                        <div class="border p-2 min-h-[80px] ${bgColor} ${textColor} ${cursorClass} transition-colors" ${onClick}>
                            <div class="font-bold">${day}</div>
                            <div class="text-xs mt-1">${statusText}</div>
                            ${isPublicHoliday ? `<div class="text-xs text-blue-600 font-semibold">${isPublicHoliday}</div>` : ''}
                            ${lockIcon}
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading calendar day:', error);
                    const cursorClass = clickable ? 'cursor-pointer' : 'cursor-not-allowed';
                    const onClick = clickable ? `onclick="selectDate('${date}')"` : '';
                    
                    calendarHTML += `
                        <div class="border p-2 min-h-[80px] bg-gray-100 ${cursorClass}" ${onClick}>
                            <div class="font-bold">${day}</div>
                            <div class="text-xs mt-1">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                            ${isConfirmed ? '<div class="text-xs text-gray-500 mt-1">üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>' : ''}
                        </div>
                    `;
                }
            }
            
            calendarHTML += `
                </div>
            `;
            calendar.innerHTML = calendarHTML;
        }



        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô - ‡πÅ‡∏™‡∏î‡∏á popup ‡πÄ‡∏™‡∏°‡∏≠
        window.selectDate = async function(date) {
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
                const confirmSnapshot = await get(confirmRef);
                
                if (confirmSnapshot.exists()) {
                    alert('‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß\n‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ\n\n‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡∏Å‡πà‡∏≠‡∏ô');
                    return;
                }
                
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const schedule = snapshot.val();
                
                if (!schedule) {
                    console.error('No schedule found for date:', date);
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà HR ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (schedule.status === 'leave' && schedule.approvedBy) {
                    alert('‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å HR ‡πÅ‡∏•‡πâ‡∏ß\n‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ\n\n‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ HR');
                    return;
                }
                
                const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                showEditDayOptions(date, schedule, quota);
                
            } catch (error) {
                console.error('Error in selectDate:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô');
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡∏°
        async function checkTeamConflict(date, empId) {
            const currentEmp = employees[empId];
            let conflictMembers = [];
            let teamMembers = [];
            
            // ‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            for (const [otherId, otherEmp] of Object.entries(employees)) {
                if (otherId === empId) continue;
                
                // Admin Team 1 ‡πÅ‡∏•‡∏∞ Team 2 ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
                if (currentEmp.department === 'Admin' && otherEmp.department === 'Admin') {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const currentTeam = currentEmp.position.includes('Team 1') ? 'Team 1' : 
                                       currentEmp.position.includes('Team 2') ? 'Team 2' : 'Other';
                    const otherTeam = otherEmp.position.includes('Team 1') ? 'Team 1' : 
                                     otherEmp.position.includes('Team 2') ? 'Team 2' : 'Other';
                    
                    if (currentTeam === otherTeam && currentTeam !== 'Other') {
                        teamMembers.push({ id: otherId, name: otherEmp.name, position: otherEmp.position });
                    }
                }
                // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å
                else if (currentEmp.department === otherEmp.department) {
                    teamMembers.push({ id: otherId, name: otherEmp.name, position: otherEmp.position });
                }
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            for (const member of teamMembers) {
                try {
                    const scheduleRef = ref(null, `workSchedule/${member.id}/${date}`);
                    const snapshot = await get(scheduleRef);
                    const schedule = snapshot.val();
                    
                    if (schedule && (schedule.status === 'holiday' || schedule.status === 'leave')) {
                        conflictMembers.push({
                            ...member,
                            status: schedule.status === 'holiday' ? '‡∏´‡∏¢‡∏∏‡∏î' : '‡∏•‡∏≤',
                            leaveType: schedule.leaveType || ''
                        });
                    }
                } catch (error) {
                    console.error('Error checking team member schedule:', error);
                }
            }
            
            return {
                hasConflict: conflictMembers.length > 0,
                conflictMembers: conflictMembers,
                teamSize: teamMembers.length + 1
            };
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô
        async function showEditDayOptions(date, currentSchedule, quota) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡∏°
            const conflictCheck = await checkTeamConflict(date, currentUser);
            const isPublicHoliday = publicHolidays[date];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô - ${date}</h3>
                    
                    ${isPublicHoliday ? `
                    <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-4">
                        <div class="font-semibold text-yellow-800">üéâ ${isPublicHoliday}</div>
                        <div class="text-sm text-yellow-700">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏¢‡∏∏‡∏î</div>
                    </div>
                    ` : ''}
                    
                    <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                        <div class="text-sm text-gray-700">
                            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> 
                            ${currentSchedule.status === 'work' ? (isPublicHoliday ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (2‡πÄ‡∏ó‡πà‡∏≤)' : '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô') : 
                              currentSchedule.status === 'holiday' ? '‡∏´‡∏¢‡∏∏‡∏î' : 
                              currentSchedule.status === 'leave' ? '‡∏•‡∏≤' : 
                              currentSchedule.status === 'holiday_pending' ? '‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}
                            ${currentSchedule.leaveType ? ` (${currentSchedule.leaveType})` : ''}
                        </div>
                    </div>
                    
                    ${isPublicHoliday ? `
                    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå -->
                    <div class="space-y-3">
                        <button onclick="changeDayStatus('${date}', 'work')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'work' ? 'bg-yellow-200 border-yellow-400' : 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200'}">
                            <div class="font-semibold">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤) ${currentSchedule.status === 'work' ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</div>
                        </button>
                        
                        <button onclick="changeDayStatus('${date}', 'holiday')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'holiday' ? 'bg-red-200 border-red-400' : 'bg-red-50 hover:bg-red-100 border-red-200'}">
                            <div class="font-semibold">‡∏´‡∏¢‡∏∏‡∏î ${currentSchedule.status === 'holiday' ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</div>
                            <div class="text-sm text-gray-600">‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</div>
                        </button>
                    </div>
                    ` : `
                    <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ -->
                    ${conflictCheck.hasConflict && (currentSchedule.status === 'work') ? `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                        <div class="font-semibold text-red-800">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ</div>
                        <div class="text-sm text-red-700 mb-2">‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß:</div>
                        <div class="space-y-1">
                            ${conflictCheck.conflictMembers.map(member => `
                                <div class="text-xs bg-white p-2 rounded border border-red-200">
                                    <span class="font-semibold">${member.name}</span> (${member.position}) - ${member.status}${member.leaveType ? ` (${member.leaveType === 'regular' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : member.leaveType === 'special' ? '‡∏û‡∏¥‡πÄ‡∏®‡∏©' : member.leaveType})` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="changeDayStatus('${date}', 'work')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'work' ? 'bg-green-200 border-green-400' : 'bg-green-50 hover:bg-green-100 border-green-200'}">
                            <div class="font-semibold">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ${currentSchedule.status === 'work' ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                        </button>
                    </div>
                    ` : `
                    <div class="space-y-3">
                        <button onclick="changeDayStatus('${date}', 'work')" 
                                class="w-full p-3 text-left rounded border ${currentSchedule.status === 'work' ? 'bg-green-200 border-green-400' : 'bg-green-50 hover:bg-green-100 border-green-200'}">
                            <div class="font-semibold">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ${currentSchedule.status === 'work' ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                        </button>
                        
                        <button onclick="selectHolidayType('${date}', 'regular')" 
                                class="w-full p-3 text-left rounded border ${quota.regularLeave > 0 || (currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'regular') ? 'bg-red-50 hover:bg-red-100 border-red-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.regularLeave <= 0 && !(currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'regular') ? 'disabled' : ''}>
                            <div class="font-semibold">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ${currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'regular' ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.regularLeave} ‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠)</div>
                        </button>
                        
                        ${quota.specialLeave > 0 || (currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'special') ? `
                        <button onclick="selectHolidayType('${date}', 'special')" 
                                class="w-full p-3 text-left rounded border bg-purple-50 hover:bg-purple-100 border-purple-200 ${currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'special' ? 'bg-purple-200 border-purple-400' : ''}">
                            <div class="font-semibold">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (Telesale) ${currentSchedule.status === 'holiday' && currentSchedule.leaveType === 'special' ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.specialLeave} ‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠)</div>
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="text-sm text-blue-800">
                            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏Å‡∏¥‡∏à ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ HR ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô
                        </div>
                    </div>
                    `}
                    `}
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="closeLeaveModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        async function showLeaveOptions(date, quota) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡∏°
            const conflictCheck = await checkTeamConflict(date, currentUser);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ - ${date}</h3>
                    
                    ${conflictCheck.hasConflict ? `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                        <div class="font-semibold text-red-800">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤/‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ</div>
                        <div class="text-sm text-red-700 mb-2">‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏°/‡πÅ‡∏ú‡∏ô‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß:</div>
                        <div class="space-y-1">
                            ${conflictCheck.conflictMembers.map(member => `
                                <div class="text-xs bg-white p-2 rounded border border-red-200">
                                    <span class="font-semibold">${member.name}</span> (${member.position}) - ${member.status}${member.leaveType ? ` (${member.leaveType === 'regular' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : member.leaveType === 'special' ? '‡∏û‡∏¥‡πÄ‡∏®‡∏©' : member.leaveType})` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="closeLeaveModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏õ‡∏¥‡∏î</button>
                    </div>
                    ` : `
                    <div class="space-y-3">
                        <button onclick="takeLeave('${date}', 'regular')" 
                                class="w-full p-3 text-left rounded border ${quota.regularLeave > 0 ? 'bg-blue-50 hover:bg-blue-100 border-blue-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.regularLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.regularLeave} ‡∏ß‡∏±‡∏ô</div>
                        </button>
                        
                        ${quota.specialLeave > 0 ? `
                        <button onclick="takeLeave('${date}', 'special')" 
                                class="w-full p-3 text-left rounded border bg-purple-50 hover:bg-purple-100 border-purple-200">
                            <div class="font-semibold">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (Telesale)</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.specialLeave} ‡∏ß‡∏±‡∏ô</div>
                        </button>
                        ` : ''}
                        
                        <button onclick="takeLeave('${date}', 'sick')" 
                                class="w-full p-3 text-left rounded border ${quota.sickLeave > 0 ? 'bg-red-50 hover:bg-red-100 border-red-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.sickLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.sickLeave} ‡∏ß‡∏±‡∏ô</div>
                        </button>
                        
                        <button onclick="takeLeave('${date}', 'vacation')" 
                                class="w-full p-3 text-left rounded border ${quota.vacationLeave > 0 ? 'bg-green-50 hover:bg-green-100 border-green-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.vacationLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.vacationLeave} ‡∏ß‡∏±‡∏ô</div>
                        </button>
                        
                        <button onclick="takeLeave('${date}', 'personal')" 
                                class="w-full p-3 text-left rounded border ${quota.personalLeave > 0 ? 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                                ${quota.personalLeave <= 0 ? 'disabled' : ''}>
                            <div class="font-semibold">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${quota.personalLeave} ‡∏ß‡∏±‡∏ô</div>
                        </button>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="closeLeaveModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                    `}
                </div>
            `;
            document.body.appendChild(modal);
        }



        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô
        window.changeDayStatus = async function(date, newStatus) {
            try {
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const currentSchedule = snapshot.val();
                
                if (!currentSchedule) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô');
                    return;
                }
                
                const isPublicHoliday = publicHolidays[date];
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î/‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)
                if ((currentSchedule.status === 'holiday' || currentSchedule.status === 'leave') && newStatus === 'work') {
                    if (currentSchedule.leaveType && !isPublicHoliday) {
                        const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                        const quotaSnapshot = await get(quotaRef);
                        const quota = quotaSnapshot.val();
                        
                        const newQuota = { ...quota };
                        switch(currentSchedule.leaveType) {
                            case 'regular': newQuota.regularLeave = quota.regularLeave + 1; break;
                            case 'special': newQuota.specialLeave = quota.specialLeave + 1; break;
                            case 'sick': newQuota.sickLeave = quota.sickLeave + 1; break;
                            case 'vacation': newQuota.vacationLeave = quota.vacationLeave + 1; break;
                            case 'personal': newQuota.personalLeave = quota.personalLeave + 1; break;
                        }
                        await update(quotaRef, newQuota);
                    }
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                const updateData = { 
                    status: newStatus,
                    type: isPublicHoliday ? 'public_holiday' : 'regular',
                    holidayName: isPublicHoliday || null
                };
                
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ leaveType
                if (!isPublicHoliday) {
                    updateData.leaveType = newStatus === 'work' ? null : currentSchedule.leaveType;
                } else {
                    updateData.leaveType = null; // ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ leaveType
                }
                
                await update(scheduleRef, updateData);
                
                closeLeaveModal();
                await loadCalendar();
                if (!isPublicHoliday) {
                    await loadLeaveQuota();
                }
                
                const statusText = isPublicHoliday ? 
                    (newStatus === 'work' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤)' : '‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå') :
                    (newStatus === 'work' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : '‡∏´‡∏¢‡∏∏‡∏î');
                    
                alert(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô${statusText}‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
            } catch (error) {
                console.error('Error changing day status:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
            }
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡πÉ‡∏´‡∏°‡πà)
        window.selectHolidayType = async function(date, leaveType) {
            try {
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const currentSchedule = snapshot.val();
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏¥‡∏°) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType === leaveType) {
                    closeLeaveModal();
                    alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
                let quotaField = '';
                switch(leaveType) {
                    case 'regular': quotaField = 'regularLeave'; break;
                    case 'special': quotaField = 'specialLeave'; break;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType && currentSchedule.leaveType !== leaveType) {
                    const oldQuotaField = currentSchedule.leaveType === 'regular' ? 'regularLeave' :
                                         currentSchedule.leaveType === 'special' ? 'specialLeave' : '';
                    
                    if (oldQuotaField) {
                        const newQuota = { ...quota };
                        newQuota[oldQuotaField] = quota[oldQuotaField] + 1; // ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
                        await update(quotaRef, newQuota);
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        const updatedQuotaSnapshot = await get(quotaRef);
                        const updatedQuota = updatedQuotaSnapshot.val();
                        
                        if (updatedQuota[quotaField] <= 0) {
                            alert('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                            return;
                        }
                        
                        // ‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        const finalQuota = { ...updatedQuota };
                        finalQuota[quotaField] = updatedQuota[quotaField] - 1;
                        await update(quotaRef, finalQuota);
                    }
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                    if (quota[quotaField] <= 0) {
                        alert('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                        return;
                    }
                    
                    // ‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
                    const newQuota = { ...quota };
                    newQuota[quotaField] = quota[quotaField] - 1;
                    await update(quotaRef, newQuota);
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                await update(scheduleRef, { 
                    status: 'holiday',
                    leaveType: leaveType
                });
                
                closeLeaveModal();
                await loadCalendar();
                await loadLeaveQuota();
                
                alert('‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Error selecting holiday type:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î');
            }
        }

        // ‡∏•‡∏≤‡∏ß‡∏±‡∏ô
        window.takeLeave = async function(date, leaveType) {
            try {
                const scheduleRef = ref(null, `workSchedule/${currentUser}/${date}`);
                const snapshot = await get(scheduleRef);
                const currentSchedule = snapshot.val();
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏¥‡∏°) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType === leaveType) {
                    closeLeaveModal();
                    alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                const quotaRef = ref(null, `leaveQuota/${currentUser}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
                let quotaField = '';
                switch(leaveType) {
                    case 'regular': quotaField = 'regularLeave'; break;
                    case 'special': quotaField = 'specialLeave'; break;
                    case 'sick': quotaField = 'sickLeave'; break;
                    case 'vacation': quotaField = 'vacationLeave'; break;
                    case 'personal': quotaField = 'personalLeave'; break;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                if (currentSchedule.status === 'holiday' && currentSchedule.leaveType && currentSchedule.leaveType !== leaveType) {
                    const oldQuotaField = currentSchedule.leaveType === 'regular' ? 'regularLeave' :
                                         currentSchedule.leaveType === 'special' ? 'specialLeave' :
                                         currentSchedule.leaveType === 'sick' ? 'sickLeave' :
                                         currentSchedule.leaveType === 'vacation' ? 'vacationLeave' :
                                         currentSchedule.leaveType === 'personal' ? 'personalLeave' : '';
                    
                    if (oldQuotaField) {
                        const newQuota = { ...quota };
                        newQuota[oldQuotaField] = quota[oldQuotaField] + 1; // ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
                        await update(quotaRef, newQuota);
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        const updatedQuotaSnapshot = await get(quotaRef);
                        const updatedQuota = updatedQuotaSnapshot.val();
                        
                        if (updatedQuota[quotaField] <= 0) {
                            alert('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                            return;
                        }
                        
                        // ‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        const finalQuota = { ...updatedQuota };
                        finalQuota[quotaField] = updatedQuota[quotaField] - 1;
                        await update(quotaRef, finalQuota);
                    }
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≤
                    if (quota[quotaField] <= 0) {
                        alert('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                        return;
                    }
                    
                    // ‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
                    const newQuota = { ...quota };
                    newQuota[quotaField] = quota[quotaField] - 1;
                    await update(quotaRef, newQuota);
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                await update(scheduleRef, { 
                    status: 'holiday',
                    leaveType: leaveType
                });
                
                closeLeaveModal();
                await loadCalendar();
                await loadLeaveQuota();
                
                alert('‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Error taking leave:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î');
            }
        }

        // ‡∏õ‡∏¥‡∏î modal
        window.closeLeaveModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        async function loadLeaveQuota() {
            const quotaRef = ref(null, `leaveQuota/${currentUser}`);
            const snapshot = await get(quotaRef);
            const quota = snapshot.val();
            
            const maxQuota = {
                regularLeave: 4,
                specialLeave: employees[currentUser].department === 'Telesale' ? 2 : 0,
                sickLeave: 30,
                vacationLeave: 6,
                personalLeave: 6
            };
            
            const usedQuota = {
                regularLeave: maxQuota.regularLeave - quota.regularLeave,
                specialLeave: maxQuota.specialLeave - quota.specialLeave,
                sickLeave: maxQuota.sickLeave - quota.sickLeave,
                vacationLeave: maxQuota.vacationLeave - quota.vacationLeave,
                personalLeave: maxQuota.personalLeave - quota.personalLeave
            };
            
            document.getElementById('leaveQuota').innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="font-semibold text-blue-800">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
                            <div class="text-2xl font-bold text-blue-600">${quota.regularLeave}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å ${maxQuota.regularLeave} ‡∏ß‡∏±‡∏ô</div>
                            <div class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usedQuota.regularLeave} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                        
                        ${maxQuota.specialLeave > 0 ? `
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <div class="font-semibold text-purple-800">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (Telesale)</div>
                            <div class="text-2xl font-bold text-purple-600">${quota.specialLeave}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å ${maxQuota.specialLeave} ‡∏ß‡∏±‡∏ô</div>
                            <div class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usedQuota.specialLeave} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                        ` : ''}
                        
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <div class="font-semibold text-red-800">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                            <div class="text-2xl font-bold text-red-600">${quota.sickLeave}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å ${maxQuota.sickLeave} ‡∏ß‡∏±‡∏ô</div>
                            <div class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usedQuota.sickLeave} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div class="font-semibold text-green-800">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div>
                            <div class="text-2xl font-bold text-green-600">${quota.vacationLeave}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å ${maxQuota.vacationLeave} ‡∏ß‡∏±‡∏ô</div>
                            <div class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usedQuota.vacationLeave} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="font-semibold text-yellow-800">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                            <div class="text-2xl font-bold text-yellow-600">${quota.personalLeave}</div>
                            <div class="text-sm text-gray-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å ${maxQuota.personalLeave} ‡∏ß‡∏±‡∏ô</div>
                            <div class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usedQuota.personalLeave} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600">
                            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
                        </div>
                    </div>
                </div>
            `;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        window.updateLeaveRequirements = function() {
            const leaveType = document.getElementById('leaveType').value;
            const advanceNoticeInfo = document.getElementById('advanceNoticeInfo');
            const documentLabel = document.getElementById('documentLabel');
            const documentNote = document.getElementById('documentNote');
            const documentSection = document.getElementById('documentSection');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
            if (leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                advanceNoticeInfo.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                        <div class="font-semibold text-yellow-800">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                        <div class="text-yellow-700">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</div>
                    </div>
                `;
                documentLabel.innerHTML = '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå) <span class="text-red-500">*</span>';
                documentNote.innerHTML = '<strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ';
                documentSection.style.display = 'block';
            } else if (leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') {
                advanceNoticeInfo.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm">
                        <div class="font-semibold text-green-800">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div>
                        <div class="text-green-700">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 7 ‡∏ß‡∏±‡∏ô</div>
                    </div>
                `;
                documentSection.style.display = 'none';
            } else if (leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') {
                advanceNoticeInfo.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                        <div class="font-semibold text-blue-800">üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                        <div class="text-blue-700">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 3 ‡∏ß‡∏±‡∏ô</div>
                    </div>
                `;
                documentLabel.innerHTML = '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ò‡∏∏‡∏£‡∏∞) <span class="text-red-500">*</span>';
                documentNote.innerHTML = '<strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏≥';
                documentSection.style.display = 'block';
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            validateAdvanceNotice();
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
        window.validateAdvanceNotice = function() {
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('startDate').value;
            const advanceWarning = document.getElementById('advanceWarning');
            const advanceWarningText = document.getElementById('advanceWarningText');
            
            if (!startDate) {
                advanceWarning.classList.add('hidden');
                return;
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 00:00:00
            
            const leaveStartDate = new Date(startDate);
            leaveStartDate.setHours(0, 0, 0, 0); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 00:00:00
            
            const daysDifference = Math.ceil((leaveStartDate - tomorrow) / (1000 * 60 * 60 * 24)) + 1;
            
            let requiredDays = 0;
            let isValid = true;
            
            if (leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                // ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
                isValid = true;
            } else if (leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') {
                requiredDays = 7;
                isValid = daysDifference >= requiredDays;
            } else if (leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') {
                requiredDays = 3;
                isValid = daysDifference >= requiredDays;
            }
            
            if (!isValid && leaveType !== '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                advanceWarning.classList.remove('hidden');
                advanceWarningText.textContent = `${leaveType}‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${requiredDays} ‡∏ß‡∏±‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ${daysDifference} ‡∏ß‡∏±‡∏ô)`;
            } else {
                advanceWarning.classList.add('hidden');
            }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        window.handleFileUpload = function() {
            const fileInput = document.getElementById('documentFile');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.textContent = file.name;
                fileUploadArea.classList.add('hidden');
                fileInfo.classList.remove('hidden');
            }
        }

        // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
        window.removeFile = function() {
            const fileInput = document.getElementById('documentFile');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfo = document.getElementById('fileInfo');
            
            fileInput.value = '';
            fileUploadArea.classList.remove('hidden');
            fileInfo.classList.add('hidden');
        }

        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
        window.submitLeaveRequest = async function() {
            try {
                console.log('Starting submitLeaveRequest function...');
                
                const leaveTypeElement = document.getElementById('leaveType');
                const startDateElement = document.getElementById('startDate');
                const endDateElement = document.getElementById('endDate');
                const reasonElement = document.getElementById('reason');
                const documentFileElement = document.getElementById('documentFile');
                
                if (!leaveTypeElement || !startDateElement || !endDateElement || !reasonElement) {
                    console.error('Form elements not found');
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
                    return;
                }
                
                const leaveType = leaveTypeElement.value;
                const startDate = startDateElement.value;
                const endDate = endDateElement.value;
                const reason = reasonElement.value.trim();
                
                console.log('Form values:', { leaveType, startDate, endDate, reason });
                
                if (!startDate || !endDate || !reason) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                if ((leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' || leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') && (!documentFileElement.files || documentFileElement.files.length === 0)) {
                    alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö${leaveType}\n\n${leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' ? '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå' : '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ò‡∏∏‡∏£‡∏∞'}‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const leaveStartDate = new Date(startDate);
                leaveStartDate.setHours(0, 0, 0, 0);
                
                const daysDifference = Math.ceil((leaveStartDate - tomorrow) / (1000 * 60 * 60 * 24)) + 1;
                
                if (leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && daysDifference < 7) {
                    const confirmed = confirm(`‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô\n‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ${daysDifference} ‡∏ß‡∏±‡∏ô\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)`);
                    if (!confirmed) return;
                } else if (leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' && daysDifference < 3) {
                    const confirmed = confirm(`‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô\n‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ${daysDifference} ‡∏ß‡∏±‡∏ô\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)`);
                    if (!confirmed) return;
                }
                
                if (!currentUser || !employees[currentUser]) {
                    console.error('Current user not found:', currentUser);
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    return;
                }
                
                const leaveRequest = {
                    employeeId: currentUser,
                    employeeName: employees[currentUser].name,
                    leaveType,
                    startDate,
                    endDate,
                    reason,
                    status: 'pending',
                    requestDate: new Date().toISOString(),
                    hasDocument: (leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' || leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') && documentFileElement.files.length > 0,
                    documentName: documentFileElement.files.length > 0 ? documentFileElement.files[0].name : null,
                    advanceNoticeDays: daysDifference
                };
                
                console.log('Saving leave request:', leaveRequest);
                
                try {
                    const result = await push(ref(null, 'leaveRequests'), leaveRequest);
                    console.log('Leave request saved with key:', result.key);
                    
                    alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å HR');
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
                    leaveTypeElement.value = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢';
                    startDateElement.value = '';
                    endDateElement.value = '';
                    reasonElement.value = '';
                    removeFile();
                    updateLeaveRequirements();
                    document.getElementById('advanceWarning').classList.add('hidden');
                    
                    await loadLeaveRequests();
                    console.log('Leave request submitted successfully');
                } catch (saveError) {
                    console.error('Error saving leave request:', saveError);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤: ' + saveError.message);
                }
                
            } catch (error) {
                console.error('Error in submitLeaveRequest:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤: ' + error.message);
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
        async function loadLeaveRequests() {
            const requestsRef = ref(null, 'leaveRequests');
            const snapshot = await get(requestsRef);
            const requests = snapshot.val() || {};
            
            let requestsHTML = '';
            Object.entries(requests).forEach(([key, request]) => {
                if (request.employeeId === currentUser) {
                    let statusColor = 'bg-yellow-100 border-yellow-300';
                    let statusIcon = '‚è≥';
                    let statusText = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    
                    if (request.status === 'approved') {
                        statusColor = 'bg-green-100 border-green-300';
                        statusIcon = '‚úÖ';
                        statusText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (request.status === 'rejected') {
                        statusColor = 'bg-red-100 border-red-300';
                        statusIcon = '‚ùå';
                        statusText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    }
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    let leaveIcon = 'üìã';
                    if (request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') leaveIcon = 'ü§í';
                    else if (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') leaveIcon = 'üèñÔ∏è';
                    else if (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') leaveIcon = 'üìã';
                    
                    const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH');
                    
                    requestsHTML += `
                        <div class="border p-4 rounded-lg ${statusColor}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center">
                                    <span class="text-xl mr-2">${leaveIcon}</span>
                                    <div>
                                        <div class="font-bold text-lg">${request.leaveType}</div>
                                        <div class="text-sm text-gray-600">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${requestDate}</div>
                                    </div>
                                </div>
                                <div class="flex items-center font-semibold">
                                    <span class="mr-1">${statusIcon}</span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                            
                            <div class="space-y-2 text-sm">
                                <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${request.startDate} - ${request.endDate}</div>
                                <div><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${request.reason}</div>
                                
                                ${request.hasDocument ? `
                                    <div class="flex items-center text-green-600">
                                        <span class="mr-1">üìé</span>
                                        <span>‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${request.documentName || '‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö'}</span>
                                    </div>
                                ` : ''}
                                
                                ${request.advanceNoticeDays !== undefined ? `
                                    <div class="text-gray-600">
                                        <strong>‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤:</strong> ${request.advanceNoticeDays} ‡∏ß‡∏±‡∏ô
                                        ${(request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && request.advanceNoticeDays < 7) || 
                                          (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' && request.advanceNoticeDays < 3) ? 
                                          '<span class="text-red-600 ml-2">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</span>' : ''}
                                    </div>
                                ` : ''}
                                
                                ${request.status === 'approved' && request.approvedBy ? `
                                    <div class="text-green-700 text-xs mt-2 pt-2 border-t border-green-200">
                                        <strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${employees[request.approvedBy]?.name || request.approvedBy}
                                        ${request.approvedDate ? ` ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date(request.approvedDate).toLocaleDateString('th-TH')}` : ''}
                                    </div>
                                ` : ''}
                                
                                ${request.status === 'rejected' && request.rejectedBy ? `
                                    <div class="text-red-700 text-xs mt-2 pt-2 border-t border-red-200">
                                        <strong>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${employees[request.rejectedBy]?.name || request.rejectedBy}
                                        ${request.rejectedDate ? ` ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date(request.rejectedDate).toLocaleDateString('th-TH')}` : ''}
                                        ${request.rejectionReason ? `<br><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${request.rejectionReason}` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('leaveRequests').innerHTML = requestsHTML || '<div class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</div>';
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°
        async function loadSummaryStats() {
            try {
                const today = new Date();
                const currentDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                let todayStats = {
                    working: 0,
                    onLeave: 0,
                    holiday: 0,
                    pending: 0
                };
                
                let monthlyStats = {
                    totalLeaves: 0,
                    sickLeaves: 0,
                    vacationLeaves: 0,
                    personalLeaves: 0
                };
                
                // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                for (const empId of Object.keys(employees)) {
                    try {
                        const scheduleRef = ref(null, `workSchedule/${empId}/${currentDate}`);
                        const snapshot = await get(scheduleRef);
                        const schedule = snapshot.val() || { status: 'work' };
                        
                        if (schedule.status === 'work') {
                            todayStats.working++;
                        } else if (schedule.status === 'leave') {
                            todayStats.onLeave++;
                        } else if (schedule.status === 'holiday') {
                            todayStats.holiday++;
                        } else if (schedule.status === 'holiday_pending') {
                            todayStats.pending++;
                        }
                    } catch (error) {
                        console.error('Error loading today stats for', empId, error);
                    }
                }
                
                // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    for (const empId of Object.keys(employees)) {
                        try {
                            const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                            const snapshot = await get(scheduleRef);
                            const schedule = snapshot.val();
                            
                            if (schedule && schedule.status === 'leave') {
                                monthlyStats.totalLeaves++;
                                
                                if (schedule.leaveType === 'sick') {
                                    monthlyStats.sickLeaves++;
                                } else if (schedule.leaveType === 'vacation') {
                                    monthlyStats.vacationLeaves++;
                                } else if (schedule.leaveType === 'personal') {
                                    monthlyStats.personalLeaves++;
                                }
                            }
                        } catch (error) {
                            // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        }
                    }
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                const summaryElement = document.getElementById('summaryStats');
                if (summaryElement) {
                    summaryElement.innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                            
                            <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-700 mb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${new Date().toLocaleDateString('th-TH')})</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-green-600">${todayStats.working}</div>
                                        <div class="text-sm text-gray-600">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                                    </div>
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-orange-600">${todayStats.onLeave}</div>
                                        <div class="text-sm text-gray-600">‡∏•‡∏≤</div>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-red-600">${todayStats.holiday}</div>
                                        <div class="text-sm text-gray-600">‡∏´‡∏¢‡∏∏‡∏î</div>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-yellow-600">${todayStats.pending}</div>
                                        <div class="text-sm text-gray-600">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ -->
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-blue-600">${monthlyStats.totalLeaves}</div>
                                        <div class="text-sm text-gray-600">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-red-600">${monthlyStats.sickLeaves}</div>
                                        <div class="text-sm text-gray-600">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                                    </div>
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-green-600">${monthlyStats.vacationLeaves}</div>
                                        <div class="text-sm text-gray-600">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-yellow-600">${monthlyStats.personalLeaves}</div>
                                        <div class="text-sm text-gray-600">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading summary stats:', error);
                const summaryElement = document.getElementById('summaryStats');
                if (summaryElement) {
                    summaryElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <div class="text-red-800 font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î HR Panel
        async function loadHRPanel() {
            loadPendingLeaveRequests();
            loadAllLeaveRequests();
            loadEmployeeManagement();
            loadHRCalendar();
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        async function loadPendingLeaveRequests() {
            const requestsRef = ref(null, 'leaveRequests');
            const snapshot = await get(requestsRef);
            const requests = snapshot.val() || {};
            
            let pendingHTML = '';
            Object.entries(requests).forEach(([key, request]) => {
                if (request.status === 'pending') {
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    let leaveIcon = 'üìã';
                    let leaveColor = 'bg-blue-50 border-blue-200';
                    if (request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                        leaveIcon = 'ü§í';
                        leaveColor = 'bg-red-50 border-red-200';
                    } else if (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') {
                        leaveIcon = 'üèñÔ∏è';
                        leaveColor = 'bg-green-50 border-green-200';
                    } else if (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') {
                        leaveIcon = 'üìã';
                        leaveColor = 'bg-blue-50 border-blue-200';
                    }
                    
                    const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH');
                    
                    pendingHTML += `
                        <div class="border p-4 rounded-lg ${leaveColor} shadow-sm">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="font-bold text-lg flex items-center">
                                        <span class="mr-2">${leaveIcon}</span>
                                        ${request.employeeName}
                                    </div>
                                    <div class="text-sm text-gray-600">${request.employeeId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">
                                        ‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${requestDate}</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
                                    <div class="text-sm">${request.leaveType}</div>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
                                    <div class="text-sm">${request.startDate} - ${request.endDate}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="text-sm font-semibold text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</div>
                                <div class="text-sm bg-white p-2 rounded border">${request.reason}</div>
                            </div>
                            
                            ${request.hasDocument ? `
                                <div class="mb-3">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</div>
                                    <div class="flex items-center text-green-600 text-sm mb-2">
                                        <span class="mr-1">üìé</span>
                                        <span>${request.documentName || '‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö'}</span>
                                    </div>
                                    
                                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏à‡∏≥‡∏•‡∏≠‡∏á) -->
                                    <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <div class="mb-2">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            <div class="font-semibold">${request.documentName || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö'}</div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                ${request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' ? '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå' : 
                                                  request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' ? '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ò‡∏∏‡∏£‡∏∞' : '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö'}
                                            </div>
                                        </div>
                                        <button onclick="viewDocument('${key}')" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                            üëÅÔ∏è ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.advanceNoticeDays !== undefined ? `
                                <div class="mb-3">
                                    <div class="text-sm text-gray-600">
                                        <strong>‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤:</strong> ${request.advanceNoticeDays} ‡∏ß‡∏±‡∏ô
                                        ${(request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && request.advanceNoticeDays < 7) || 
                                          (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' && request.advanceNoticeDays < 3) ? 
                                          '<span class="text-red-600 ml-2">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</span>' : 
                                          '<span class="text-green-600 ml-2">‚úÖ ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</span>'}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex space-x-2 pt-3 border-t">
                                <button onclick="approveLeave('${key}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm font-semibold flex items-center">
                                    <span class="mr-1">‚úÖ</span> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button onclick="rejectLeave('${key}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm font-semibold flex items-center">
                                    <span class="mr-1">‚ùå</span> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button onclick="viewLeaveDetails('${key}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm font-semibold flex items-center">
                                    <span class="mr-1">üëÅÔ∏è</span> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('pendingLeaves').innerHTML = pendingHTML || '<div class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        window.loadAllLeaveRequests = async function() {
            try {
                const requestsRef = ref(null, 'leaveRequests');
                const snapshot = await get(requestsRef);
                const requests = snapshot.val() || {};
                
                let allRequestsHTML = '';
                const sortedRequests = Object.entries(requests).sort(([,a], [,b]) => 
                    new Date(b.requestDate) - new Date(a.requestDate)
                );
                
                sortedRequests.forEach(([key, request]) => {
                    let statusColor = 'bg-yellow-100 border-yellow-300';
                    let statusText = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    let statusIcon = '‚è≥';
                    
                    if (request.status === 'approved') {
                        statusColor = 'bg-green-100 border-green-300';
                        statusText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                        statusIcon = '‚úÖ';
                    } else if (request.status === 'rejected') {
                        statusColor = 'bg-red-100 border-red-300';
                        statusText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                        statusIcon = '‚ùå';
                    }
                    
                    const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH');
                    const approvedDate = request.approvedDate ? new Date(request.approvedDate).toLocaleDateString('th-TH') : '';
                    const rejectedDate = request.rejectedDate ? new Date(request.rejectedDate).toLocaleDateString('th-TH') : '';
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    let leaveIcon = 'üìã';
                    if (request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') leaveIcon = 'ü§í';
                    else if (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') leaveIcon = 'üèñÔ∏è';
                    else if (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') leaveIcon = 'üìã';
                    
                    allRequestsHTML += `
                        <div class="border p-4 rounded-lg ${statusColor}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="font-bold text-lg">${request.employeeName}</div>
                                    <div class="text-sm text-gray-600">${request.employeeId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="flex items-center font-semibold">
                                        ${statusIcon} ${statusText}
                                    </div>
                                    <div class="text-xs text-gray-500">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${requestDate}</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
                                    <div class="text-sm flex items-center">
                                        <span class="mr-2">${leaveIcon}</span>
                                        <span>${request.leaveType}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-700">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</div>
                                    <div class="text-sm">${request.startDate} - ${request.endDate}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="text-sm font-semibold text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</div>
                                <div class="text-sm bg-white p-2 rounded border">${request.reason}</div>
                            </div>
                            
                            ${request.hasDocument ? `
                                <div class="mb-3">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</div>
                                    <div class="flex items-center justify-between bg-gray-50 border rounded-lg p-3">
                                        <div class="flex items-center">
                                            <span class="mr-2">üìé</span>
                                            <div>
                                                <div class="font-semibold text-sm">${request.documentName || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö'}</div>
                                                <div class="text-xs text-gray-600">
                                                    ${request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' ? '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå' : 
                                                      request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' ? '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ò‡∏∏‡∏£‡∏∞' : '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö'}
                                                </div>
                                            </div>
                                        </div>
                                        <button onclick="viewDocument('${key}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 flex items-center">
                                            <span class="mr-1">üëÅÔ∏è</span> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.advanceNoticeDays !== undefined ? `
                                <div class="mb-3">
                                    <div class="text-sm text-gray-600">
                                        <strong>‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤:</strong> ${request.advanceNoticeDays} ‡∏ß‡∏±‡∏ô
                                        ${(request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && request.advanceNoticeDays < 7) || 
                                          (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' && request.advanceNoticeDays < 3) ? 
                                          '<span class="text-red-600 ml-2">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</span>' : 
                                          '<span class="text-green-600 ml-2">‚úÖ ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</span>'}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${request.status === 'approved' ? `
                                <div class="text-sm text-green-700">
                                    <strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${employees[request.approvedBy]?.name || request.approvedBy}
                                    <br><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> ${approvedDate}
                                </div>
                            ` : ''}
                            
                            ${request.status === 'rejected' ? `
                                <div class="text-sm text-red-700">
                                    <strong>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${employees[request.rejectedBy]?.name || request.rejectedBy}
                                    <br><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${rejectedDate}
                                    <br><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${request.rejectionReason}
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 flex space-x-2 pt-3 border-t">
                                ${request.status === 'pending' ? `
                                    <button onclick="approveLeave('${key}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm font-semibold flex items-center">
                                        <span class="mr-1">‚úÖ</span> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </button>
                                    <button onclick="rejectLeave('${key}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm font-semibold flex items-center">
                                        <span class="mr-1">‚ùå</span> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </button>
                                    <button onclick="viewLeaveDetails('${key}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm font-semibold flex items-center">
                                        <span class="mr-1">üëÅÔ∏è</span> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                    </button>
                                    ${request.hasDocument ? `
                                        <button onclick="viewDocument('${key}')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-sm font-semibold flex items-center">
                                            <span class="mr-1">üìé</span> ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                        </button>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                const allRequestsElement = document.getElementById('allLeaveRequests');
                if (allRequestsElement) {
                    allRequestsElement.innerHTML = allRequestsHTML || '<div class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</div>';
                }
            } catch (error) {
                console.error('Error loading all leave requests:', error);
                const allRequestsElement = document.getElementById('allLeaveRequests');
                if (allRequestsElement) {
                    allRequestsElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        window.approveLeave = async function(requestKey) {
            try {
                const requestRef = ref(null, `leaveRequests/${requestKey}`);
                const snapshot = await get(requestRef);
                const request = snapshot.val();
                
                if (!request) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤');
                    return;
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠
                await update(requestRef, { 
                    status: 'approved',
                    approvedBy: currentUser,
                    approvedDate: new Date().toISOString()
                });
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤
                const startDate = new Date(request.startDate);
                const endDate = new Date(request.endDate);
                let leaveDays = 0;
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    leaveDays++;
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                const quotaRef = ref(null, `leaveQuota/${request.employeeId}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                if (quota) {
                    const newQuota = { ...quota };
                    
                    // ‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    if (request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                        newQuota.sickLeave = Math.max(0, quota.sickLeave - leaveDays);
                    } else if (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') {
                        newQuota.vacationLeave = Math.max(0, quota.vacationLeave - leaveDays);
                    } else if (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') {
                        newQuota.personalLeave = Math.max(0, quota.personalLeave - leaveDays);
                    }
                    
                    await update(quotaRef, newQuota);
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const scheduleRef = ref(null, `workSchedule/${request.employeeId}/${dateStr}`);
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î leaveType ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                    let leaveType = 'sick';
                    if (request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') leaveType = 'sick';
                    else if (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') leaveType = 'vacation';
                    else if (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') leaveType = 'personal';
                    
                    await update(scheduleRef, { 
                        status: 'leave',
                        leaveType: leaveType,
                        approvedBy: currentUser
                    });
                }
                
                alert(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${leaveDays} ‡∏ß‡∏±‡∏ô)`);
                loadPendingLeaveRequests();
                loadAllLeaveRequests();
                loadHRCalendar();
                loadEmployeeManagement(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            } catch (error) {
                console.error('Error approving leave:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
            }
        }

        // ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        window.rejectLeave = async function(requestKey) {
            const reason = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:');
            if (!reason) return;
            
            try {
                await update(ref(null, `leaveRequests/${requestKey}`), { 
                    status: 'rejected',
                    rejectedBy: currentUser,
                    rejectedDate: new Date().toISOString(),
                    rejectionReason: reason
                });
                
                alert('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                loadPendingLeaveRequests();
                loadAllLeaveRequests();
            } catch (error) {
                console.error('Error rejecting leave:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        async function loadEmployeeManagement() {
            try {
                console.log('Loading employee management...');
                console.log('Current employees:', employees);
                console.log('Current user role:', employees[currentUser]?.role);
                console.log('Current user department:', employees[currentUser]?.department);
                
                const isHR = employees[currentUser]?.role === 'HR';
                const isManager = employees[currentUser]?.role === 'Manager';
                const currentUserDept = employees[currentUser]?.department;
                
                let empHTML = '';
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HR
                if (isHR) {
                    empHTML += `
                        <div class="mb-6 flex space-x-4">
                            <button onclick="showAddEmployeeForm()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold shadow-lg transition-all duration-200">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                            </button>
                            <button onclick="showBulkDeleteForm()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold shadow-lg transition-all duration-200">
                                üóëÔ∏è ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
                            </button>
                        </div>
                    `;
                } else if (isManager) {
                    empHTML += `
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="text-blue-800 font-semibold">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Manager</div>
                            <div class="text-blue-700 text-sm mt-1">
                                ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å ${currentUserDept} ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                            </div>
                        </div>
                    `;
                }
                
                empHTML += `
                    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${Object.keys(employees).length}</div>
                            <div class="text-sm text-gray-600">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">${Object.values(employees).filter(emp => emp.department === 'Admin').length}</div>
                            <div class="text-sm text-gray-600">‡πÅ‡∏ú‡∏ô‡∏Å Admin</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600">${Object.values(employees).filter(emp => emp.department === 'Marketing').length}</div>
                            <div class="text-sm text-gray-600">‡πÅ‡∏ú‡∏ô‡∏Å Marketing</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600">${Object.values(employees).filter(emp => emp.department === 'Telesale').length}</div>
                            <div class="text-sm text-gray-600">‡πÅ‡∏ú‡∏ô‡∏Å Telesale</div>
                        </div>
                    </div>
                    
                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h4 class="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        ${isManager ? '' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™</th>'}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        ${isManager ? '' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÅ‡∏ú‡∏ô‡∏Å</th>'}
                                        ${isManager ? '' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>'}
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                        ${isManager ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>' : '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>'}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™
                let sortedEmployees = Object.entries(employees).sort(([a, empA], [b, empB]) => {
                    if (empA.department !== empB.department) {
                        return empA.department.localeCompare(empB.department);
                    }
                    return a.localeCompare(b);
                });
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Manager - ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                if (isManager) {
                    sortedEmployees = sortedEmployees.filter(([id, emp]) => emp.department === currentUserDept);
                }
                
                console.log('Sorted employees:', sortedEmployees);
                
                for (const [empId, emp] of sortedEmployees) {
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
                    let deptColor = 'bg-gray-100';
                    let roleColor = 'bg-blue-100 text-blue-800';
                    
                    switch(emp.department) {
                        case 'HR': deptColor = 'bg-red-100 text-red-800'; break;
                        case 'Admin': deptColor = 'bg-green-100 text-green-800'; break;
                        case 'Marketing': deptColor = 'bg-purple-100 text-purple-800'; break;
                        case 'Telesale': deptColor = 'bg-orange-100 text-orange-800'; break;
                    }
                    
                    if (emp.role === 'HR') roleColor = 'bg-red-100 text-red-800';
                    else if (emp.role === 'Manager') roleColor = 'bg-yellow-100 text-yellow-800';
                    else roleColor = 'bg-blue-100 text-blue-800';
                    
                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                    let quotaInfo = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                    try {
                        const quotaRef = ref(null, `leaveQuota/${empId}`);
                        const quotaSnapshot = await get(quotaRef);
                        const quota = quotaSnapshot.val();
                        if (quota) {
                            quotaInfo = `‡∏õ‡∏Å‡∏ï‡∏¥: ${quota.regularLeave}, ‡∏õ‡πà‡∏ß‡∏¢: ${quota.sickLeave}, ‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô: ${quota.vacationLeave}`;
                            if (quota.specialLeave > 0) quotaInfo += `, ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${quota.specialLeave}`;
                        } else {
                            quotaInfo = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤';
                        }
                    } catch (error) {
                        console.error('Error loading quota for', empId, error);
                        quotaInfo = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ';
                    }
                    
                    empHTML += `
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            ${isManager ? '' : `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-bold text-blue-600">${empId}</div>
                            </td>
                            `}
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">${emp.name}</div>
                                ${isManager ? '' : `<div class="text-xs text-gray-500" title="‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">${quotaInfo}</div>`}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${emp.position}</div>
                            </td>
                            ${isManager ? '' : `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${deptColor}">
                                    ${emp.department}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${roleColor}">
                                    ${emp.role}
                                </span>
                            </td>
                            `}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${emp.workTime}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="editEmployee('${empId}')" class="bg-yellow-500 text-white px-3 py-1 rounded-md text-xs hover:bg-yellow-600 transition-colors duration-150">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                ${isManager ? '' : `
                                <button onclick="deleteEmployee('${empId}')" class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 transition-colors duration-150" ${empId === currentUser ? 'disabled title="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ"' : ''}>
                                    üóëÔ∏è ‡∏•‡∏ö
                                </button>
                                <button onclick="viewEmployeeDetails('${empId}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 transition-colors duration-150">
                                    üëÅÔ∏è ‡∏î‡∏π
                                </button>
                                `}
                            </td>
                        </tr>
                    `;
                }
                
                empHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                console.log('Setting employee list HTML...');
                const employeeListElement = document.getElementById('employeeList');
                if (employeeListElement) {
                    employeeListElement.innerHTML = empHTML;
                    console.log('Employee list updated successfully');
                } else {
                    console.error('employeeList element not found');
                }
            } catch (error) {
                console.error('Error in loadEmployeeManagement:', error);
                const employeeListElement = document.getElementById('employeeList');
                if (employeeListElement) {
                    employeeListElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                            <button onclick="loadEmployeeManagement()" class="mt-3 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                    `;
                }
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        window.showAddEmployeeForm = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                    <form id="addEmployeeForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="newEmpId" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="newEmpName" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                            <select id="newEmpDepartment" class="w-full px-3 py-2 border rounded-lg" required onchange="updatePositionOptions('new')">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                                <option value="HR">HR</option>
                                <option value="Admin">Admin</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Telesale">Telesale</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <select id="newEmpPosition" class="w-full px-3 py-2 border rounded-lg" required onchange="updateWorkTimeOptions('new')">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                            <select id="newEmpRole" class="w-full px-3 py-2 border rounded-lg" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
                                <option value="HR">HR</option>
                                <option value="Manager">Manager</option>
                                <option value="Employee">Employee</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                            <select id="newEmpWorkTime" class="w-full px-3 py-2 border rounded-lg" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                            </select>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button onclick="addEmployee()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
        window.updatePositionOptions = function(formType) {
            const departmentSelect = document.getElementById(`${formType}EmpDepartment`);
            const positionSelect = document.getElementById(`${formType}EmpPosition`);
            const workTimeSelect = document.getElementById(`${formType}EmpWorkTime`);
            
            const department = departmentSelect.value;
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤
            positionSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>';
            workTimeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>';
            
            const positions = {
                'HR': ['HR'],
                'Admin': ['Admin Manager', 'Admin Team 1', 'Admin Team 2'],
                'Marketing': ['Marketing Manager', 'Editor', 'Content Creator'],
                'Telesale': ['Telesale']
            };
            
            if (positions[department]) {
                positions[department].forEach(position => {
                    const option = document.createElement('option');
                    option.value = position;
                    option.textContent = position;
                    positionSelect.appendChild(option);
                });
            }
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
        window.updateWorkTimeOptions = function(formType) {
            const positionSelect = document.getElementById(`${formType}EmpPosition`);
            const workTimeSelect = document.getElementById(`${formType}EmpWorkTime`);
            
            const position = positionSelect.value;
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤
            workTimeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>';
            
            const workTimes = {
                'HR': ['08:30-17:30'],
                'Admin Manager': ['08:30-17:30'],
                'Admin Team 1': ['06:00-15:00', '14:00-23:00'],
                'Admin Team 2': ['06:00-15:00', '14:00-23:00'],
                'Marketing Manager': ['10:30-19:30'],
                'Editor': ['10:30-19:30'],
                'Content Creator': ['08:30-17:30'],
                'Telesale': ['08:30-17:30']
            };
            
            if (workTimes[position]) {
                workTimes[position].forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    workTimeSelect.appendChild(option);
                });
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ü‡∏¥‡∏Å‡∏ã‡πå)
        window.updateWorkTimeDisplay = function(formType) {
            const positionSelect = document.getElementById(`${formType}EmpPosition`);
            const workTimeInput = document.getElementById(`${formType}EmpWorkTime`);
            
            const position = positionSelect.value;
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ü‡∏¥‡∏Å‡∏ã‡πå)
            const fixedWorkTimes = {
                'HR': '08:30-17:30',
                'Admin Manager': '08:30-17:30',
                'Admin Team 1': '06:00-15:00 ‡∏´‡∏£‡∏∑‡∏≠ 14:00-23:00 (‡∏ï‡∏≤‡∏°‡∏Å‡∏∞)',
                'Admin Team 2': '06:00-15:00 ‡∏´‡∏£‡∏∑‡∏≠ 14:00-23:00 (‡∏ï‡∏≤‡∏°‡∏Å‡∏∞)',
                'Marketing Manager': '10:30-19:30',
                'Editor': '10:30-19:30',
                'Content Creator': '08:30-17:30',
                'Telesale': '08:30-17:30'
            };
            
            if (fixedWorkTimes[position]) {
                workTimeInput.value = fixedWorkTimes[position];
            } else {
                workTimeInput.value = '';
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        window.addEmployee = async function() {
            const empId = document.getElementById('newEmpId').value.trim().toUpperCase();
            const name = document.getElementById('newEmpName').value.trim();
            const position = document.getElementById('newEmpPosition').value;
            const department = document.getElementById('newEmpDepartment').value;
            const role = document.getElementById('newEmpRole').value;
            const workTime = document.getElementById('newEmpWorkTime').value;
            
            if (!empId || !name || !position || !department || !role || !workTime) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            if (employees[empId]) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            
            try {
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                let team = null;
                let shift = null;
                let finalWorkTime = workTime;
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ü‡∏¥‡∏Å‡∏ã‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
                if (position === 'HR') {
                    finalWorkTime = '08:30-17:30';
                } else if (position === 'Admin Manager') {
                    finalWorkTime = '08:30-17:30';
                    team = 'Manager';
                    shift = null;
                } else if (position === 'Admin Team 1') {
                    team = 'Team1';
                    shift = 'morning'; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤
                    finalWorkTime = '06:00-15:00';
                } else if (position === 'Admin Team 2') {
                    team = 'Team2';
                    shift = 'evening'; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢
                    finalWorkTime = '14:00-23:00';
                } else if (position === 'Marketing Manager') {
                    finalWorkTime = '10:30-19:30';
                } else if (position === 'Editor') {
                    finalWorkTime = '10:30-19:30';
                } else if (position === 'Content Creator') {
                    finalWorkTime = '08:30-17:30';
                } else if (position === 'Telesale') {
                    finalWorkTime = '08:30-17:30';
                }
                
                const newEmployee = { 
                    name, 
                    position, 
                    role, 
                    department, 
                    workTime: finalWorkTime,
                    team,
                    shift
                };
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                employees[empId] = newEmployee;
                await set(ref(null, `employees/${empId}`), newEmployee);
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                const quota = {
                    regularLeave: 4,
                    specialLeave: department === 'Telesale' ? 2 : 0,
                    sickLeave: 30,
                    vacationLeave: 6,
                    personalLeave: 6
                };
                await set(ref(null, `leaveQuota/${empId}`), quota);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                await generateWorkSchedule(currentYear, currentMonth);
                
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeEmployeeModal();
                loadEmployeeManagement();
            } catch (error) {
                console.error('Error adding employee:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        window.editEmployee = function(empId) {
            const emp = employees[empId];
            const isManager = employees[currentUser]?.role === 'Manager';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                    
                    ${isManager ? `
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="text-blue-800 text-sm font-semibold">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Manager</div>
                        <div class="text-blue-700 text-xs mt-1">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                    </div>
                    ` : ''}
                    
                    <form id="editEmployeeForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="editEmpId" value="${empId}" class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="editEmpName" value="${emp.name}" class="w-full px-3 py-2 border rounded-lg ${isManager ? 'bg-gray-100' : ''}" ${isManager ? 'readonly' : 'required'}>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                            <select id="editEmpDepartment" class="w-full px-3 py-2 border rounded-lg ${isManager ? 'bg-gray-100' : ''}" ${isManager ? 'disabled' : 'required'} onchange="updatePositionOptions('edit')">
                                <option value="HR" ${emp.department === 'HR' ? 'selected' : ''}>HR</option>
                                <option value="Admin" ${emp.department === 'Admin' ? 'selected' : ''}>Admin</option>
                                <option value="Marketing" ${emp.department === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Telesale" ${emp.department === 'Telesale' ? 'selected' : ''}>Telesale</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <select id="editEmpPosition" class="w-full px-3 py-2 border rounded-lg" required onchange="updateWorkTimeDisplay('edit')">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                            <select id="editEmpRole" class="w-full px-3 py-2 border rounded-lg ${isManager ? 'bg-gray-100' : ''}" ${isManager ? 'disabled' : 'required'}>
                                <option value="HR" ${emp.role === 'HR' ? 'selected' : ''}>HR</option>
                                <option value="Manager" ${emp.role === 'Manager' ? 'selected' : ''}>Manager</option>
                                <option value="Employee" ${emp.role === 'Employee' ? 'selected' : ''}>Employee</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="editEmpWorkTime" class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
                            <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end space-x-2">
                        <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button onclick="updateEmployee('${empId}')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            setTimeout(() => {
                updatePositionOptions('edit');
                setTimeout(() => {
                    document.getElementById('editEmpPosition').value = emp.position;
                    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÅ‡∏ö‡∏ö readonly)
                    document.getElementById('editEmpWorkTime').value = emp.workTime;
                }, 100);
            }, 100);
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        window.updateEmployee = async function(empId) {
            try {
                console.log('Starting updateEmployee for:', empId);
                
                const isManager = employees[currentUser]?.role === 'Manager';
                const currentEmp = employees[empId];
                
                if (!currentEmp) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ DOM elements ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                const nameElement = document.getElementById('editEmpName');
                const departmentElement = document.getElementById('editEmpDepartment');
                const roleElement = document.getElementById('editEmpRole');
                const positionElement = document.getElementById('editEmpPosition');
                
                if (!nameElement || !departmentElement || !roleElement || !positionElement) {
                    console.error('Required form elements not found');
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    return;
                }
                
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Manager - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
                const name = isManager ? currentEmp.name : nameElement.value.trim();
                const department = isManager ? currentEmp.department : departmentElement.value;
                const role = isManager ? currentEmp.role : roleElement.value;
                
                // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà Manager ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
                const position = positionElement.value;
                
                console.log('Form values:', { name, department, role, position });
                
                if (!name || !position || !department || !role) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ü‡∏¥‡∏Å‡∏ã‡πå)
                let team = currentEmp.team; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
                let shift = currentEmp.shift; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
                let finalWorkTime;
                let finalPosition = position; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ü‡∏¥‡∏Å‡∏ã‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á - ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
                if (position === 'HR') {
                    finalWorkTime = '08:30-17:30';
                    team = null;
                    shift = null;
                } else if (position === 'Admin Manager') {
                    finalWorkTime = '08:30-17:30';
                    team = 'Manager';
                    shift = null;
                } else if (position === 'Admin Team 1') {
                    team = 'Team1';
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Team 1 ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤
                    if (currentEmp.position !== 'Admin Team 1') {
                        shift = 'morning';
                        finalWorkTime = '06:00-15:00';
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Team 1 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        finalWorkTime = currentEmp.shift === 'morning' ? '06:00-15:00' : '14:00-23:00';
                    }
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    finalPosition = `Admin Team 1 (${shift === 'morning' ? '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' : '‡∏Å‡∏∞‡πÄ‡∏¢‡πá‡∏ô'})`;
                } else if (position === 'Admin Team 2') {
                    team = 'Team2';
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Team 2 ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢
                    if (currentEmp.position !== 'Admin Team 2') {
                        shift = 'evening';
                        finalWorkTime = '14:00-23:00';
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Team 2 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        finalWorkTime = currentEmp.shift === 'morning' ? '06:00-15:00' : '14:00-23:00';
                    }
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    finalPosition = `Admin Team 2 (${shift === 'morning' ? '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' : '‡∏Å‡∏∞‡πÄ‡∏¢‡πá‡∏ô'})`;
                } else if (position === 'Marketing Manager') {
                    finalWorkTime = '10:30-19:30';
                    team = null;
                    shift = null;
                } else if (position === 'Editor') {
                    finalWorkTime = '10:30-19:30';
                    team = null;
                    shift = null;
                } else if (position === 'Content Creator') {
                    finalWorkTime = '08:30-17:30';
                    team = null;
                    shift = null;
                } else if (position === 'Telesale') {
                    finalWorkTime = '08:30-17:30';
                    team = null;
                    shift = null;
                } else {
                    // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    finalWorkTime = currentEmp.workTime || '08:30-17:30';
                }
                
                const updatedEmployee = { 
                    name, 
                    position: finalPosition, // ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
                    role, 
                    department, 
                    workTime: finalWorkTime,
                    team,
                    shift
                };
                
                console.log('Updated employee data:', updatedEmployee);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥)
                employees[empId] = updatedEmployee;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô Database
                await update(ref(null, `employees/${empId}`), updatedEmployee);
                console.log('Employee data updated in database');
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HR)
                if (!isManager && currentEmp.department !== department) {
                    const quotaRef = ref(null, `leaveQuota/${empId}`);
                    const quotaSnapshot = await get(quotaRef);
                    const currentQuota = quotaSnapshot.val();
                    
                    if (currentQuota) {
                        const newSpecialLeave = department === 'Telesale' ? 2 : 0;
                        await update(quotaRef, { specialLeave: newSpecialLeave });
                        console.log('Updated quota for department change');
                    }
                }
                
                alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeEmployeeModal();
                await loadEmployeeManagement();
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin
                if (department === 'Admin' && !isManager) {
                    await loadShiftManagement();
                }
                
                console.log('Employee update completed successfully');
                
            } catch (error) {
                console.error('Error updating employee:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }
        }

        // ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        window.deleteEmployee = async function(empId) {
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${employees[empId].name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`)) {
                return;
            }
            
            try {
                // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                delete employees[empId];
                await set(ref(null, `employees/${empId}`), null);
                await set(ref(null, `leaveQuota/${empId}`), null);
                await set(ref(null, `workSchedule/${empId}`), null);
                
                alert('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                loadEmployeeManagement();
                loadHRCalendar();
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
            }
        }

        // ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        window.viewEmployeeDetails = async function(empId) {
            try {
                const emp = employees[empId];
                const quotaRef = ref(null, `leaveQuota/${empId}`);
                const quotaSnapshot = await get(quotaRef);
                const quota = quotaSnapshot.val();
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ
                const maxQuota = {
                    regularLeave: 4,
                    specialLeave: emp.department === 'Telesale' ? 2 : 0,
                    sickLeave: 30,
                    vacationLeave: 6,
                    personalLeave: 6
                };
                
                const usedQuota = {
                    regularLeave: maxQuota.regularLeave - quota.regularLeave,
                    specialLeave: maxQuota.specialLeave - quota.specialLeave,
                    sickLeave: maxQuota.sickLeave - quota.sickLeave,
                    vacationLeave: maxQuota.vacationLeave - quota.vacationLeave,
                    personalLeave: maxQuota.personalLeave - quota.personalLeave
                };
                
                // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                let allLeaveHistory = [];
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                for (let monthOffset = 0; monthOffset < 12; monthOffset++) {
                    const checkDate = new Date(currentYear, currentMonth - monthOffset, 1);
                    const checkYear = checkDate.getFullYear();
                    const checkMonth = checkDate.getMonth();
                    const daysInCheckMonth = new Date(checkYear, checkMonth + 1, 0).getDate();
                    
                    for (let day = 1; day <= daysInCheckMonth; day++) {
                        const date = `${checkYear}-${String(checkMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        try {
                            const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                            const snapshot = await get(scheduleRef);
                            const schedule = snapshot.val();
                            
                            if (schedule && (schedule.status === 'leave' || schedule.status === 'holiday')) {
                                allLeaveHistory.push({
                                    date: date,
                                    status: schedule.status,
                                    leaveType: schedule.leaveType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                                    year: checkYear,
                                    month: checkMonth + 1,
                                    day: day
                                });
                            }
                        } catch (error) {
                            // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        }
                    }
                }
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                allLeaveHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                const leaveByMonth = {};
                allLeaveHistory.forEach(leave => {
                    const monthKey = `${leave.year}-${String(leave.month).padStart(2, '0')}`;
                    if (!leaveByMonth[monthKey]) {
                        leaveByMonth[monthKey] = [];
                    }
                    leaveByMonth[monthKey].push(leave);
                });
                
                // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const currentMonthLeaves = leaveByMonth[currentMonthKey] || [];
                
                const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                                  '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                            <button onclick="closeEmployeeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-bold text-blue-800 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h4>
                                <div class="space-y-2">
                                    <div><span class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</span> ${empId}</div>
                                    <div><span class="font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span> ${emp.name}</div>
                                    <div><span class="font-semibold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</span> ${emp.position}</div>
                                    <div><span class="font-semibold">‡πÅ‡∏ú‡∏ô‡∏Å:</span> <span class="px-2 py-1 rounded-full text-xs ${emp.department === 'HR' ? 'bg-red-100 text-red-800' : emp.department === 'Admin' ? 'bg-green-100 text-green-800' : emp.department === 'Marketing' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'}">${emp.department}</span></div>
                                    <div><span class="font-semibold">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</span> <span class="px-2 py-1 rounded-full text-xs ${emp.role === 'HR' ? 'bg-red-100 text-red-800' : emp.role === 'Manager' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${emp.role}</span></div>
                                    <div><span class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</span> ${emp.workTime}</div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-bold text-green-800 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥:</span>
                                        <span class="font-semibold">${quota.regularLeave}/${maxQuota.regularLeave} ‡∏ß‡∏±‡∏ô</span>
                                    </div>
                                    ${maxQuota.specialLeave > 0 ? `
                                    <div class="flex justify-between">
                                        <span>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©:</span>
                                        <span class="font-semibold">${quota.specialLeave}/${maxQuota.specialLeave} ‡∏ß‡∏±‡∏ô</span>
                                    </div>
                                    ` : ''}
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</span>
                                        <span class="font-semibold">${quota.sickLeave}/${maxQuota.sickLeave} ‡∏ß‡∏±‡∏ô</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô:</span>
                                        <span class="font-semibold">${quota.vacationLeave}/${maxQuota.vacationLeave} ‡∏ß‡∏±‡∏ô</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏≤‡∏Å‡∏¥‡∏à:</span>
                                        <span class="font-semibold">${quota.personalLeave}/${maxQuota.personalLeave} ‡∏ß‡∏±‡∏ô</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-gray-800 mb-3">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h4>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${usedQuota.regularLeave}</div>
                                    <div class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
                                </div>
                                ${maxQuota.specialLeave > 0 ? `
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${usedQuota.specialLeave}</div>
                                    <div class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
                                </div>
                                ` : ''}
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600">${usedQuota.sickLeave}</div>
                                    <div class="text-xs text-gray-600">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${usedQuota.vacationLeave}</div>
                                    <div class="text-xs text-gray-600">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-yellow-600">${usedQuota.personalLeave}</div>
                                    <div class="text-xs text-gray-600">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</h4>
                            
                            ${Object.keys(leaveByMonth).length > 0 ? `
                                <div class="space-y-6">
                                    ${Object.entries(leaveByMonth)
                                        .sort(([a], [b]) => b.localeCompare(a)) // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                                        .map(([monthKey, leaves]) => {
                                            const [year, month] = monthKey.split('-');
                                            const monthName = monthNames[parseInt(month) - 1];
                                            const isCurrentMonth = monthKey === currentMonthKey;
                                            
                                            return `
                                                <div class="border rounded-lg p-4 ${isCurrentMonth ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'}">
                                                    <h5 class="font-semibold text-lg mb-3 ${isCurrentMonth ? 'text-blue-800' : 'text-gray-800'}">
                                                        ${monthName} ${parseInt(year) + 543} ${isCurrentMonth ? '(‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}
                                                        <span class="text-sm font-normal ml-2">(${leaves.length} ‡∏ß‡∏±‡∏ô)</span>
                                                    </h5>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                                        ${leaves.map(leave => {
                                                            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                                                            let bgColor = 'bg-gray-50';
                                                            let textColor = 'text-gray-600';
                                                            let typeColor = 'text-gray-500';
                                                            
                                                            if (leave.status === 'leave') {
                                                                // ‡∏Å‡∏≤‡∏£‡∏•‡∏≤ - ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                                                                if (leave.leaveType === 'sick') {
                                                                    bgColor = 'bg-red-50 border-red-200';
                                                                    textColor = 'text-red-800';
                                                                    typeColor = 'text-red-600';
                                                                } else if (leave.leaveType === 'vacation') {
                                                                    bgColor = 'bg-green-50 border-green-200';
                                                                    textColor = 'text-green-800';
                                                                    typeColor = 'text-green-600';
                                                                } else if (leave.leaveType === 'personal') {
                                                                    bgColor = 'bg-yellow-50 border-yellow-200';
                                                                    textColor = 'text-yellow-800';
                                                                    typeColor = 'text-yellow-600';
                                                                } else {
                                                                    bgColor = 'bg-orange-50 border-orange-200';
                                                                    textColor = 'text-orange-800';
                                                                    typeColor = 'text-orange-600';
                                                                }
                                                            } else if (leave.status === 'holiday') {
                                                                // ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î - ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                                                                if (leave.leaveType === 'regular') {
                                                                    bgColor = 'bg-blue-50 border-blue-200';
                                                                    textColor = 'text-blue-800';
                                                                    typeColor = 'text-blue-600';
                                                                } else if (leave.leaveType === 'special') {
                                                                    bgColor = 'bg-purple-50 border-purple-200';
                                                                    textColor = 'text-purple-800';
                                                                    typeColor = 'text-purple-600';
                                                                } else {
                                                                    bgColor = 'bg-red-50 border-red-200';
                                                                    textColor = 'text-red-800';
                                                                    typeColor = 'text-red-600';
                                                                }
                                                            }
                                                            
                                                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                                                            const leaveTypeNames = {
                                                                'regular': '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏Å‡∏ï‡∏¥',
                                                                'special': '‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                                                                'sick': '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢',
                                                                'vacation': '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô',
                                                                'personal': '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'
                                                            };
                                                            
                                                            return `
                                                                <div class="${bgColor} p-3 rounded border">
                                                                    <div class="font-semibold ${textColor}">${leave.day} ${monthName}</div>
                                                                    <div class="text-sm ${textColor}">${leave.status === 'leave' ? '‡∏•‡∏≤' : '‡∏´‡∏¢‡∏∏‡∏î'}</div>
                                                                    <div class="text-xs ${typeColor} font-medium">${leaveTypeNames[leave.leaveType] || leave.leaveType}</div>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                </div>
                            ` : `
                                <div class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
                            `}
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-2">
                            <button onclick="editEmployee('${empId}')" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                            <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing employee details:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
        window.showBulkDeleteForm = function() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
            const deletableEmployees = Object.entries(employees).filter(([id, emp]) => id !== currentUser);
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</h3>
                    <p class="text-gray-600 text-sm mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ)</p>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-2">
                            <span class="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-h-96 overflow-y-auto">
                        ${deletableEmployees.map(([empId, emp]) => `
                            <label class="flex items-start p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="deleteEmployee" value="${empId}" class="mr-3 mt-1">
                                <div class="flex-1">
                                    <div class="font-semibold">${emp.name}</div>
                                    <div class="text-sm text-gray-600">${empId}</div>
                                    <div class="text-sm text-gray-500">${emp.position}</div>
                                    <div class="text-xs text-gray-400">${emp.department}</div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="text-red-800 font-semibold">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                        <div class="text-red-700 text-sm mt-1">
                            ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á:
                            <ul class="list-disc list-inside mt-2">
                                <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</li>
                                <li>‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</li>
                                <li>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</li>
                                <li>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</li>
                            </ul>
                            <strong>‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!</strong>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button onclick="closeEmployeeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button onclick="bulkDeleteEmployees()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const employeeCheckboxes = document.querySelectorAll('input[name="deleteEmployee"]');
            
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
        window.bulkDeleteEmployees = async function() {
            const selectedEmployees = Array.from(document.querySelectorAll('input[name="deleteEmployee"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedEmployees.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                return;
            }
            
            const employeeNames = selectedEmployees.map(id => employees[id].name).join(', ');
            const confirmed = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${selectedEmployees.length} ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n${employeeNames}\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`);
            
            if (!confirmed) return;
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const empId of selectedEmployees) {
                    try {
                        // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        delete employees[empId];
                        await set(ref(null, `employees/${empId}`), null);
                        await set(ref(null, `leaveQuota/${empId}`), null);
                        await set(ref(null, `workSchedule/${empId}`), null);
                        await set(ref(null, `confirmedSchedule/${empId}`), null);
                        
                        // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                        const requestsRef = ref(null, 'leaveRequests');
                        const requestsSnapshot = await get(requestsRef);
                        const requests = requestsSnapshot.val() || {};
                        
                        for (const [requestId, request] of Object.entries(requests)) {
                            if (request.employeeId === empId) {
                                await set(ref(null, `leaveRequests/${requestId}`), null);
                            }
                        }
                        
                        successCount++;
                    } catch (error) {
                        console.error(`Error deleting employee ${empId}:`, error);
                        errorCount++;
                    }
                }
                
                alert(`‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏Ñ‡∏ô${errorCount > 0 ? `\n‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${errorCount} ‡∏Ñ‡∏ô` : ''}`);
                
                closeEmployeeModal();
                await loadEmployeeManagement();
                await loadHRCalendar();
                await loadSummaryStats();
                
            } catch (error) {
                console.error('Error in bulk delete:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ' + error.message);
            }
        }

        // ‡∏õ‡∏¥‡∏î modal
        window.closeEmployeeModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô HR
        async function loadHRCalendar() {
            const calendar = document.getElementById('hrCalendar');
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            
            let calendarHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="changeMonth(-1)" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
                        <h4 class="font-bold">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏° - ${document.getElementById('monthYear').textContent}</h4>
                        <button onclick="changeMonth(1)" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="inline-block w-3 h-3 bg-green-200 mr-1"></span>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                        <span class="inline-block w-3 h-3 bg-red-200 mr-1 ml-3"></span>‡∏´‡∏¢‡∏∏‡∏î
                        <span class="inline-block w-3 h-3 bg-orange-200 mr-1 ml-3"></span>‡∏•‡∏≤
                        <span class="inline-block w-3 h-3 bg-yellow-200 mr-1 ml-3"></span>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏≠‡∏≤</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏à</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏≠</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏û</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏û‡∏§</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏®</div>
                    <div class="text-center font-bold p-2 bg-gray-200 text-xs">‡∏™</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            for (let day = 1; day <= daysInMonth; day++) {
                const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                let workCount = 0;
                let leaveCount = 0;
                let holidayCount = 0;
                let pendingCount = 0;
                
                const isPublicHoliday = publicHolidays[date];
                
                try {
                    for (const empId of Object.keys(employees)) {
                        const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                        const snapshot = await get(scheduleRef);
                        const schedule = snapshot.val() || { status: 'work', type: 'regular' };
                        
                        if (schedule.status === 'work') {
                            workCount++;
                        } else if (schedule.status === 'leave') {
                            leaveCount++;
                        } else if (schedule.status === 'holiday') {
                            holidayCount++;
                        } else if (schedule.status === 'holiday_pending') {
                            pendingCount++;
                        }
                    }
                    
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                    let bgColor = 'bg-white';
                    if (isPublicHoliday) {
                        bgColor = 'bg-yellow-100';
                    } else if (workCount > holidayCount + leaveCount) {
                        bgColor = 'bg-green-50';
                    } else if (holidayCount > workCount) {
                        bgColor = 'bg-red-50';
                    } else if (leaveCount > 0) {
                        bgColor = 'bg-orange-50';
                    }
                    
                    calendarHTML += `
                        <div class="border p-2 min-h-[100px] ${bgColor} cursor-pointer hover:bg-opacity-80 transition-colors" onclick="showDayDetails('${date}')">
                            <div class="font-bold text-sm mb-1">${day}</div>
                            ${isPublicHoliday ? `<div class="text-xs text-blue-600 font-semibold mb-1">${isPublicHoliday}</div>` : ''}
                            <div class="space-y-1">
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                    <span>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${workCount}</span>
                                </div>
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1"></span>
                                    <span>‡∏´‡∏¢‡∏∏‡∏î: ${holidayCount}</span>
                                </div>
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-1"></span>
                                    <span>‡∏•‡∏≤: ${leaveCount}</span>
                                </div>
                                ${pendingCount > 0 ? `
                                <div class="text-xs flex items-center">
                                    <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"></span>
                                    <span>‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${pendingCount}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading HR calendar day:', error);
                    calendarHTML += `
                        <div class="border p-2 min-h-[100px] bg-gray-100 cursor-pointer" onclick="showDayDetails('${date}')">
                            <div class="font-bold text-sm">${day}</div>
                            <div class="text-xs text-red-500">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
                        </div>
                    `;
                }
            }
            
            calendarHTML += `
                </div>
            `;
            calendar.innerHTML = calendarHTML;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ô
        window.showDayDetails = async function(date) {
            try {
                const isPublicHoliday = publicHolidays[date];
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                const departmentData = {
                    'HR': { work: [], holiday: [], leave: [], pending: [] },
                    'Admin': { work: [], holiday: [], leave: [], pending: [] },
                    'Marketing': { work: [], holiday: [], leave: [], pending: [] },
                    'Telesale': { work: [], holiday: [], leave: [], pending: [] }
                };
                
                let totalCounts = { work: 0, holiday: 0, leave: 0, pending: 0 };
                
                for (const [empId, emp] of Object.entries(employees)) {
                    const scheduleRef = ref(null, `workSchedule/${empId}/${date}`);
                    const snapshot = await get(scheduleRef);
                    const schedule = snapshot.val() || { status: 'work', type: 'regular' };
                    
                    const empInfo = {
                        id: empId,
                        name: emp.name,
                        position: emp.position,
                        department: emp.department,
                        workTime: emp.workTime,
                        schedule: schedule
                    };
                    
                    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    if (departmentData[emp.department]) {
                        if (schedule.status === 'work') {
                            departmentData[emp.department].work.push(empInfo);
                            totalCounts.work++;
                        } else if (schedule.status === 'holiday') {
                            departmentData[emp.department].holiday.push(empInfo);
                            totalCounts.holiday++;
                        } else if (schedule.status === 'leave') {
                            departmentData[emp.department].leave.push(empInfo);
                            totalCounts.leave++;
                        } else if (schedule.status === 'holiday_pending') {
                            departmentData[emp.department].pending.push(empInfo);
                            totalCounts.pending++;
                        }
                    }
                }
                
                const formatDate = new Date(date).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                const createEmployeeCards = (empList, statusType) => {
                    if (empList.length === 0) return '<div class="text-gray-500 text-sm text-center py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ</div>';
                    
                    return empList.map(emp => {
                        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
                        let deptColor = 'bg-gray-100 text-gray-800';
                        switch(emp.department) {
                            case 'HR': deptColor = 'bg-red-100 text-red-800'; break;
                            case 'Admin': deptColor = 'bg-green-100 text-green-800'; break;
                            case 'Marketing': deptColor = 'bg-purple-100 text-purple-800'; break;
                            case 'Telesale': deptColor = 'bg-orange-100 text-orange-800'; break;
                        }
                        
                        return `
                            <div class="bg-white p-3 rounded-lg border shadow-sm">
                                <div class="font-semibold text-sm mb-1">${emp.name}</div>
                                <div class="text-xs text-gray-600 mb-1">${emp.position}</div>
                                <div class="flex items-center justify-between">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${deptColor}">
                                        ${emp.department}
                                    </span>
                                    <span class="text-xs text-gray-500">${emp.workTime}</span>
                                </div>
                                ${statusType === 'work' && isPublicHoliday ? '<div class="text-xs text-green-600 font-semibold mt-1">üí∞ ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤</div>' : ''}
                                ${statusType === 'leave' && emp.schedule.leaveType ? `
                                    <div class="text-xs text-orange-600 font-semibold mt-1">
                                        ${emp.schedule.leaveType === 'sick' ? 'ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' : 
                                          emp.schedule.leaveType === 'vacation' ? 'üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' : 
                                          emp.schedule.leaveType === 'personal' ? 'üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à' : 
                                          emp.schedule.leaveType}
                                    </div>
                                ` : ''}
                                ${statusType === 'holiday' && emp.schedule.leaveType ? `
                                    <div class="text-xs text-red-600 font-semibold mt-1 flex items-center">
                                        <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1"></span>
                                        <span>‡∏´‡∏¢‡∏∏‡∏î</span>
                                    </div>
                                ` : ''}
                                ${statusType === 'pending' ? '<div class="text-xs text-yellow-600 font-semibold mt-1">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>' : ''}
                            </div>
                        `;
                    }).join('');
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å
                const createDepartmentSection = (deptName, deptData) => {
                    const totalInDept = deptData.work.length + deptData.holiday.length + deptData.leave.length + deptData.pending.length;
                    if (totalInDept === 0) return '';
                    
                    let deptColor = 'border-gray-200 bg-gray-50';
                    let deptIcon = 'üè¢';
                    switch(deptName) {
                        case 'HR': 
                            deptColor = 'border-red-200 bg-red-50'; 
                            deptIcon = 'üë•'; 
                            break;
                        case 'Admin': 
                            deptColor = 'border-green-200 bg-green-50'; 
                            deptIcon = 'üñ•Ô∏è'; 
                            break;
                        case 'Marketing': 
                            deptColor = 'border-purple-200 bg-purple-50'; 
                            deptIcon = 'üì¢'; 
                            break;
                        case 'Telesale': 
                            deptColor = 'border-orange-200 bg-orange-50'; 
                            deptIcon = 'üìû'; 
                            break;
                    }
                    
                    return `
                        <div class="border rounded-lg p-4 ${deptColor} mb-4">
                            <h4 class="font-bold text-lg mb-4 flex items-center">
                                <span class="mr-2">${deptIcon}</span>
                                ${deptName} (${totalInDept} ‡∏Ñ‡∏ô)
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <!-- ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -->
                                ${deptData.work.length > 0 ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-green-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (${deptData.work.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.work, 'work')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- ‡∏´‡∏¢‡∏∏‡∏î -->
                                ${deptData.holiday.length > 0 ? `
                                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-red-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                        ‡∏´‡∏¢‡∏∏‡∏î (${deptData.holiday.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.holiday, 'holiday')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- ‡∏•‡∏≤ -->
                                ${deptData.leave.length > 0 ? `
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-orange-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
                                        ‡∏•‡∏≤ (${deptData.leave.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.leave, 'leave')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                                ${deptData.pending.length > 0 ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <h5 class="font-semibold text-yellow-800 mb-2 flex items-center text-sm">
                                        <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                        ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${deptData.pending.length})
                                    </h5>
                                    <div class="space-y-2">
                                        ${createEmployeeCards(deptData.pending, 'pending')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                };
                
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-7xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold">üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate}</h3>
                            <button onclick="closeDayDetailsModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                        </div>
                        
                        ${isPublicHoliday ? `
                        <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 mb-6">
                            <div class="font-semibold text-yellow-800 text-lg">üéâ ${isPublicHoliday}</div>
                            <div class="text-sm text-yellow-700 mt-1">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏¢‡∏∏‡∏î</div>
                        </div>
                        ` : ''}
                        
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏° -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-lg mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-green-100 border border-green-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-green-600">${totalCounts.work}</div>
                                    <div class="text-sm text-green-700 font-semibold">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                                </div>
                                <div class="bg-red-100 border border-red-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-red-600">${totalCounts.holiday}</div>
                                    <div class="text-sm text-red-700 font-semibold">‡∏´‡∏¢‡∏∏‡∏î</div>
                                </div>
                                <div class="bg-orange-100 border border-orange-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-orange-600">${totalCounts.leave}</div>
                                    <div class="text-sm text-orange-700 font-semibold">‡∏•‡∏≤</div>
                                </div>
                                <div class="bg-blue-100 border border-blue-200 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-blue-600">${Object.keys(employees).length}</div>
                                    <div class="text-sm text-blue-700 font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å -->
                        <div class="space-y-4">
                            ${createDepartmentSection('HR', departmentData.HR)}
                            ${createDepartmentSection('Admin', departmentData.Admin)}
                            ${createDepartmentSection('Marketing', departmentData.Marketing)}
                            ${createDepartmentSection('Telesale', departmentData.Telesale)}
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="closeDayDetailsModal()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error showing day details:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
            }
        }

        // ‡∏õ‡∏¥‡∏î modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ô
        window.closeDayDetailsModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö
        window.viewDocument = function(requestKey) {
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ - ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å server
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-lg font-bold">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</h3>
                        <button onclick="closeDocumentModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="p-6">
                        <!-- ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
                        <div class="text-center mb-4">
                            <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8">
                                <!-- ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå -->
                                <div class="bg-white border rounded-lg p-6 shadow-sm max-w-md mx-auto">
                                    <div class="text-center mb-4">
                                        <div class="text-blue-600 font-bold text-lg">üè• ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>
                                        <div class="text-sm text-gray-600">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
                                    </div>
                                    
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between">
                                            <span class="font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</span>
                                            <span>‡∏ô‡∏≤‡∏¢/‡∏ô‡∏≤‡∏á ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à:</span>
                                            <span>${new Date().toLocaleDateString('th-TH')}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</span>
                                            <span>‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="font-semibold">‡∏Ñ‡∏ß‡∏£‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</span>
                                            <span class="text-red-600 font-semibold">1-2 ‡∏ß‡∏±‡∏ô</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 pt-4 border-t text-center">
                                        <div class="text-xs text-gray-500">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>
                                        <div class="font-semibold">‡∏ô‡∏û.‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÉ‡∏à‡∏î‡∏µ</div>
                                        <div class="text-xs text-gray-500">‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 12345</div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 text-sm text-gray-600">
                                    <div class="font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</div>
                                    <div>‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
                        <div class="flex justify-center space-x-4 mt-6">
                            <button onclick="downloadDocument('${requestKey}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center">
                                <span class="mr-2">üíæ</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                            </button>
                            <button onclick="printDocument('${requestKey}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                                <span class="mr-2">üñ®Ô∏è</span> ‡∏û‡∏¥‡∏°‡∏û‡πå
                            </button>
                            <button onclick="closeDocumentModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                ‡∏õ‡∏¥‡∏î
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
        window.viewLeaveDetails = async function(requestKey) {
            try {
                const requestRef = ref(null, `leaveRequests/${requestKey}`);
                const snapshot = await get(requestRef);
                const request = snapshot.val();
                
                if (!request) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤');
                    return;
                }
                
                const requestDate = new Date(request.requestDate).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                let leaveIcon = 'üìã';
                if (request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') leaveIcon = 'ü§í';
                else if (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') leaveIcon = 'üèñÔ∏è';
                else if (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') leaveIcon = 'üìã';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-xl font-bold flex items-center">
                                <span class="mr-2">${leaveIcon}</span>
                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
                            </h3>
                            <button onclick="closeDocumentModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="p-6">
                            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-bold text-blue-800 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏•‡∏≤</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-semibold">‡∏ä‡∏∑‡πà‡∏≠:</span> ${request.employeeName}</div>
                                        <div><span class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</span> ${request.employeeId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                                        <div><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠:</span> ${requestDate}</div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <h4 class="font-bold text-green-800 mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span> ${request.leaveType}</div>
                                        <div><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span> ${request.startDate}</div>
                                        <div><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</span> ${request.endDate}</div>
                                        <div><span class="font-semibold">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤:</span> ${request.advanceNoticeDays || 0} ‡∏ß‡∏±‡∏ô</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h4>
                                <div class="bg-gray-50 border rounded-lg p-4">
                                    <p class="text-gray-700">${request.reason}</p>
                                </div>
                            </div>
                            
                            <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö -->
                            ${request.hasDocument ? `
                                <div class="mb-6">
                                    <h4 class="font-bold text-gray-800 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</h4>
                                    <div class="bg-gray-50 border rounded-lg p-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <span class="mr-2">üìé</span>
                                                <div>
                                                    <div class="font-semibold">${request.documentName || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö'}</div>
                                                    <div class="text-sm text-gray-600">
                                                        ${request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' ? '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå' : 
                                                          request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' ? '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ò‡∏∏‡∏£‡∏∞' : '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö'}
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="viewDocument('${requestKey}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                                üëÅÔ∏è ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="mb-6">
                                    <h4 class="font-bold text-gray-800 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</h4>
                                    <div class="bg-gray-50 border rounded-lg p-4 text-center text-gray-500">
                                        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö
                                    </div>
                                </div>
                            `}
                            
                            <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-2">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
                                <div class="space-y-2">
                                    <!-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
                                    <div class="flex items-center">
                                        ${(request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') ? 
                                            '<span class="text-green-600 mr-2">‚úÖ</span><span class="text-green-700">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>' :
                                            (request.leaveType === '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' && request.advanceNoticeDays >= 7) ? 
                                            '<span class="text-green-600 mr-2">‚úÖ</span><span class="text-green-700">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 7 ‡∏ß‡∏±‡∏ô)</span>' :
                                            (request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' && request.advanceNoticeDays >= 3) ? 
                                            '<span class="text-green-600 mr-2">‚úÖ</span><span class="text-green-700">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 3 ‡∏ß‡∏±‡∏ô)</span>' :
                                            '<span class="text-red-600 mr-2">‚ùå</span><span class="text-red-700">‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</span>'
                                        }
                                    </div>
                                    
                                    <!-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
                                    <div class="flex items-center">
                                        ${(request.leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' || request.leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') ? 
                                            (request.hasDocument ? 
                                                '<span class="text-green-600 mr-2">‚úÖ</span><span class="text-green-700">‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span>' :
                                                '<span class="text-red-600 mr-2">‚ùå</span><span class="text-red-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ)</span>'
                                            ) :
                                            '<span class="text-green-600 mr-2">‚úÖ</span><span class="text-green-700">‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
                            ${request.status === 'pending' ? `
                                <div class="flex justify-center space-x-4 pt-4 border-t">
                                    <button onclick="approveLeave('${requestKey}'); closeDocumentModal();" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold flex items-center">
                                        <span class="mr-2">‚úÖ</span> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ
                                    </button>
                                    <button onclick="rejectLeave('${requestKey}'); closeDocumentModal();" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold flex items-center">
                                        <span class="mr-2">‚ùå</span> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </button>
                                    <button onclick="closeDocumentModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold">
                                        ‡∏õ‡∏¥‡∏î
                                    </button>
                                </div>
                            ` : `
                                <div class="flex justify-center pt-4 border-t">
                                    <button onclick="closeDocumentModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold">
                                        ‡∏õ‡∏¥‡∏î
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing leave details:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
            }
        }

        // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        window.closeDocumentModal = function() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
        window.downloadDocument = function(requestKey) {
            alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\n\n‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
        }

        // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
        window.printDocument = function(requestKey) {
            alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\n\n‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
        }

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        window.confirmMonthSelection = async function() {
            try {
                console.log('=== Starting confirmMonthSelection ===');
                console.log('Current user:', currentUser);
                console.log('Current month/year:', currentMonth, currentYear);
                
                if (!currentUser) {
                    console.error('No current user found');
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    return;
                }
                
                if (!employees || !employees[currentUser]) {
                    console.error('Employee data not found for:', currentUser);
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    return;
                }
                
                const confirmed = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ');
                if (!confirmed) {
                    console.log('User cancelled confirmation');
                    return;
                }
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                console.log('Saving confirmation for month:', monthKey, 'user:', currentUser);
                
                const confirmationData = {
                    confirmed: true,
                    confirmedDate: new Date().toISOString(),
                    employeeId: currentUser,
                    employeeName: employees[currentUser].name || 'Unknown',
                    month: currentMonth,
                    year: currentYear
                };
                
                console.log('Confirmation data to save:', confirmationData);
                
                const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
                await set(confirmRef, confirmationData);
                console.log('Confirmation saved successfully');
                
                alert('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ');
                
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°
                await loadCalendar();
                console.log('Calendar reloaded after confirmation');
                
            } catch (error) {
                console.error('Error in confirmMonthSelection:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô: ' + error.message);
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        window.editMonthSelection = async function() {
            try {
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const confirmRef = ref(null, `confirmedSchedule/${currentUser}/${monthKey}`);
                const snapshot = await get(confirmRef);
                
                if (snapshot.exists()) {
                    const confirmed = confirm('‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
                    if (confirmed) {
                        await set(confirmRef, null);
                        alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                        await loadCalendar();
                    }
                } else {
                    alert('‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥');
                }
            } catch (error) {
                console.error('Error editing month selection:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        function updateShiftsForMonth(year, month) {
            console.log(`Updating shifts for ${year}-${month + 1}`);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô Admin ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            for (const empId of Object.keys(employees)) {
                shiftSystem.updateEmployeeShift(empId, year, month);
            }
            
            console.log('Shifts updated:', employees);
        }

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        window.changeMonth = function(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
            updateShiftsForMonth(currentYear, currentMonth);
            
            generateWorkSchedule(currentYear, currentMonth);
            loadCalendar();
            if (currentUser && employees[currentUser].role === 'HR') {
                loadHRCalendar();
                loadEmployeeManagement(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏∞‡πÉ‡∏´‡∏°‡πà
            }
        }

        // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        window.logout = function() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('hrPanel').classList.add('hidden');
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏∞
        async function loadShiftManagement() {
            try {
                const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                                  '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                
                // ‡πÅ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô Admin ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°
                const adminEmployees = Object.entries(employees).filter(([id, emp]) => emp.department === 'Admin');
                const team1 = adminEmployees.filter(([id, emp]) => emp.team === 'Team1');
                const team2 = adminEmployees.filter(([id, emp]) => emp.team === 'Team2');
                const manager = adminEmployees.filter(([id, emp]) => emp.team === 'Manager');
                
                let shiftHTML = `
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <div class="mb-4">
                                <h4 class="font-bold text-blue-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ${monthNames[currentMonth]} ${currentYear + 543}</h4>
                            </div>
                            
                            <!-- Manager -->
                            <div class="mb-4">
                                <h5 class="font-semibold text-gray-700 mb-2">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å</h5>
                                <div class="bg-white p-3 rounded border">
                                    ${manager.map(([id, emp]) => `
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold">${emp.name}</div>
                                                <div class="text-sm text-gray-600">${emp.position}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold text-blue-600">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</div>
                                                <div class="text-sm text-gray-500">${emp.workTime}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Team 1 -->
                            <div class="mb-4">
                                <div class="mb-2">
                                    <h5 class="font-semibold text-gray-700">Admin Team 1</h5>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    ${team1.map(([id, emp]) => `
                                        <div class="flex justify-between items-center mb-2 last:mb-0">
                                            <div>
                                                <div class="font-semibold">${emp.name}</div>
                                                <div class="text-sm text-gray-600">${emp.position}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold ${emp.shift === 'morning' ? 'text-green-600' : 'text-orange-600'}">
                                                    ${shiftSystem.shifts[emp.shift].name}
                                                </div>
                                                <div class="text-sm text-gray-500">${emp.workTime}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Team 2 -->
                            <div>
                                <div class="mb-2">
                                    <h5 class="font-semibold text-gray-700">Admin Team 2</h5>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    ${team2.map(([id, emp]) => `
                                        <div class="flex justify-between items-center mb-2 last:mb-0">
                                            <div>
                                                <div class="font-semibold">${emp.name}</div>
                                                <div class="text-sm text-gray-600">${emp.position}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-semibold ${emp.shift === 'morning' ? 'text-green-600' : 'text-orange-600'}">
                                                    ${shiftSystem.shifts[emp.shift].name}
                                                </div>
                                                <div class="text-sm text-gray-500">${emp.workTime}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞ -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h4 class="font-bold text-green-800 mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h4>
                            
                            <div class="mb-4">
                                <div class="text-sm text-gray-600 mb-2">
                                    <strong>‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞:</strong>
                                </div>
                                <ul class="text-sm text-gray-600 space-y-1 mb-4">
                                    <li>‚Ä¢ Team 1: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏π‡πà = ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏µ‡πà = ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢</li>
                                    <li>‚Ä¢ Team 2: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏π‡πà = ‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏µ‡πà = ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤</li>
                                    <li>‚Ä¢ ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å: ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</li>
                                </ul>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="px-3 py-2 text-left">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                            <th class="px-3 py-2 text-center">Team 1</th>
                                            <th class="px-3 py-2 text-center">Team 2</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞ 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                for (let month = 0; month < 12; month++) {
                    const team1Shift = shiftSystem.getShiftForMonth('Team1', currentYear, month);
                    const team2Shift = shiftSystem.getShiftForMonth('Team2', currentYear, month);
                    const isCurrentMonth = month === currentMonth;
                    
                    shiftHTML += `
                        <tr class="${isCurrentMonth ? 'bg-yellow-100 font-semibold' : 'bg-white'}">
                            <td class="px-3 py-2 border">${monthNames[month]} ${isCurrentMonth ? '(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)' : ''}</td>
                            <td class="px-3 py-2 border text-center">
                                <span class="px-2 py-1 rounded text-xs ${team1Shift === 'morning' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                    ${shiftSystem.shifts[team1Shift].name}
                                </span>
                            </td>
                            <td class="px-3 py-2 border text-center">
                                <span class="px-2 py-1 rounded text-xs ${team2Shift === 'morning' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                    ${shiftSystem.shifts[team2Shift].name}
                                </span>
                            </td>
                        </tr>
                    `;
                }
                
                shiftHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    

                `;
                
                const shiftElement = document.getElementById('shiftManagement');
                if (shiftElement) {
                    shiftElement.innerHTML = shiftHTML;
                }
            } catch (error) {
                console.error('Error loading shift management:', error);
                const shiftElement = document.getElementById('shiftManagement');
                if (shiftElement) {
                    shiftElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏∞</div>
                            <div class="text-red-600 text-sm mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°
        window.changeTeamShift = async function(team) {
            try {
                console.log('=== Starting changeTeamShift ===');
                console.log('Team:', team);
                console.log('Current employees object:', employees);
                console.log('Available employee IDs:', Object.keys(employees));
                
                if (!team) {
                    console.error('No team specified');
                    alert('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡∏°');
                    return;
                }
                
                const confirmed = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞‡∏Ç‡∏≠‡∏á ${team} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`);
                if (!confirmed) {
                    console.log('User cancelled team shift change');
                    return;
                }
                
                // ‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏° - ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤
                const teamMembers = Object.entries(employees).filter(([id, emp]) => {
                    console.log(`Checking employee ${id}:`, emp);
                    const isAdminDept = emp.department === 'Admin';
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
                    let isCorrectTeam = false;
                    if (emp.team === team) {
                        isCorrectTeam = true;
                    } else if (team === 'Team1' && (emp.position.includes('Team 1') || emp.team === 'Team1')) {
                        isCorrectTeam = true;
                    } else if (team === 'Team2' && (emp.position.includes('Team 2') || emp.team === 'Team2')) {
                        isCorrectTeam = true;
                    }
                    
                    console.log(`  - Admin dept: ${isAdminDept}, Correct team: ${isCorrectTeam}`);
                    return isAdminDept && isCorrectTeam;
                });
                
                console.log('Team members found:', teamMembers.length);
                console.log('Team members details:', teamMembers);
                
                if (teamMembers.length === 0) {
                    console.error(`No team members found for team: ${team}`);
                    alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏° ${team}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"`);
                    return;
                }
                
                let successCount = 0;
                for (const [empId, emp] of teamMembers) {
                    try {
                        // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞
                        const currentShift = emp.shift || 'morning';
                        const newShift = currentShift === 'morning' ? 'evening' : 'morning';
                        const newWorkTime = shiftSystem.shifts[newShift].time;
                        
                        console.log(`Updating ${empId} (${emp.name}) from ${currentShift} to ${newShift}`);
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
                        employees[empId].shift = newShift;
                        employees[empId].workTime = newWorkTime;
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏∞‡πÉ‡∏´‡∏°‡πà
                        if (emp.team === 'Team1' || emp.position.includes('Team 1')) {
                            employees[empId].position = `Admin Team 1 (${shiftSystem.shifts[newShift].name})`;
                        } else if (emp.team === 'Team2' || emp.position.includes('Team 2')) {
                            employees[empId].position = `Admin Team 2 (${shiftSystem.shifts[newShift].name})`;
                        }
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        await update(ref(null, `employees/${empId}`), {
                            shift: newShift,
                            workTime: newWorkTime,
                            position: employees[empId].position
                        });
                        
                        console.log(`Successfully updated ${empId}`);
                        successCount++;
                    } catch (updateError) {
                        console.error(`Error updating ${empId}:`, updateError);
                    }
                }
                
                console.log(`Updated ${successCount}/${teamMembers.length} team members`);
                alert(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞‡∏Ç‡∏≠‡∏á ${team} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${successCount}/${teamMembers.length} ‡∏Ñ‡∏ô)`);
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                await loadShiftManagement();
                await loadEmployeeManagement();
                
            } catch (error) {
                console.error('Error in changeTeamShift:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞: ' + error.message);
            }
        }
        
        // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡∏°
        window.switchTeamShifts = async function() {
            try {
                console.log('=== Starting switchTeamShifts ===');
                console.log('Current employees:', employees);
                console.log('Available employee IDs:', Object.keys(employees));
                
                const confirmed = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Team 1 ‡πÅ‡∏•‡∏∞ Team 2 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ');
                if (!confirmed) {
                    console.log('User cancelled team shifts switch');
                    return;
                }
                
                // ‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡∏° - ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤
                const team1Members = Object.entries(employees).filter(([id, emp]) => {
                    console.log(`Checking Team1 employee ${id}:`, emp);
                    const isAdminDept = emp.department === 'Admin';
                    const isTeam1 = emp.team === 'Team1' || emp.position.includes('Team 1');
                    console.log(`  - Admin dept: ${isAdminDept}, Team1: ${isTeam1}`);
                    return isAdminDept && isTeam1;
                });
                const team2Members = Object.entries(employees).filter(([id, emp]) => {
                    console.log(`Checking Team2 employee ${id}:`, emp);
                    const isAdminDept = emp.department === 'Admin';
                    const isTeam2 = emp.team === 'Team2' || emp.position.includes('Team 2');
                    console.log(`  - Admin dept: ${isAdminDept}, Team2: ${isTeam2}`);
                    return isAdminDept && isTeam2;
                });
                
                console.log('Team1 members found:', team1Members.length);
                console.log('Team1 members details:', team1Members);
                console.log('Team2 members found:', team2Members.length);
                console.log('Team2 members details:', team2Members);
                
                if (team1Members.length === 0 && team2Members.length === 0) {
                    console.error('No Admin team members found');
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô Admin ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"');
                    return;
                }
                
                let successCount = 0;
                let totalCount = team1Members.length + team2Members.length;
                
                // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞ Team 1
                for (const [empId, emp] of team1Members) {
                    try {
                        const currentShift = emp.shift || 'morning';
                        const newShift = currentShift === 'morning' ? 'evening' : 'morning';
                        const newWorkTime = shiftSystem.shifts[newShift].time;
                        
                        console.log(`Switching Team1 ${empId} (${emp.name}) from ${currentShift} to ${newShift}`);
                        
                        employees[empId].shift = newShift;
                        employees[empId].workTime = newWorkTime;
                        employees[empId].position = `Admin Team 1 (${shiftSystem.shifts[newShift].name})`;
                        
                        await update(ref(null, `employees/${empId}`), {
                            shift: newShift,
                            workTime: newWorkTime,
                            position: employees[empId].position
                        });
                        
                        console.log(`Successfully updated Team1 ${empId}`);
                        successCount++;
                    } catch (updateError) {
                        console.error(`Error updating Team1 ${empId}:`, updateError);
                    }
                }
                
                // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞ Team 2
                for (const [empId, emp] of team2Members) {
                    try {
                        const currentShift = emp.shift || 'evening';
                        const newShift = currentShift === 'morning' ? 'evening' : 'morning';
                        const newWorkTime = shiftSystem.shifts[newShift].time;
                        
                        console.log(`Switching Team2 ${empId} (${emp.name}) from ${currentShift} to ${newShift}`);
                        
                        employees[empId].shift = newShift;
                        employees[empId].workTime = newWorkTime;
                        employees[empId].position = `Admin Team 2 (${shiftSystem.shifts[newShift].name})`;
                        
                        await update(ref(null, `employees/${empId}`), {
                            shift: newShift,
                            workTime: newWorkTime,
                            position: employees[empId].position
                        });
                        
                        console.log(`Successfully updated Team2 ${empId}`);
                        successCount++;
                    } catch (updateError) {
                        console.error(`Error updating Team2 ${empId}:`, updateError);
                    }
                }
                
                console.log(`Updated ${successCount}/${totalCount} team members`);
                alert(`‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${successCount}/${totalCount} ‡∏Ñ‡∏ô)`);
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                await loadShiftManagement();
                await loadEmployeeManagement();
                
            } catch (error) {
                console.error('Error in switchTeamShifts:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏∞: ' + error.message);
            }
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        window.updateAllShifts = async function() {
            try {
                console.log('=== Starting updateAllShifts ===');
                console.log('Current employees:', employees);
                console.log('Current month/year:', currentMonth, currentYear);
                console.log('Available employee IDs:', Object.keys(employees));
                
                const confirmed = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
                if (!confirmed) {
                    console.log('User cancelled update all shifts');
                    return;
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Å‡πà‡∏≠‡∏ô
                updateShiftsForMonth(currentYear, currentMonth);
                console.log('Shifts updated in memory');
                console.log('Updated employees object:', employees);
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                let updatedCount = 0;
                let totalAdminCount = 0;
                
                for (const [empId, emp] of Object.entries(employees)) {
                    console.log(`Processing employee ${empId}:`, emp);
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô Admin ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ team ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ team)
                    if (emp.department === 'Admin') {
                        totalAdminCount++;
                        console.log(`Updating ${empId} (${emp.name}) shift to ${emp.shift}, workTime: ${emp.workTime}`);
                        
                        try {
                            await update(ref(null, `employees/${empId}`), {
                                shift: emp.shift,
                                workTime: emp.workTime,
                                position: emp.position
                            });
                            updatedCount++;
                            console.log(`Successfully updated ${empId}`);
                        } catch (updateError) {
                            console.error(`Error updating ${empId}:`, updateError);
                        }
                    } else {
                        console.log(`Skipping ${empId} - not Admin (dept: ${emp.department})`);
                    }
                }
                
                console.log(`Updated ${updatedCount}/${totalAdminCount} Admin employees`);
                alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${updatedCount}/${totalAdminCount} ‡∏Ñ‡∏ô)`);
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                await loadShiftManagement();
                await loadEmployeeManagement();
                
            } catch (error) {
                console.error('Error in updateAllShifts:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏∞: ' + error.message);
            }
        }

        // ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö HR
        window.switchHRTab = function(tabName) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.getElementById('approvalsContent').classList.add('hidden');
            document.getElementById('employeesContent').classList.add('hidden');
            document.getElementById('calendarContent').classList.add('hidden');
            document.getElementById('shiftsContent').classList.add('hidden');
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ó‡πá‡∏ö
            document.getElementById('approvalsTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('employeesTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('calendarTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            document.getElementById('shiftsTab').className = 'py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ó‡πá‡∏ö
            if (tabName === 'approvals') {
                document.getElementById('approvalsContent').classList.remove('hidden');
                document.getElementById('approvalsTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadPendingLeaveRequests();
            } else if (tabName === 'employees') {
                document.getElementById('employeesContent').classList.remove('hidden');
                document.getElementById('employeesTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadEmployeeManagement();
            } else if (tabName === 'calendar') {
                document.getElementById('calendarContent').classList.remove('hidden');
                document.getElementById('calendarTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadHRCalendar();
            } else if (tabName === 'shifts') {
                document.getElementById('shiftsContent').classList.remove('hidden');
                document.getElementById('shiftsTab').className = 'py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold';
                loadShiftManagement();
            }
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö
            loadSummaryStats();
        }

        // Event listeners - ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
        document.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('loginBtn');
            const submitLeaveBtn = document.getElementById('submitLeaveBtn');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
            }
            
            if (submitLeaveBtn) {
                submitLeaveBtn.addEventListener('click', submitLeaveRequest);
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Enter key support ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
            const empIdInput = document.getElementById('empId');
            if (empIdInput) {
                empIdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤
            if (typeof updateLeaveRequirements === 'function') {
                updateLeaveRequirements();
            }
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold text-center mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h1>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input type="text" id="empId" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
                <div class="mt-2 text-sm text-gray-600">
                    <p class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</p>
                    <p><strong>HR001</strong> - HR (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HR)</p>
                    <p><strong>MA001</strong> - ‡∏≠‡∏≤‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏≤ ‡∏ô‡∏≤‡∏°‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå (Manager)</p>
                    <p><strong>EA001</strong> - ‡∏Å‡∏∏‡∏•‡∏ò‡∏¥‡∏ï‡∏≤ ‡∏ó‡∏≠‡∏á‡∏™‡∏¥‡∏°‡∏≤ (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</p>
                    <p><strong>ET001</strong> - ‡∏®‡∏£‡∏µ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏á (Telesale)</p>
                </div>
            </div>
            <button id="loginBtn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-200">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
    <div id="mainApp" class="hidden">
        <nav class="bg-blue-600 text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h1>
                <div class="flex items-center space-x-4">
                    <span id="userName"></span>
                    <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-4">
            <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
                    <h2 id="monthYear" class="text-xl font-bold"></h2>
                    <button onclick="changeMonth(1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
                </div>
                <div id="calendar"></div>
                
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                <div class="flex justify-center space-x-4 mt-6 pt-4 border-t">
                    <button id="confirmBtn" onclick="confirmMonthSelection()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold shadow-lg transition-all duration-200" style="display: inline-block;">
                        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                    <button id="editBtn" onclick="editMonthSelection()" class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 font-semibold shadow-lg transition-all duration-200" style="display: none;">
                        üîì ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                </div>
                
                <div class="mt-3 text-center text-sm text-gray-600">
                    <p><strong>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</strong> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</p>
                    <p><strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>
                </div>
            </div>

            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î -->
            <div id="leaveQuota" class="mb-6"></div>

            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏•‡∏≤ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-bold mb-4">‡∏Ç‡∏≠‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                
                <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏≤ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 mb-3">üìã ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h4>
                    <div class="space-y-2 text-sm text-blue-700">
                        <div class="flex items-start">
                            <span class="mr-2">ü§í</span>
                            <div>
                                <strong>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</strong> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ)
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="mr-2">üèñÔ∏è</span>
                            <div>
                                <strong>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="mr-2">üìã</span>
                            <div>
                                <strong>‡∏•‡∏≤‡∏Å‡∏¥‡∏à:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ò‡∏∏‡∏£‡∏∞
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="leaveForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                            <select id="leaveType" class="w-full px-3 py-2 border rounded-lg" onchange="updateLeaveRequirements()">
                                <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                                <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
                                <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à">üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                            </select>
                        </div>
                        <div id="advanceNoticeInfo" class="flex items-center">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                                <div class="font-semibold text-yellow-800">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
                                <div class="text-yellow-700">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="date" id="startDate" class="w-full px-3 py-2 border rounded-lg" onchange="validateAdvanceNotice()">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="date" id="endDate" class="w-full px-3 py-2 border rounded-lg" onchange="validateAdvanceNotice()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
                        <textarea id="reason" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤"></textarea>
                    </div>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
                    <div id="documentSection">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <span id="documentLabel">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå)</span>
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="documentFile" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload()">
                            <div id="fileUploadArea" onclick="document.getElementById('documentFile').click()" class="cursor-pointer">
                                <div class="text-gray-500 mb-2">üìé ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
                                <div class="text-sm text-gray-400">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF, JPG, PNG</div>
                            </div>
                            <div id="fileInfo" class="hidden">
                                <div class="text-green-600 font-semibold">‚úÖ ‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</div>
                                <div id="fileName" class="text-sm text-gray-600 mt-1"></div>
                                <button type="button" onclick="removeFile()" class="text-red-500 text-sm mt-2 hover:underline">‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå</button>
                            </div>
                        </div>
                        <div id="documentNote" class="text-sm text-gray-600 mt-2">
                            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
                        </div>
                    </div>
                    
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
                    <div id="advanceWarning" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-red-800 font-semibold">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</div>
                        <div id="advanceWarningText" class="text-red-700 text-sm mt-1"></div>
                    </div>
                </form>
                
                <button id="submitLeaveBtn" class="mt-6 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold shadow-lg transition-all duration-200">
                    üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
                </button>
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</h3>
                <div id="leaveRequests" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- HR Panel -->
    <div id="hrPanel" class="hidden">
        <div class="container mx-auto p-4">
            <h2 class="text-2xl font-bold mb-6">Management Panel</h2>
            
            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
            <div id="summaryStats"></div>
            
            <!-- ‡πÅ‡∏ó‡πá‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HR -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="border-b">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="switchHRTab('approvals')" id="approvalsTab" class="py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold">
                            ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                        </button>
                        <button onclick="switchHRTab('employees')" id="employeesTab" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                        </button>
                        <button onclick="switchHRTab('calendar')" id="calendarTab" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°
                        </button>
                        <button onclick="switchHRTab('shifts')" id="shiftsTab" class="py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô Admin
                        </button>
                    </nav>
                </div>
                
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤ -->
                <div id="approvalsContent" class="p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-2">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                        <p class="text-gray-600 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢ HR</p>
                    </div>
                    <div id="pendingLeaves" class="space-y-3 mb-8"></div>
                    
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                    <div class="border-t pt-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            <p class="text-gray-600 text-sm">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        </div>
                        <div id="allLeaveRequests" class="space-y-3"></div>
                    </div>
                </div>
                
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
                <div id="employeesContent" class="p-6 hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                        <p class="text-gray-600 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
                    </div>
                    <div id="employeeList"></div>
                </div>
                
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏° -->
                <div id="calendarContent" class="p-6 hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold mb-2">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°</h3>
                        <p class="text-gray-600 text-sm">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                    </div>
                    <div id="hrCalendar"></div>
                </div>
                
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô Admin -->
                <div id="shiftsContent" class="p-6 hidden">
                    <div id="shiftManagement"></div>
                </div>
            </div>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f29f21360d45c0',t:'MTc1NTE5NzI1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
